<script>
// ============================================================================
// MODAL MANAGER
// ============================================================================
const ModalManager = {
  open: function(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
      modal.style.display = 'block';
    }
  },
  close: function(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
      modal.style.display = 'none';
      // Reset form if exists
      const form = modal.querySelector('form');
      if (form) {
        form.reset();
        // Reset hidden edit index fields
        const editIndex = modal.querySelector('[id$="-edit-index"]');
        if (editIndex) {
          editIndex.value = '';
        }
      }
    }
  }
};

// ============================================================================
// GLOBAL STATE
// ============================================================================

let currentView = 'dashboard';
let appData = {
  contasPagar: [],
  contasReceber: [],
  extratos: [],
  lancamentos: [],
  filiais: [],
  canais: [],
  contas: [],
  centrosCusto: []
};

// ============================================================================
// INITIALIZATION
// ============================================================================

document.addEventListener('DOMContentLoaded', function() {
  initializeApp();
});

function initializeApp() {
  // Setup navigation
  setupNavigation();

  // Load reference data
  loadReferenceData();

  // Load initial view
  navigateTo('dashboard');
}

// ============================================================================
// NAVIGATION
// ============================================================================

function setupNavigation() {
  const navItems = document.querySelectorAll('.nav-item');
  navItems.forEach(item => {
    item.addEventListener('click', function(e) {
      e.preventDefault();
      const view = this.getAttribute('data-view');
      navigateTo(view);
    });
  });
}

function navigateTo(view) {
  // Update active nav item
  document.querySelectorAll('.nav-item').forEach(item => {
    item.classList.remove('active');
  });
  document.querySelector(`[data-view="${view}"]`)?.classList.add('active');

  // Load view content
  currentView = view;
  loadView(view);
}

function loadView(view) {
  showLoading();

  google.script.run
    .withSuccessHandler(function(html) {
      document.getElementById('main-content').innerHTML = html;
      hideLoading();

      // Initialize view-specific logic
      switch(view) {
        case 'dashboard':
          loadDashboardData();
          break;
        case 'contas-pagar':
          loadContasPagarData();
          break;
        case 'contas-receber':
          loadContasReceberData();
          break;
        case 'conciliacao':
          loadConciliacaoData();
          break;
        case 'relatorios':
          loadRelatoriosData();
          break;
        case 'dre':
          loadDREData();
          break;
        case 'fluxo-caixa':
          loadFluxoCaixaData();
          break;
        case 'kpis':
          loadKPIsData();
          break;
        case 'configuracoes':
          loadConfiguracoesData();
          break;
      }
    })
    .withFailureHandler(handleError)
    .getViewHtml(view);
}

// ============================================================================
// REFERENCE DATA
// ============================================================================

function loadReferenceData() {
  google.script.run
    .withSuccessHandler(function(data) {
      if (data) {
        appData.filiais = data.filiais || [];
        appData.canais = data.canais || [];
        appData.contas = data.contas || [];
        appData.centrosCusto = data.centrosCusto || [];
        populateFilters();

        // Reload config tables if on config view
        if (currentView === 'configuracoes') {
          loadConfiguracoesData();
        }
      } else {
        console.error('getReferenceData retornou null');
        showToast('Erro ao carregar dados de refer√™ncia', 'error');
      }
    })
    .withFailureHandler(function(error) {
      console.error('Erro ao carregar dados de refer√™ncia:', error);
      handleError(error);
    })
    .getReferenceData();
}

function populateFilters() {
  // Populate filial filters
  const filiaisSelects = document.querySelectorAll('#filter-cp-filial, #filter-cr-filial');
  filiaisSelects.forEach(select => {
    select.innerHTML = '<option value="">Todas</option>';
    appData.filiais.forEach(filial => {
      select.innerHTML += `<option value="${filial.codigo}">${filial.nome}</option>`;
    });
  });
}

// ============================================================================
// DASHBOARD
// ============================================================================

function loadDashboardData() {
  google.script.run
    .withSuccessHandler(function(data) {
      // Update stats
      updateElement('stat-pagar-vencidas', formatCurrency(data.pagarVencidas.valor));
      updateElement('stat-pagar-vencidas-qtd', `${data.pagarVencidas.quantidade} contas`);
      updateElement('stat-pagar-proximas', formatCurrency(data.pagarProximas.valor));
      updateElement('stat-pagar-proximas-qtd', `${data.pagarProximas.quantidade} contas`);
      updateElement('stat-receber-hoje', formatCurrency(data.receberHoje.valor));
      updateElement('stat-receber-hoje-qtd', `${data.receberHoje.quantidade} contas`);
      updateElement('stat-conciliacao-pendentes', data.conciliacaoPendentes.quantidade);
      updateElement('stat-conciliacao-valor', formatCurrency(data.conciliacaoPendentes.valor));

      // Render recent transactions
      renderDashboardTransactions(data.recentTransactions);

      // Render alerts
      renderDashboardAlerts(data.alerts);
    })
    .withFailureHandler(handleError)
    .getDashboardData();
}

function renderDashboardTransactions(transactions) {
  const tbody = document.getElementById('dashboard-transactions');

  if (!transactions || transactions.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Nenhum lan√ßamento encontrado</td></tr>';
    return;
  }

  tbody.innerHTML = transactions.map(t => `
    <tr>
      <td>${formatDate(t.data)}</td>
      <td>${t.descricao}</td>
      <td><span class="badge ${t.tipo === 'RECEITA' ? 'badge-success' : 'badge-danger'}">${t.tipo}</span></td>
      <td class="${t.tipo === 'RECEITA' ? 'text-success' : 'text-danger'}">${formatCurrency(t.valor)}</td>
      <td><span class="badge badge-${getStatusClass(t.status)}">${t.status}</span></td>
      <td>
        <button class="btn btn-outline btn-sm" onclick="viewTransaction('${t.id}')">Ver</button>
      </td>
    </tr>
  `).join('');
}

function renderDashboardAlerts(alerts) {
  const container = document.getElementById('dashboard-alerts');

  if (!alerts || alerts.length === 0) {
    container.innerHTML = '<p class="text-muted">Nenhum alerta no momento</p>';
    return;
  }

  container.innerHTML = alerts.map(alert => `
    <div class="alert alert-${alert.type}" style="padding: 1rem; margin-bottom: 0.5rem; border-left: 4px solid; border-radius: 4px;">
      <strong>${alert.title}</strong>
      <p style="margin: 0.5rem 0 0 0;">${alert.message}</p>
    </div>
  `).join('');
}

function refreshDashboard() {
  loadDashboardData();
  showToast('Dashboard atualizado', 'success');
}

// ============================================================================
// CONTAS A PAGAR
// ============================================================================

function loadContasPagarData() {
  showLoading();

  google.script.run
    .withSuccessHandler(function(data) {
      hideLoading();
      appData.contasPagar = data.contas || [];

      // Update stats
      updateElement('cp-vencidas-valor', formatCurrency(data.stats.vencidas.valor));
      updateElement('cp-vencidas-qtd', `${data.stats.vencidas.quantidade} contas`);
      updateElement('cp-vencer-valor', formatCurrency(data.stats.vencer7.valor));
      updateElement('cp-vencer-qtd', `${data.stats.vencer7.quantidade} contas`);
      updateElement('cp-futuro-valor', formatCurrency(data.stats.vencer30.valor));
      updateElement('cp-futuro-qtd', `${data.stats.vencer30.quantidade} contas`);
      updateElement('cp-pagas-valor', formatCurrency(data.stats.pagas.valor));
      updateElement('cp-pagas-qtd', `${data.stats.pagas.quantidade} contas`);

      // Render table
      renderContasPagarTable(data.contas);
    })
    .withFailureHandler(handleError)
    .getContasPagar();
}

function renderContasPagarTable(contas) {
  const tbody = document.getElementById('table-contas-pagar');
  updateElement('cp-total-registros', contas.length);

  if (!contas || contas.length === 0) {
    tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">Nenhuma conta encontrada</td></tr>';
    return;
  }

  tbody.innerHTML = contas.map(c => `
    <tr>
      <td><input type="checkbox" class="select-cp" value="${c.id}"></td>
      <td>${c.id}</td>
      <td>${formatDate(c.vencimento)}</td>
      <td>${c.fornecedor}</td>
      <td>${c.descricao}</td>
      <td class="text-danger">${formatCurrency(c.valor)}</td>
      <td><span class="badge badge-${getStatusClass(c.status)}">${c.status}</span></td>
      <td>${c.filial}</td>
      <td>
        <button class="btn btn-sm btn-outline" onclick="editContaPagar('${c.id}')">‚úèÔ∏è</button>
        <button class="btn btn-sm btn-success" onclick="pagarConta('${c.id}')" ${c.status !== 'PENDENTE' ? 'disabled' : ''}>‚úì</button>
      </td>
    </tr>
  `).join('');

  // Setup checkbox listeners
  document.querySelectorAll('.select-cp').forEach(cb => {
    cb.addEventListener('change', updateBatchButtons);
  });
}

function filterContasPagar() {
  const status = document.getElementById('filter-cp-status').value;
  const filial = document.getElementById('filter-cp-filial').value;
  const dataInicio = document.getElementById('filter-cp-data-inicio').value;
  const dataFim = document.getElementById('filter-cp-data-fim').value;

  let filtered = appData.contasPagar;

  if (status) filtered = filtered.filter(c => c.status === status);
  if (filial) filtered = filtered.filter(c => c.filial === filial);
  if (dataInicio) filtered = filtered.filter(c => c.vencimento >= dataInicio);
  if (dataFim) filtered = filtered.filter(c => c.vencimento <= dataFim);

  renderContasPagarTable(filtered);
}

function clearFilters(type) {
  if (type === 'pagar') {
    document.getElementById('filter-cp-status').value = '';
    document.getElementById('filter-cp-filial').value = '';
    document.getElementById('filter-cp-data-inicio').value = '';
    document.getElementById('filter-cp-data-fim').value = '';
    filterContasPagar();
  } else if (type === 'receber') {
    document.getElementById('filter-cr-status').value = '';
    document.getElementById('filter-cr-cliente').value = '';
    document.getElementById('filter-cr-data-inicio').value = '';
    document.getElementById('filter-cr-data-fim').value = '';
    filterContasReceber();
  }
}

function pagarConta(id) {
  if (!confirm('Confirmar pagamento desta conta?')) return;

  showLoading();
  google.script.run
    .withSuccessHandler(function() {
      hideLoading();
      showToast('Conta paga com sucesso', 'success');
      loadContasPagarData();
    })
    .withFailureHandler(handleError)
    .pagarConta(id);
}

function pagarEmLote() {
  const selected = getSelectedIds('cp');
  if (selected.length === 0) {
    showToast('Selecione ao menos uma conta', 'warning');
    return;
  }

  if (!confirm(`Confirmar pagamento de ${selected.length} contas?`)) return;

  showLoading();
  google.script.run
    .withSuccessHandler(function() {
      hideLoading();
      showToast(`${selected.length} contas pagas com sucesso`, 'success');
      loadContasPagarData();
    })
    .withFailureHandler(handleError)
    .pagarContasEmLote(selected);
}

function cancelarEmLote() {
  const selected = getSelectedIds('cp');
  if (selected.length === 0) {
    showToast('Selecione ao menos uma conta', 'warning');
    return;
  }

  if (!confirm(`Confirmar cancelamento de ${selected.length} contas?`)) return;

  showLoading();
  // TODO: Implement backend cancelarContasEmLote
  hideLoading();
  showToast('Funcionalidade em desenvolvimento', 'info');
}

// ============================================================================
// CONTAS A RECEBER
// ============================================================================

function loadContasReceberData() {
  showLoading();

  google.script.run
    .withSuccessHandler(function(data) {
      hideLoading();
      appData.contasReceber = data.contas || [];

      // Update stats
      updateElement('cr-vencidas-valor', formatCurrency(data.stats.vencidas.valor));
      updateElement('cr-vencidas-qtd', `${data.stats.vencidas.quantidade} contas`);
      updateElement('cr-receber-valor', formatCurrency(data.stats.receber7.valor));
      updateElement('cr-receber-qtd', `${data.stats.receber7.quantidade} contas`);
      updateElement('cr-futuro-valor', formatCurrency(data.stats.receber30.valor));
      updateElement('cr-futuro-qtd', `${data.stats.receber30.quantidade} contas`);
      updateElement('cr-recebidas-valor', formatCurrency(data.stats.recebidas.valor));
      updateElement('cr-recebidas-qtd', `${data.stats.recebidas.quantidade} contas`);

      // Render table
      renderContasReceberTable(data.contas);
    })
    .withFailureHandler(handleError)
    .getContasReceber();
}

function renderContasReceberTable(contas) {
  const tbody = document.getElementById('table-contas-receber');
  updateElement('cr-total-registros', contas.length);

  if (!contas || contas.length === 0) {
    tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">Nenhuma conta encontrada</td></tr>';
    return;
  }

  tbody.innerHTML = contas.map(c => `
    <tr>
      <td><input type="checkbox" class="select-cr" value="${c.id}"></td>
      <td>${c.id}</td>
      <td>${formatDate(c.vencimento)}</td>
      <td>${c.cliente}</td>
      <td>${c.descricao}</td>
      <td class="text-success">${formatCurrency(c.valor)}</td>
      <td><span class="badge badge-${getStatusClass(c.status)}">${c.status}</span></td>
      <td>${c.canal}</td>
      <td>
        <button class="btn btn-sm btn-outline" onclick="editContaReceber('${c.id}')">‚úèÔ∏è</button>
        <button class="btn btn-sm btn-success" onclick="receberConta('${c.id}')" ${c.status !== 'PENDENTE' ? 'disabled' : ''}>‚úì</button>
      </td>
    </tr>
  `).join('');

  // Setup checkbox listeners
  document.querySelectorAll('.select-cr').forEach(cb => {
    cb.addEventListener('change', updateBatchButtonsReceber);
  });
}

function filterContasReceber() {
  const status = document.getElementById('filter-cr-status').value;
  const cliente = document.getElementById('filter-cr-cliente').value.toLowerCase();
  const dataInicio = document.getElementById('filter-cr-data-inicio').value;
  const dataFim = document.getElementById('filter-cr-data-fim').value;

  let filtered = appData.contasReceber;

  if (status) filtered = filtered.filter(c => c.status === status);
  if (cliente) filtered = filtered.filter(c => c.cliente.toLowerCase().includes(cliente));
  if (dataInicio) filtered = filtered.filter(c => c.vencimento >= dataInicio);
  if (dataFim) filtered = filtered.filter(c => c.vencimento <= dataFim);

  renderContasReceberTable(filtered);
}

function receberConta(id) {
  if (!confirm('Confirmar recebimento desta conta?')) return;

  showLoading();
  google.script.run
    .withSuccessHandler(function() {
      hideLoading();
      showToast('Conta recebida com sucesso', 'success');
      loadContasReceberData();
    })
    .withFailureHandler(handleError)
    .receberConta(id);
}

function receberEmLote() {
  const selected = getSelectedIds('cr');
  if (selected.length === 0) {
    showToast('Selecione ao menos uma conta', 'warning');
    return;
  }

  if (!confirm(`Confirmar recebimento de ${selected.length} contas?`)) return;

  showLoading();

  // Receber cada conta individualmente
  let count = 0;
  let errors = 0;

  selected.forEach((id, index) => {
    google.script.run
      .withSuccessHandler(function() {
        count++;
        if (count + errors === selected.length) {
          hideLoading();
          if (errors === 0) {
            showToast(`${count} contas recebidas com sucesso`, 'success');
          } else {
            showToast(`${count} contas recebidas, ${errors} com erro`, 'warning');
          }
          loadContasReceberData();
        }
      })
      .withFailureHandler(function() {
        errors++;
        if (count + errors === selected.length) {
          hideLoading();
          showToast(`${count} contas recebidas, ${errors} com erro`, 'warning');
          loadContasReceberData();
        }
      })
      .receberConta(id);
  });
}

function cancelarReceberEmLote() {
  const selected = getSelectedIds('cr');
  if (selected.length === 0) {
    showToast('Selecione ao menos uma conta', 'warning');
    return;
  }

  if (!confirm(`Confirmar cancelamento de ${selected.length} contas?`)) return;

  showLoading();
  // TODO: Implement backend cancelarContasReceberEmLote
  hideLoading();
  showToast('Funcionalidade em desenvolvimento', 'info');
}

// ============================================================================
// CONCILIA√á√ÉO
// ============================================================================

function loadConciliacaoData() {
  showLoading();

  google.script.run
    .withSuccessHandler(function(data) {
      hideLoading();
      appData.extratos = data.extratos || [];
      appData.lancamentos = data.lancamentos || [];

      // Update stats
      updateElement('conc-extratos-pendentes', data.stats.extratosPendentes);
      updateElement('conc-extratos-valor', formatCurrency(data.stats.extratosValor));
      updateElement('conc-lancamentos-pendentes', data.stats.lancamentosPendentes);
      updateElement('conc-lancamentos-valor', formatCurrency(data.stats.lancamentosValor));
      updateElement('conc-hoje', data.stats.conciliadosHoje);
      updateElement('conc-hoje-valor', formatCurrency(data.stats.conciliadosHojeValor));
      updateElement('conc-taxa', `${data.stats.taxaConciliacao}%`);

      // Render lists
      renderExtratosList(data.extratos);
      renderLancamentosList(data.lancamentos);
      renderHistoricoConciliacao(data.historico);
    })
    .withFailureHandler(handleError)
    .getConciliacaoData();
}

function renderExtratosList(extratos) {
  const container = document.getElementById('extratos-list');

  if (!extratos || extratos.length === 0) {
    container.innerHTML = '<p class="text-muted text-center">Nenhum extrato pendente</p>';
    return;
  }

  container.innerHTML = extratos.map(e => `
    <div class="extrato-item" data-id="${e.id}" onclick="selectExtrato('${e.id}')">
      <div class="item-header">
        <span class="item-date">${formatDate(e.data)}</span>
        <span class="item-value ${e.valor >= 0 ? 'positive' : 'negative'}">${formatCurrency(e.valor)}</span>
      </div>
      <div class="item-description">${e.descricao}</div>
      <div class="item-meta">
        <span>üè¶ ${e.banco}</span>
        <span>üìÑ ${e.id}</span>
      </div>
    </div>
  `).join('');
}

function renderLancamentosList(lancamentos) {
  const container = document.getElementById('lancamentos-list');

  if (!lancamentos || lancamentos.length === 0) {
    container.innerHTML = '<p class="text-muted text-center">Nenhum lan√ßamento pendente</p>';
    return;
  }

  container.innerHTML = lancamentos.map(l => `
    <div class="lancamento-item" data-id="${l.id}" onclick="selectLancamento('${l.id}')">
      <div class="item-header">
        <span class="item-date">${formatDate(l.data)}</span>
        <span class="item-value ${l.tipo === 'RECEITA' ? 'positive' : 'negative'}">${formatCurrency(l.valor)}</span>
      </div>
      <div class="item-description">${l.descricao}</div>
      <div class="item-meta">
        <span>üìä ${l.tipo}</span>
        <span>üìÑ ${l.id}</span>
      </div>
    </div>
  `).join('');
}

let selectedExtrato = null;
let selectedLancamento = null;

function selectExtrato(id) {
  document.querySelectorAll('.extrato-item').forEach(item => item.classList.remove('selected'));
  document.querySelector(`.extrato-item[data-id="${id}"]`).classList.add('selected');
  selectedExtrato = id;
  checkConciliacaoPossivel();
}

function selectLancamento(id) {
  document.querySelectorAll('.lancamento-item').forEach(item => item.classList.remove('selected'));
  document.querySelector(`.lancamento-item[data-id="${id}"]`).classList.add('selected');
  selectedLancamento = id;
  checkConciliacaoPossivel();
}

function checkConciliacaoPossivel() {
  if (selectedExtrato && selectedLancamento) {
    if (confirm('Deseja conciliar os itens selecionados?')) {
      conciliar(selectedExtrato, selectedLancamento);
    }
  }
}

function conciliar(extratoId, lancamentoId) {
  showLoading();

  google.script.run
    .withSuccessHandler(function() {
      hideLoading();
      showToast('Concilia√ß√£o realizada com sucesso', 'success');
      selectedExtrato = null;
      selectedLancamento = null;
      loadConciliacaoData();
    })
    .withFailureHandler(handleError)
    .conciliarItens(extratoId, lancamentoId);
}

function conciliarAutomatico() {
  if (!confirm('Executar concilia√ß√£o autom√°tica? Isso pode levar alguns segundos.')) return;

  showLoading('Processando concilia√ß√£o autom√°tica...');

  google.script.run
    .withSuccessHandler(function(result) {
      hideLoading();
      showToast(`${result.conciliados} itens conciliados automaticamente`, 'success');
      loadConciliacaoData();
    })
    .withFailureHandler(handleError)
    .conciliarAutomatico();
}

function renderHistoricoConciliacao(historico) {
  const tbody = document.getElementById('table-historico-conciliacao');

  if (!historico || historico.length === 0) {
    tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">Nenhuma concilia√ß√£o realizada</td></tr>';
    return;
  }

  tbody.innerHTML = historico.slice(0, 50).map(h => `
    <tr>
      <td>${formatDate(h.dataConciliacao)}</td>
      <td>${h.extratoId}</td>
      <td>${h.lancamentoId}</td>
      <td>${h.descricao}</td>
      <td>${formatCurrency(h.valor)}</td>
      <td>${h.banco}</td>
      <td>${h.usuario || 'Sistema'}</td>
      <td>
        <button class="btn btn-sm btn-danger" onclick="desfazerConciliacao('${h.extratoId}', '${h.lancamentoId}')">‚Ü©Ô∏è</button>
      </td>
    </tr>
  `).join('');
}

function desfazerConciliacao(extratoId, lancamentoId) {
  if (!confirm('Desfazer esta concilia√ß√£o?')) return;

  showLoading();
  // TODO: Implement backend desfazerConciliacao
  hideLoading();
  showToast('Funcionalidade em desenvolvimento', 'info');
}

// ============================================================================
// RELAT√ìRIOS
// ============================================================================

function loadRelatoriosData() {
  // Populate filial filter in relat√≥rios if needed
  populateFilters();
}

// ============================================================================
// DRE
// ============================================================================

function loadDREData() {
  // Populate filial filter
  const selectFilial = document.getElementById('dre-filial');
  if (selectFilial && appData.filiais.length > 0) {
    selectFilial.innerHTML = '<option value="">Consolidado</option>';
    appData.filiais.forEach(filial => {
      selectFilial.innerHTML += `<option value="${filial.codigo}">${filial.nome}</option>`;
    });
  }

  // Auto-load DRE for current month
  setTimeout(() => carregarDRE(), 300);
}

function carregarDRE() {
  const mes = parseInt(document.getElementById('dre-mes').value);
  const ano = parseInt(document.getElementById('dre-ano').value);
  const filial = document.getElementById('dre-filial').value;

  showLoading('Calculando DRE...');

  google.script.run
    .withSuccessHandler(function(dre) {
      hideLoading();
      renderDRE(dre);
    })
    .withFailureHandler(handleError)
    .getDREMensal(mes, ano, filial || undefined);
}

function renderDRE(dre) {
  // Update title
  document.getElementById('dre-titulo').textContent =
    `DRE - ${dre.periodo.mesNome}/${dre.periodo.ano} - ${dre.periodo.filial}`;

  // Update KPIs
  updateElement('dre-receita-liquida', formatCurrency(dre.valores.receitaLiquida));
  updateElement('dre-receita-transacoes', `${dre.transacoes.totalReceitas} receitas`);

  updateElement('dre-margem-bruta', formatCurrency(dre.valores.margemBruta));
  updateElement('dre-margem-bruta-perc', `${dre.percentuais.margemBruta.toFixed(1)}% - ${dre.classificacao.margemBruta}`);

  updateElement('dre-ebitda', formatCurrency(dre.valores.ebitda));
  updateElement('dre-ebitda-perc', `${dre.percentuais.ebitda.toFixed(1)}% - ${dre.classificacao.ebitda}`);

  updateElement('dre-lucro-liquido', formatCurrency(dre.valores.lucroLiquido));
  updateElement('dre-lucro-perc', `${dre.percentuais.lucroLiquido.toFixed(1)}% - ${dre.classificacao.lucroLiquido}`);

  // Update lucro card color
  const lucroCard = document.getElementById('dre-lucro-card');
  lucroCard.className = 'stat-card';
  if (dre.valores.lucroLiquido > 0) lucroCard.classList.add('success');
  else if (dre.valores.lucroLiquido < 0) lucroCard.classList.add('danger');

  // Render DRE table
  renderDRETable(dre);

  // Render despesas por categoria
  renderDespesasCategorias(dre);
}

function renderDRETable(dre) {
  const tbody = document.getElementById('table-dre');
  const v = dre.valores;
  const p = dre.percentuais;
  const c = dre.classificacao;

  const calcPerc = (valor) => v.receitaLiquida > 0 ? (valor / v.receitaLiquida * 100).toFixed(1) : '0.0';

  tbody.innerHTML = `
    <!-- RECEITA -->
    <tr style="background: #f8f9fa; font-weight: 600;">
      <td>RECEITA BRUTA</td>
      <td class="text-right">${formatCurrency(v.receitaBruta)}</td>
      <td class="text-right">${calcPerc(v.receitaBruta)}%</td>
      <td></td>
    </tr>
    <tr>
      <td style="padding-left: 2rem;">(-) Dedu√ß√µes</td>
      <td class="text-right text-danger">(${formatCurrency(v.deducoes)})</td>
      <td class="text-right">${calcPerc(v.deducoes)}%</td>
      <td></td>
    </tr>
    <tr style="background: #e8f7fd; font-weight: 600;">
      <td>= RECEITA L√çQUIDA</td>
      <td class="text-right text-primary">${formatCurrency(v.receitaLiquida)}</td>
      <td class="text-right">100.0%</td>
      <td></td>
    </tr>

    <!-- CUSTOS -->
    <tr style="height: 1rem;"><td colspan="4"></td></tr>
    <tr>
      <td>(-) Custo das Mercadorias/Servi√ßos</td>
      <td class="text-right text-danger">(${formatCurrency(v.custos)})</td>
      <td class="text-right">${calcPerc(v.custos)}%</td>
      <td></td>
    </tr>
    <tr style="background: #d4edda; font-weight: 600;">
      <td>= MARGEM BRUTA</td>
      <td class="text-right text-success">${formatCurrency(v.margemBruta)}</td>
      <td class="text-right">${p.margemBruta.toFixed(1)}%</td>
      <td class="text-center"><span class="badge badge-${getClassificacaoBadge(c.margemBruta)}">${c.margemBruta}</span></td>
    </tr>

    <!-- DESPESAS OPERACIONAIS -->
    <tr style="height: 1rem;"><td colspan="4"></td></tr>
    <tr style="background: #f8f9fa; font-weight: 600;">
      <td>(-) DESPESAS OPERACIONAIS</td>
      <td class="text-right text-danger">(${formatCurrency(v.despesasOperacionais.total)})</td>
      <td class="text-right">${calcPerc(v.despesasOperacionais.total)}%</td>
      <td></td>
    </tr>
    <tr>
      <td style="padding-left: 2rem;">Pessoal</td>
      <td class="text-right">(${formatCurrency(v.despesasOperacionais.pessoal)})</td>
      <td class="text-right">${calcPerc(v.despesasOperacionais.pessoal)}%</td>
      <td></td>
    </tr>
    <tr>
      <td style="padding-left: 2rem;">Marketing</td>
      <td class="text-right">(${formatCurrency(v.despesasOperacionais.marketing)})</td>
      <td class="text-right">${calcPerc(v.despesasOperacionais.marketing)}%</td>
      <td></td>
    </tr>
    <tr>
      <td style="padding-left: 2rem;">Administrativas</td>
      <td class="text-right">(${formatCurrency(v.despesasOperacionais.administrativas)})</td>
      <td class="text-right">${calcPerc(v.despesasOperacionais.administrativas)}%</td>
      <td></td>
    </tr>

    <!-- EBITDA -->
    <tr style="background: #fff3cd; font-weight: 600;">
      <td>= EBITDA</td>
      <td class="text-right" style="color: ${v.ebitda >= 0 ? '#008060' : '#D72C0D'}">${formatCurrency(v.ebitda)}</td>
      <td class="text-right">${p.ebitda.toFixed(1)}%</td>
      <td class="text-center"><span class="badge badge-${getClassificacaoBadge(c.ebitda)}">${c.ebitda}</span></td>
    </tr>

    <!-- RESULTADO FINANCEIRO -->
    <tr style="height: 1rem;"><td colspan="4"></td></tr>
    <tr>
      <td>(-) Resultado Financeiro</td>
      <td class="text-right" style="color: ${v.resultadoFinanceiro >= 0 ? '#008060' : '#D72C0D'}">${formatCurrency(v.resultadoFinanceiro)}</td>
      <td class="text-right">${calcPerc(v.resultadoFinanceiro)}%</td>
      <td></td>
    </tr>

    <!-- LUCRO L√çQUIDO -->
    <tr style="background: ${v.lucroLiquido >= 0 ? '#d4edda' : '#f8d7da'}; font-weight: 700; font-size: 1.1rem;">
      <td>= LUCRO L√çQUIDO</td>
      <td class="text-right" style="color: ${v.lucroLiquido >= 0 ? '#008060' : '#D72C0D'}">${formatCurrency(v.lucroLiquido)}</td>
      <td class="text-right">${p.lucroLiquido.toFixed(1)}%</td>
      <td class="text-center"><span class="badge badge-${getClassificacaoBadge(c.lucroLiquido)}">${c.lucroLiquido}</span></td>
    </tr>
  `;
}

function renderDespesasCategorias(dre) {
  const tbody = document.getElementById('table-desp-categorias');
  const v = dre.valores;
  const calcPerc = (valor) => v.receitaLiquida > 0 ? (valor / v.receitaLiquida * 100).toFixed(1) : '0.0';

  tbody.innerHTML = `
    <tr>
      <td>üíº Pessoal</td>
      <td class="text-right">${formatCurrency(v.despesasOperacionais.pessoal)}</td>
      <td class="text-right">${calcPerc(v.despesasOperacionais.pessoal)}%</td>
    </tr>
    <tr>
      <td>üì¢ Marketing</td>
      <td class="text-right">${formatCurrency(v.despesasOperacionais.marketing)}</td>
      <td class="text-right">${calcPerc(v.despesasOperacionais.marketing)}%</td>
    </tr>
    <tr>
      <td>üè¢ Administrativas</td>
      <td class="text-right">${formatCurrency(v.despesasOperacionais.administrativas)}</td>
      <td class="text-right">${calcPerc(v.despesasOperacionais.administrativas)}%</td>
    </tr>
    <tr style="background: #f8f9fa; font-weight: 600;">
      <td>TOTAL DESPESAS OPERACIONAIS</td>
      <td class="text-right">${formatCurrency(v.despesasOperacionais.total)}</td>
      <td class="text-right">${calcPerc(v.despesasOperacionais.total)}%</td>
    </tr>
  `;
}

function getClassificacaoBadge(classificacao) {
  const map = {
    'Sensacional': 'success',
    'Excelente': 'success',
    'Bom': 'info',
    'Ruim': 'warning',
    'P√©ssimo': 'danger'
  };
  return map[classificacao] || 'secondary';
}

// ============================================================================
// FLUXO DE CAIXA
// ============================================================================

function loadFluxoCaixaData() {
  // Populate filial filter
  const selectFilial = document.getElementById('fc-filial');
  if (selectFilial && appData.filiais.length > 0) {
    selectFilial.innerHTML = '<option value="">Consolidado</option>';
    appData.filiais.forEach(filial => {
      selectFilial.innerHTML += `<option value="${filial.codigo}">${filial.nome}</option>`;
    });
  }

  // Auto-load FC for current month
  setTimeout(() => carregarFluxoCaixa(), 300);
}

function carregarFluxoCaixa() {
  const mes = parseInt(document.getElementById('fc-mes').value);
  const ano = parseInt(document.getElementById('fc-ano').value);
  const filial = document.getElementById('fc-filial').value;

  showLoading('Calculando Fluxo de Caixa...');

  google.script.run
    .withSuccessHandler(function(fc) {
      hideLoading();
      renderFluxoCaixa(fc);
    })
    .withFailureHandler(handleError)
    .getFluxoCaixaMensal(mes, ano, filial || undefined);
}

function renderFluxoCaixa(fc) {
  // Update title
  document.getElementById('fc-titulo').textContent =
    `Fluxo de Caixa - ${fc.periodo.mesNome}/${fc.periodo.ano} - ${fc.periodo.filial}`;

  // Update KPIs
  updateElement('fc-saldo-inicial', formatCurrency(fc.valores.saldoInicial));
  updateElement('fc-data-inicial', `In√≠cio do per√≠odo`);

  updateElement('fc-total-entradas', formatCurrency(fc.valores.totalEntradas));
  updateElement('fc-qtd-entradas', `${fc.transacoes.qtdEntradas} transa√ß√µes`);

  updateElement('fc-total-saidas', formatCurrency(fc.valores.totalSaidas));
  updateElement('fc-qtd-saidas', `${fc.transacoes.qtdSaidas} transa√ß√µes`);

  updateElement('fc-saldo-final', formatCurrency(fc.valores.saldoFinal));
  updateElement('fc-variacao', `${fc.valores.variacao > 0 ? '+' : ''}${fc.valores.variacao.toFixed(1)}%`);

  // Update saldo card color
  const saldoCard = document.getElementById('fc-saldo-card');
  saldoCard.className = 'stat-card';
  if (fc.valores.saldoFinal > 0) saldoCard.classList.add('success');
  else if (fc.valores.saldoFinal < 0) saldoCard.classList.add('danger');

  // Render FC table
  renderFluxoCaixaTable(fc);

  // Render categorias
  renderEntradasCategorias(fc);
  renderSaidasCategorias(fc);
}

function renderFluxoCaixaTable(fc) {
  const tbody = document.getElementById('table-fluxo-caixa');
  const v = fc.valores;

  const total = v.totalEntradas + v.totalSaidas;
  const calcPerc = (valor) => total > 0 ? (Math.abs(valor) / total * 100).toFixed(1) : '0.0';

  tbody.innerHTML = `
    <!-- SALDO INICIAL -->
    <tr style="background: #f8f9fa; font-weight: 600;">
      <td>SALDO INICIAL</td>
      <td class="text-right">${formatCurrency(v.saldoInicial)}</td>
      <td class="text-right">-</td>
    </tr>

    <!-- ENTRADAS -->
    <tr style="height: 1rem;"><td colspan="3"></td></tr>
    <tr style="background: #d4edda; font-weight: 600;">
      <td>(+) ENTRADAS</td>
      <td class="text-right text-success">${formatCurrency(v.totalEntradas)}</td>
      <td class="text-right">${calcPerc(v.totalEntradas)}%</td>
    </tr>
    <tr>
      <td style="padding-left: 2rem;">Transa√ß√µes: ${fc.transacoes.qtdEntradas}</td>
      <td colspan="2"></td>
    </tr>

    <!-- SA√çDAS -->
    <tr style="height: 1rem;"><td colspan="3"></td></tr>
    <tr style="background: #f8d7da; font-weight: 600;">
      <td>(-) SA√çDAS</td>
      <td class="text-right text-danger">(${formatCurrency(v.totalSaidas)})</td>
      <td class="text-right">${calcPerc(v.totalSaidas)}%</td>
    </tr>
    <tr>
      <td style="padding-left: 2rem;">Transa√ß√µes: ${fc.transacoes.qtdSaidas}</td>
      <td colspan="2"></td>
    </tr>

    <!-- SALDO FINAL -->
    <tr style="height: 1rem;"><td colspan="3"></td></tr>
    <tr style="background: ${v.saldoFinal >= 0 ? '#d4edda' : '#f8d7da'}; font-weight: 700; font-size: 1.1rem;">
      <td>= SALDO FINAL</td>
      <td class="text-right" style="color: ${v.saldoFinal >= 0 ? '#008060' : '#D72C0D'}">${formatCurrency(v.saldoFinal)}</td>
      <td class="text-right">${v.variacao > 0 ? '+' : ''}${v.variacao.toFixed(1)}%</td>
    </tr>
  `;
}

function renderEntradasCategorias(fc) {
  const tbody = document.getElementById('table-entradas-categorias');
  const entradas = fc.entradas || [];
  const total = fc.valores.totalEntradas;

  if (entradas.length === 0) {
    tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">Nenhuma entrada registrada</td></tr>';
    return;
  }

  tbody.innerHTML = entradas.map(e => `
    <tr>
      <td>${e.categoria}</td>
      <td class="text-right">${formatCurrency(e.valor)}</td>
      <td class="text-right">${total > 0 ? (e.valor / total * 100).toFixed(1) : '0.0'}%</td>
    </tr>
  `).join('') + `
    <tr style="background: #f8f9fa; font-weight: 600;">
      <td>TOTAL</td>
      <td class="text-right">${formatCurrency(total)}</td>
      <td class="text-right">100.0%</td>
    </tr>
  `;
}

function renderSaidasCategorias(fc) {
  const tbody = document.getElementById('table-saidas-categorias');
  const saidas = fc.saidas || [];
  const total = fc.valores.totalSaidas;

  if (saidas.length === 0) {
    tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">Nenhuma sa√≠da registrada</td></tr>';
    return;
  }

  tbody.innerHTML = saidas.map(s => `
    <tr>
      <td>${s.categoria}</td>
      <td class="text-right">${formatCurrency(s.valor)}</td>
      <td class="text-right">${total > 0 ? (s.valor / total * 100).toFixed(1) : '0.0'}%</td>
    </tr>
  `).join('') + `
    <tr style="background: #f8f9fa; font-weight: 600;">
      <td>TOTAL</td>
      <td class="text-right">${formatCurrency(total)}</td>
      <td class="text-right">100.0%</td>
    </tr>
  `;
}

// ============================================================================
// GENERAL FUNCTIONS
// ============================================================================

function viewTransaction(id) {
  showToast('Visualiza√ß√£o de detalhes em desenvolvimento', 'info');
  // TODO: Open modal with transaction details
}

// ============================================================================
// KPIs
// ============================================================================

function loadKPIsData() {
  // Populate filial filter
  const selectFilial = document.getElementById('kpi-filial');
  if (selectFilial && appData.filiais.length > 0) {
    selectFilial.innerHTML = '<option value="">Consolidado</option>';
    appData.filiais.forEach(filial => {
      selectFilial.innerHTML += `<option value="${filial.codigo}">${filial.nome}</option>`;
    });
  }

  // Auto-load KPIs for current month
  setTimeout(() => carregarKPIs(), 300);
}

function carregarKPIs() {
  const mes = parseInt(document.getElementById('kpi-mes').value);
  const ano = parseInt(document.getElementById('kpi-ano').value);
  const filial = document.getElementById('kpi-filial').value;

  showLoading('Calculando KPIs...');

  google.script.run
    .withSuccessHandler(function(kpis) {
      hideLoading();
      renderKPIs(kpis);
    })
    .withFailureHandler(handleError)
    .getKPIsMensal(mes, ano, filial || undefined);
}

function renderKPIs(kpis) {
  // Update title
  document.getElementById('kpi-titulo').textContent =
    `KPIs - ${kpis.periodo.mesNome}/${kpis.periodo.ano} - ${kpis.periodo.filial}`;

  // Rentabilidade
  updateElement('kpi-margem-bruta', `${kpis.rentabilidade.margemBruta.valor.toFixed(1)}%`);
  updateElement('kpi-margem-bruta-class', kpis.rentabilidade.margemBruta.classificacao);

  updateElement('kpi-margem-ebitda', `${kpis.rentabilidade.margemEbitda.valor.toFixed(1)}%`);
  updateElement('kpi-margem-ebitda-class', kpis.rentabilidade.margemEbitda.classificacao);

  updateElement('kpi-margem-liquida', `${kpis.rentabilidade.margemLiquida.valor.toFixed(1)}%`);
  updateElement('kpi-margem-liquida-class', kpis.rentabilidade.margemLiquida.classificacao);

  updateElement('kpi-roi', `${kpis.rentabilidade.roi.valor.toFixed(1)}%`);
  updateElement('kpi-roi-desc', kpis.rentabilidade.roi.descricao);

  // Liquidez
  updateElement('kpi-liquidez-corrente', kpis.liquidez.liquidezCorrente.valor.toFixed(2));
  updateElement('kpi-liquidez-corrente-class', kpis.liquidez.liquidezCorrente.classificacao);

  updateElement('kpi-saldo-caixa', formatCurrency(kpis.liquidez.saldoCaixa.valor));
  updateElement('kpi-saldo-caixa-desc', kpis.liquidez.saldoCaixa.descricao);

  updateElement('kpi-burn-rate', formatCurrency(kpis.liquidez.burnRate.valor));
  updateElement('kpi-burn-rate-desc', kpis.liquidez.burnRate.descricao);

  updateElement('kpi-runway', `${kpis.liquidez.runway.valor.toFixed(0)} meses`);
  updateElement('kpi-runway-desc', kpis.liquidez.runway.descricao);

  // Crescimento
  updateElement('kpi-crescimento-receita', `${kpis.crescimento.crescimentoReceita.valor > 0 ? '+' : ''}${kpis.crescimento.crescimentoReceita.valor.toFixed(1)}%`);
  updateElement('kpi-crescimento-receita-desc', `vs ${formatCurrency(kpis.crescimento.crescimentoReceita.mesAnterior)}`);

  updateElement('kpi-ticket-medio', formatCurrency(kpis.crescimento.ticketMedio.valor));
  updateElement('kpi-ticket-medio-desc', `${kpis.crescimento.ticketMedio.qtdTransacoes} transa√ß√µes`);

  updateElement('kpi-inadimplencia', `${kpis.crescimento.inadimplencia.valor.toFixed(1)}%`);
  updateElement('kpi-inadimplencia-class', kpis.crescimento.inadimplencia.classificacao);

  updateElement('kpi-pmr', `${Math.abs(kpis.crescimento.prazoMedioRecebimento.valor).toFixed(0)} dias`);
  updateElement('kpi-pmr-desc', kpis.crescimento.prazoMedioRecebimento.descricao);

  // Operacional
  updateElement('kpi-cac', formatCurrency(kpis.operacional.cac.valor));
  updateElement('kpi-cac-desc', kpis.operacional.cac.descricao);

  updateElement('kpi-desp-op-receita', `${kpis.operacional.despOperacionaisReceita.valor.toFixed(1)}%`);
  updateElement('kpi-desp-op-receita-class', kpis.operacional.despOperacionaisReceita.classificacao);

  updateElement('kpi-break-even', formatCurrency(kpis.operacional.breakEven.valor));
  updateElement('kpi-break-even-desc', kpis.operacional.breakEven.descricao);

  updateElement('kpi-pmp', `${Math.abs(kpis.operacional.prazoMedioPagamento.valor).toFixed(0)} dias`);
  updateElement('kpi-pmp-desc', kpis.operacional.prazoMedioPagamento.descricao);

  // Render tabela detalhada
  renderKPIsDetalhado(kpis);
}

function renderKPIsDetalhado(kpis) {
  const tbody = document.getElementById('table-kpis-detalhado');

  const indicadores = [
    {
      nome: 'Margem Bruta',
      atual: `${kpis.rentabilidade.margemBruta.valor.toFixed(1)}%`,
      anterior: `${kpis.comparativo.mesAnterior.margemBruta.toFixed(1)}%`,
      variacao: kpis.rentabilidade.margemBruta.valor - kpis.comparativo.mesAnterior.margemBruta,
      status: kpis.rentabilidade.margemBruta.classificacao
    },
    {
      nome: 'Margem L√≠quida',
      atual: `${kpis.rentabilidade.margemLiquida.valor.toFixed(1)}%`,
      anterior: `${kpis.comparativo.mesAnterior.margemLiquida.toFixed(1)}%`,
      variacao: kpis.rentabilidade.margemLiquida.valor - kpis.comparativo.mesAnterior.margemLiquida,
      status: kpis.rentabilidade.margemLiquida.classificacao
    },
    {
      nome: 'Liquidez Corrente',
      atual: kpis.liquidez.liquidezCorrente.valor.toFixed(2),
      anterior: '-',
      variacao: 0,
      status: kpis.liquidez.liquidezCorrente.classificacao
    },
    {
      nome: 'Taxa de Inadimpl√™ncia',
      atual: `${kpis.crescimento.inadimplencia.valor.toFixed(1)}%`,
      anterior: '-',
      variacao: 0,
      status: kpis.crescimento.inadimplencia.classificacao
    }
  ];

  tbody.innerHTML = indicadores.map(ind => `
    <tr>
      <td>${ind.nome}</td>
      <td class="text-right">${ind.atual}</td>
      <td class="text-right">${ind.anterior}</td>
      <td class="text-right" style="color: ${ind.variacao > 0 ? '#008060' : ind.variacao < 0 ? '#D72C0D' : '#666'}">
        ${ind.variacao !== 0 ? (ind.variacao > 0 ? '+' : '') + ind.variacao.toFixed(1) + ' p.p.' : '-'}
      </td>
      <td class="text-center">
        <span class="badge badge-${getStatusBadge(ind.status)}">${ind.status}</span>
      </td>
    </tr>
  `).join('');
}

function getStatusBadge(status) {
  const map = {
    'Sensacional': 'success',
    'Excelente': 'success',
    'Bom': 'info',
    'Aceit√°vel': 'warning',
    'Ruim': 'danger',
    'P√©ssimo': 'danger',
    'Positivo': 'success',
    'Negativo': 'danger',
    'Saud√°vel': 'success',
    'Aten√ß√£o': 'warning',
    'Cr√≠tico': 'danger'
  };
  return map[status] || 'secondary';
}

// ============================================================================
// UTILITIES
// ============================================================================

function formatCurrency(value) {
  if (value === null || value === undefined) return 'R$ 0,00';
  return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
}

function formatDate(dateStr) {
  if (!dateStr) return '-';
  const date = new Date(dateStr);
  return date.toLocaleDateString('pt-BR');
}

function getStatusClass(status) {
  const map = {
    'PENDENTE': 'warning',
    'PAGA': 'success',
    'RECEBIDA': 'success',
    'VENCIDA': 'danger',
    'CANCELADA': 'secondary',
    'CONCILIADO': 'success'
  };
  return map[status] || 'secondary';
}

function updateElement(id, value) {
  const el = document.getElementById(id);
  if (el) el.textContent = value;
}

function showLoading(message = 'Carregando...') {
  const overlay = document.getElementById('loading-overlay');
  if (overlay) {
    overlay.style.display = 'flex';
    const text = overlay.querySelector('p');
    if (text) text.textContent = message;
  }
}

function hideLoading() {
  const overlay = document.getElementById('loading-overlay');
  if (overlay) overlay.style.display = 'none';
}

function showToast(message, type = 'info') {
  const container = document.getElementById('toast-container');
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.innerHTML = `
    <span>${message}</span>
  `;
  container.appendChild(toast);

  setTimeout(() => {
    toast.remove();
  }, 3000);
}

function handleError(error) {
  hideLoading();
  console.error('Error:', error);
  showToast(error.message || 'Ocorreu um erro', 'error');
}

function toggleSelectAll(type) {
  const checked = document.getElementById(`select-all-${type}`).checked;
  document.querySelectorAll(`.select-${type}`).forEach(cb => {
    cb.checked = checked;
  });
  if (type === 'cp') updateBatchButtons();
  if (type === 'cr') updateBatchButtonsReceber();
}

function getSelectedIds(type) {
  return Array.from(document.querySelectorAll(`.select-${type}:checked`))
    .map(cb => cb.value);
}

function updateBatchButtons() {
  const selected = getSelectedIds('cp');
  document.getElementById('btn-pagar-lote').disabled = selected.length === 0;
  document.getElementById('btn-cancelar-lote').disabled = selected.length === 0;
}

function updateBatchButtonsReceber() {
  const selected = getSelectedIds('cr');
  document.getElementById('btn-receber-lote').disabled = selected.length === 0;
  document.getElementById('btn-cancelar-receber-lote').disabled = selected.length === 0;
}
</script>
