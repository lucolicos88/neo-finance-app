<script>
// ============================================================================
// GLOBAL STATE
// ============================================================================

let currentView = 'dashboard';
let appData = {
  contasPagar: [],
  contasReceber: [],
  extratos: [],
  lancamentos: [],
  filiais: [],
  canais: []
};

function unwrap(res) {
  if (!res) return {};
  if (res.success) return res.data || {};
  return res;
}

// ============================================================================
// INITIALIZATION
// ============================================================================

document.addEventListener('DOMContentLoaded', function() {
  initializeApp();
});

function initializeApp() {
  // Setup navigation
  setupNavigation();

  // Load reference data
  loadReferenceData();

  // Load initial view
  navigateTo('dashboard');
}

// ============================================================================
// NAVIGATION
// ============================================================================

function setupNavigation() {
  const navItems = document.querySelectorAll('.nav-item');
  navItems.forEach(item => {
    item.addEventListener('click', function(e) {
      e.preventDefault();
      const view = this.getAttribute('data-view');
      navigateTo(view);
    });
  });
}

function navigateTo(view) {
  // Update active nav item
  document.querySelectorAll('.nav-item').forEach(item => {
    item.classList.remove('active');
  });
  document.querySelector(`[data-view="${view}"]`)?.classList.add('active');

  // Load view content
  currentView = view;
  loadView(view);
}

function loadView(view) {
  showLoading();

  google.script.run
    .withSuccessHandler(function(html) {
      document.getElementById('main-content').innerHTML = html;
      hideLoading();

      // Initialize view-specific logic
      switch(view) {
        case 'dashboard':
          loadDashboardData();
          break;
        case 'contas-pagar':
          loadContasPagarData();
          break;
        case 'contas-receber':
          loadContasReceberData();
          break;
        case 'conciliacao':
          loadConciliacaoData();
          break;
        case 'relatorios':
          loadRelatoriosData();
          break;
        case 'configuracoes':
          // placeholder, no backend call yet
          break;
      }
    })
    .withFailureHandler(handleError)
    .getViewHtml(view);
}

// ============================================================================
// REFERENCE DATA
// ============================================================================

function loadReferenceData() {
  google.script.run
    .withSuccessHandler(function(data) {
      appData.filiais = data.filiais || [];
      appData.canais = data.canais || [];
      populateFilters();
    })
    .withFailureHandler(handleError)
    .getReferenceData();
}

function populateFilters() {
  // Populate filial filters
  const filiaisSelects = document.querySelectorAll('#filter-cp-filial, #filter-cr-filial');
  filiaisSelects.forEach(select => {
    select.innerHTML = '<option value="">Todas</option>';
    appData.filiais.forEach(filial => {
      select.innerHTML += `<option value="${filial.codigo}">${filial.nome}</option>`;
    });
  });
}

// ============================================================================
// DASHBOARD
// ============================================================================

function loadDashboardData() {
  google.script.run
    .withSuccessHandler(function(data) {
      const dash = unwrap(data);
      if (dash.error) return handleError(dash.error);
      // Update stats
      updateElement('stat-pagar-vencidas', formatCurrency(dash.pagarVencidas?.valor || 0));
      updateElement('stat-pagar-vencidas-qtd', `${dash.pagarVencidas?.quantidade || 0} contas`);
      updateElement('stat-pagar-proximas', formatCurrency(dash.pagarProximas?.valor || 0));
      updateElement('stat-pagar-proximas-qtd', `${dash.pagarProximas?.quantidade || 0} contas`);
      updateElement('stat-receber-hoje', formatCurrency(dash.receberHoje?.valor || 0));
      updateElement('stat-receber-hoje-qtd', `${dash.receberHoje?.quantidade || 0} contas`);
      updateElement('stat-conciliacao-pendentes', dash.conciliacaoPendentes?.quantidade || 0);
      updateElement('stat-conciliacao-valor', formatCurrency(dash.conciliacaoPendentes?.valor || 0));

      // Render recent transactions
      renderDashboardTransactions(dash.recentTransactions);

      // Render alerts
      renderDashboardAlerts(dash.alerts);
    })
    .withFailureHandler(handleError)
    .getDashboardData();
}

function renderDashboardTransactions(transactions) {
  const tbody = document.getElementById('dashboard-transactions');

  if (!transactions || transactions.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Nenhum lan√ßamento encontrado</td></tr>';
    return;
  }

  tbody.innerHTML = transactions.map(t => `
    <tr>
      <td>${formatDate(t.data)}</td>
      <td>${t.descricao}</td>
      <td><span class="badge ${t.tipo === 'RECEITA' ? 'badge-success' : 'badge-danger'}">${t.tipo}</span></td>
      <td class="${t.tipo === 'RECEITA' ? 'text-success' : 'text-danger'}">${formatCurrency(t.valor)}</td>
      <td><span class="badge badge-${getStatusClass(t.status)}">${t.status}</span></td>
      <td>
        <button class="btn btn-outline btn-sm" onclick="viewTransaction('${t.id}')">Ver</button>
      </td>
    </tr>
  `).join('');
}

function renderDashboardAlerts(alerts) {
  const container = document.getElementById('dashboard-alerts');

  if (!alerts || alerts.length === 0) {
    container.innerHTML = '<p class="text-muted">Nenhum alerta no momento</p>';
    return;
  }

  container.innerHTML = alerts.map(alert => `
    <div class="alert alert-${alert.type}" style="padding: 1rem; margin-bottom: 0.5rem; border-left: 4px solid; border-radius: 4px;">
      <strong>${alert.title}</strong>
      <p style="margin: 0.5rem 0 0 0;">${alert.message}</p>
    </div>
  `).join('');
}

function refreshDashboard() {
  loadDashboardData();
  showToast('Dashboard atualizado', 'success');
}

// ============================================================================
// CONTAS A PAGAR
// ============================================================================

function loadContasPagarData() {
  showLoading();

  google.script.run
    .withSuccessHandler(function(data) {
      hideLoading();
      const payload = unwrap(data);
      if (payload.error) return handleError(payload.error);
      appData.contasPagar = payload.contas || payload || [];

      // Update stats
      updateElement('cp-vencidas-valor', formatCurrency(payload.stats?.vencidas?.valor || 0));
      updateElement('cp-vencidas-qtd', `${payload.stats?.vencidas?.quantidade || 0} contas`);
      updateElement('cp-vencer-valor', formatCurrency(payload.stats?.vencer7?.valor || 0));
      updateElement('cp-vencer-qtd', `${payload.stats?.vencer7?.quantidade || 0} contas`);
      updateElement('cp-futuro-valor', formatCurrency(payload.stats?.vencer30?.valor || 0));
      updateElement('cp-futuro-qtd', `${payload.stats?.vencer30?.quantidade || 0} contas`);
      updateElement('cp-pagas-valor', formatCurrency(payload.stats?.pagas?.valor || 0));
      updateElement('cp-pagas-qtd', `${payload.stats?.pagas?.quantidade || 0} contas`);

      // Render table
      renderContasPagarTable(appData.contasPagar);
    })
    .withFailureHandler(handleError)
    .getContasPagar();
}

function renderContasPagarTable(contas) {
  const tbody = document.getElementById('table-contas-pagar');
  updateElement('cp-total-registros', contas.length);

  if (!contas || contas.length === 0) {
    tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">Nenhuma conta encontrada</td></tr>';
    return;
  }

  tbody.innerHTML = contas.map(c => `
    <tr>
      <td><input type="checkbox" class="select-cp" value="${c.id}"></td>
      <td>${c.id}</td>
      <td>${formatDate(c.vencimento)}</td>
      <td>${c.fornecedor}</td>
      <td>${c.descricao}</td>
      <td class="text-danger">${formatCurrency(c.valor)}</td>
      <td><span class="badge badge-${getStatusClass(c.status)}">${c.status}</span></td>
      <td>${c.filial}</td>
      <td>
        <button class="btn btn-sm btn-outline" onclick="editContaPagar('${c.id}')">‚úèÔ∏è</button>
        <button class="btn btn-sm btn-success" onclick="pagarConta('${c.id}')" ${c.status !== 'PENDENTE' ? 'disabled' : ''}>‚úì</button>
      </td>
    </tr>
  `).join('');

  // Setup checkbox listeners
  document.querySelectorAll('.select-cp').forEach(cb => {
    cb.addEventListener('change', updateBatchButtons);
  });
}

function filterContasPagar() {
  const status = document.getElementById('filter-cp-status').value;
  const filial = document.getElementById('filter-cp-filial').value;
  const dataInicio = document.getElementById('filter-cp-data-inicio').value;
  const dataFim = document.getElementById('filter-cp-data-fim').value;

  let filtered = appData.contasPagar;

  if (status) filtered = filtered.filter(c => c.status === status);
  if (filial) filtered = filtered.filter(c => c.filial === filial);
  if (dataInicio) filtered = filtered.filter(c => c.vencimento >= dataInicio);
  if (dataFim) filtered = filtered.filter(c => c.vencimento <= dataFim);

  renderContasPagarTable(filtered);
}

function clearFilters(type) {
  if (type === 'pagar') {
    document.getElementById('filter-cp-status').value = '';
    document.getElementById('filter-cp-filial').value = '';
    document.getElementById('filter-cp-data-inicio').value = '';
    document.getElementById('filter-cp-data-fim').value = '';
    filterContasPagar();
  } else if (type === 'receber') {
    document.getElementById('filter-cr-status').value = '';
    document.getElementById('filter-cr-cliente').value = '';
    document.getElementById('filter-cr-data-inicio').value = '';
    document.getElementById('filter-cr-data-fim').value = '';
    filterContasReceber();
  }
}

function openNovaContaPagar() {
  showToast('Funcionalidade em desenvolvimento', 'info');
  // TODO: Open modal form
}

function pagarConta(id) {
  if (!confirm('Confirmar pagamento desta conta?')) return;

  showLoading();
  google.script.run
    .withSuccessHandler(function() {
      hideLoading();
      showToast('Conta paga com sucesso', 'success');
      loadContasPagarData();
    })
    .withFailureHandler(handleError)
    .pagarConta(id);
}

function pagarEmLote() {
  const selected = getSelectedIds('cp');
  if (selected.length === 0) {
    showToast('Selecione ao menos uma conta', 'warning');
    return;
  }

  if (!confirm(`Confirmar pagamento de ${selected.length} contas?`)) return;

  showLoading();
  google.script.run
    .withSuccessHandler(function() {
      hideLoading();
      showToast(`${selected.length} contas pagas com sucesso`, 'success');
      loadContasPagarData();
    })
    .withFailureHandler(handleError)
    .pagarContasEmLote(selected);
}

// ============================================================================
// CONTAS A RECEBER
// ============================================================================

function loadContasReceberData() {
  showLoading();

  google.script.run
    .withSuccessHandler(function(data) {
      hideLoading();
      const payload = unwrap(data);
      if (payload.error) return handleError(payload.error);
      appData.contasReceber = payload.contas || payload || [];

      // Update stats
      updateElement('cr-vencidas-valor', formatCurrency(payload.stats?.vencidas?.valor || 0));
      updateElement('cr-vencidas-qtd', `${payload.stats?.vencidas?.quantidade || 0} contas`);
      updateElement('cr-receber-valor', formatCurrency(payload.stats?.receber7?.valor || 0));
      updateElement('cr-receber-qtd', `${payload.stats?.receber7?.quantidade || 0} contas`);
      updateElement('cr-futuro-valor', formatCurrency(payload.stats?.receber30?.valor || 0));
      updateElement('cr-futuro-qtd', `${payload.stats?.receber30?.quantidade || 0} contas`);
      updateElement('cr-recebidas-valor', formatCurrency(payload.stats?.recebidas?.valor || 0));
      updateElement('cr-recebidas-qtd', `${payload.stats?.recebidas?.quantidade || 0} contas`);

      // Render table
      renderContasReceberTable(appData.contasReceber);
    })
    .withFailureHandler(handleError)
    .getContasReceber();
}

function renderContasReceberTable(contas) {
  const tbody = document.getElementById('table-contas-receber');
  updateElement('cr-total-registros', contas.length);

  if (!contas || contas.length === 0) {
    tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">Nenhuma conta encontrada</td></tr>';
    return;
  }

  tbody.innerHTML = contas.map(c => `
    <tr>
      <td><input type="checkbox" class="select-cr" value="${c.id}"></td>
      <td>${c.id}</td>
      <td>${formatDate(c.vencimento)}</td>
      <td>${c.cliente}</td>
      <td>${c.descricao}</td>
      <td class="text-success">${formatCurrency(c.valor)}</td>
      <td><span class="badge badge-${getStatusClass(c.status)}">${c.status}</span></td>
      <td>${c.canal}</td>
      <td>
        <button class="btn btn-sm btn-outline" onclick="editContaReceber('${c.id}')">‚úèÔ∏è</button>
        <button class="btn btn-sm btn-success" onclick="receberConta('${c.id}')" ${c.status !== 'PENDENTE' ? 'disabled' : ''}>‚úì</button>
      </td>
    </tr>
  `).join('');

  // Setup checkbox listeners
  document.querySelectorAll('.select-cr').forEach(cb => {
    cb.addEventListener('change', updateBatchButtonsReceber);
  });
}

function filterContasReceber() {
  const status = document.getElementById('filter-cr-status').value;
  const cliente = document.getElementById('filter-cr-cliente').value.toLowerCase();
  const dataInicio = document.getElementById('filter-cr-data-inicio').value;
  const dataFim = document.getElementById('filter-cr-data-fim').value;

  let filtered = appData.contasReceber;

  if (status) filtered = filtered.filter(c => c.status === status);
  if (cliente) filtered = filtered.filter(c => c.cliente.toLowerCase().includes(cliente));
  if (dataInicio) filtered = filtered.filter(c => c.vencimento >= dataInicio);
  if (dataFim) filtered = filtered.filter(c => c.vencimento <= dataFim);

  renderContasReceberTable(filtered);
}

// ============================================================================
// CONCILIA√á√ÉO
// ============================================================================

function loadConciliacaoData() {
  showLoading();

  google.script.run
    .withSuccessHandler(function(data) {
      hideLoading();
      const payload = unwrap(data);
      if (payload.error) return handleError(payload.error);
      appData.extratos = payload.extratos || [];
      appData.lancamentos = payload.lancamentos || [];

      // Update stats
      updateElement('conc-extratos-pendentes', payload.stats?.extratosPendentes || 0);
      updateElement('conc-extratos-valor', formatCurrency(payload.stats?.extratosValor || 0));
      updateElement('conc-lancamentos-pendentes', payload.stats?.lancamentosPendentes || 0);
      updateElement('conc-lancamentos-valor', formatCurrency(payload.stats?.lancamentosValor || 0));
      updateElement('conc-hoje', payload.stats?.conciliadosHoje || 0);
      updateElement('conc-hoje-valor', formatCurrency(payload.stats?.conciliadosHojeValor || 0));
      updateElement('conc-taxa', `${payload.stats?.taxaConciliacao || 0}%`);

      // Render lists
      renderExtratosList(appData.extratos);
      renderLancamentosList(appData.lancamentos);
      renderHistoricoConciliacao(payload.historico || []);
    })
    .withFailureHandler(handleError)
    .getConciliacaoData();
}

function renderExtratosList(extratos) {
  const container = document.getElementById('extratos-list');

  if (!extratos || extratos.length === 0) {
    container.innerHTML = '<p class="text-muted text-center">Nenhum extrato pendente</p>';
    return;
  }

  container.innerHTML = extratos.map(e => `
    <div class="extrato-item" data-id="${e.id}" onclick="selectExtrato('${e.id}')">
      <div class="item-header">
        <span class="item-date">${formatDate(e.data)}</span>
        <span class="item-value ${e.valor >= 0 ? 'positive' : 'negative'}">${formatCurrency(e.valor)}</span>
      </div>
      <div class="item-description">${e.descricao}</div>
      <div class="item-meta">
        <span>üè¶ ${e.banco}</span>
        <span>üìÑ ${e.id}</span>
      </div>
    </div>
  `).join('');
}

function renderLancamentosList(lancamentos) {
  const container = document.getElementById('lancamentos-list');

  if (!lancamentos || lancamentos.length === 0) {
    container.innerHTML = '<p class="text-muted text-center">Nenhum lan√ßamento pendente</p>';
    return;
  }

  container.innerHTML = lancamentos.map(l => `
    <div class="lancamento-item" data-id="${l.id}" onclick="selectLancamento('${l.id}')">
      <div class="item-header">
        <span class="item-date">${formatDate(l.data)}</span>
        <span class="item-value ${l.tipo === 'RECEITA' ? 'positive' : 'negative'}">${formatCurrency(l.valor)}</span>
      </div>
      <div class="item-description">${l.descricao}</div>
      <div class="item-meta">
        <span>üìä ${l.tipo}</span>
        <span>üìÑ ${l.id}</span>
      </div>
    </div>
  `).join('');
}

let selectedExtrato = null;
let selectedLancamento = null;

function selectExtrato(id) {
  document.querySelectorAll('.extrato-item').forEach(item => item.classList.remove('selected'));
  document.querySelector(`.extrato-item[data-id="${id}"]`).classList.add('selected');
  selectedExtrato = id;
  checkConciliacaoPossivel();
}

function selectLancamento(id) {
  document.querySelectorAll('.lancamento-item').forEach(item => item.classList.remove('selected'));
  document.querySelector(`.lancamento-item[data-id="${id}"]`).classList.add('selected');
  selectedLancamento = id;
  checkConciliacaoPossivel();
}

function checkConciliacaoPossivel() {
  if (selectedExtrato && selectedLancamento) {
    if (confirm('Deseja conciliar os itens selecionados?')) {
      conciliar(selectedExtrato, selectedLancamento);
    }
  }
}

function conciliar(extratoId, lancamentoId) {
  showLoading();

  google.script.run
    .withSuccessHandler(function() {
      hideLoading();
      showToast('Concilia√ß√£o realizada com sucesso', 'success');
      selectedExtrato = null;
      selectedLancamento = null;
      loadConciliacaoData();
    })
    .withFailureHandler(handleError)
    .conciliarItens(extratoId, lancamentoId);
}

function conciliarAutomatico() {
  if (!confirm('Executar concilia√ß√£o autom√°tica? Isso pode levar alguns segundos.')) return;

  showLoading('Processando concilia√ß√£o autom√°tica...');

  google.script.run
    .withSuccessHandler(function(result) {
      hideLoading();
      showToast(`${result.conciliados} itens conciliados automaticamente`, 'success');
      loadConciliacaoData();
    })
    .withFailureHandler(handleError)
    .conciliarAutomatico();
}

function renderHistoricoConciliacao(historico) {
  const tbody = document.getElementById('table-historico-conciliacao');

  if (!historico || historico.length === 0) {
    tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">Nenhuma concilia√ß√£o realizada</td></tr>';
    return;
  }

  tbody.innerHTML = historico.slice(0, 50).map(h => `
    <tr>
      <td>${formatDate(h.dataConciliacao)}</td>
      <td>${h.extratoId}</td>
      <td>${h.lancamentoId}</td>
      <td>${h.descricao}</td>
      <td>${formatCurrency(h.valor)}</td>
      <td>${h.banco}</td>
      <td>${h.usuario || 'Sistema'}</td>
      <td>
        <button class="btn btn-sm btn-danger" onclick="desfazerConciliacao('${h.extratoId}', '${h.lancamentoId}')">‚Ü©Ô∏è</button>
      </td>
    </tr>
  `).join('');
}

// ============================================================================
// UTILITIES
// ============================================================================

function formatCurrency(value) {
  if (value === null || value === undefined) return 'R$ 0,00';
  return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
}

function formatDate(dateStr) {
  if (!dateStr) return '-';
  const date = new Date(dateStr);
  return date.toLocaleDateString('pt-BR');
}

function getStatusClass(status) {
  const map = {
    'PENDENTE': 'warning',
    'PAGA': 'success',
    'RECEBIDA': 'success',
    'VENCIDA': 'danger',
    'CANCELADA': 'secondary',
    'CONCILIADO': 'success'
  };
  return map[status] || 'secondary';
}

function updateElement(id, value) {
  const el = document.getElementById(id);
  if (el) el.textContent = value;
}

function showLoading(message = 'Carregando...') {
  const overlay = document.getElementById('loading-overlay');
  if (overlay) {
    overlay.style.display = 'flex';
    const text = overlay.querySelector('p');
    if (text) text.textContent = message;
  }
}

function hideLoading() {
  const overlay = document.getElementById('loading-overlay');
  if (overlay) overlay.style.display = 'none';
}

function showToast(message, type = 'info') {
  const container = document.getElementById('toast-container');
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.innerHTML = `
    <span>${message}</span>
  `;
  container.appendChild(toast);

  setTimeout(() => {
    toast.remove();
  }, 3000);
}

function handleError(error) {
  hideLoading();
  console.error('Error:', error);
  showToast(error.message || 'Ocorreu um erro', 'error');
}

function toggleSelectAll(type) {
  const checked = document.getElementById(`select-all-${type}`).checked;
  document.querySelectorAll(`.select-${type}`).forEach(cb => {
    cb.checked = checked;
  });
  if (type === 'cp') updateBatchButtons();
  if (type === 'cr') updateBatchButtonsReceber();
}

function getSelectedIds(type) {
  return Array.from(document.querySelectorAll(`.select-${type}:checked`))
    .map(cb => cb.value);
}

function updateBatchButtons() {
  const selected = getSelectedIds('cp');
  document.getElementById('btn-pagar-lote').disabled = selected.length === 0;
  document.getElementById('btn-cancelar-lote').disabled = selected.length === 0;
}

function updateBatchButtonsReceber() {
  const selected = getSelectedIds('cr');
  document.getElementById('btn-receber-lote').disabled = selected.length === 0;
  document.getElementById('btn-cancelar-receber-lote').disabled = selected.length === 0;
}

// ============================================================================
// STUBS / PLACEHOLDERS DE A√á√îES
// ============================================================================

// Dashboard
function viewTransaction(id) {
  showToast(`Visualiza√ß√£o de lan√ßamento ${id} em desenvolvimento`, 'info');
}

// Contas a pagar
function editContaPagar(id) {
  showToast(`Edi√ß√£o da conta a pagar ${id} em desenvolvimento`, 'info');
}

function exportContasPagar() {
  showToast('Exporta√ß√£o de contas a pagar em desenvolvimento', 'info');
}

// Contas a receber
function openNovaContaReceber() {
  showToast('Cadastro de nova conta a receber em desenvolvimento', 'info');
}

function editContaReceber(id) {
  showToast(`Edi√ß√£o da conta a receber ${id} em desenvolvimento`, 'info');
}
</script>
