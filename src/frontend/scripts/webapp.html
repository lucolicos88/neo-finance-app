<script>
// ============================================================================
// MODAL MANAGER
// ============================================================================
var ModalManager = window.ModalManager || {
  open(modalId) {
    const modal = document.getElementById(modalId);
    if (!modal) return;
    modal.classList.add('active');
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
  },
  close(modalId) {
    const modal = document.getElementById(modalId);
    if (!modal) return;
    modal.classList.remove('active');
    modal.style.display = 'none';
    document.body.style.overflow = '';

    // Reset form if exists
    const form = modal.querySelector('form');
    if (form) {
      form.reset();
      const editIndex = modal.querySelector('[id$="-edit-index"]');
      if (editIndex) editIndex.value = '';
    }
  },
  closeAll() {
    document.querySelectorAll('.modal-overlay').forEach(modal => {
      modal.classList.remove('active');
      modal.style.display = 'none';
    });
    document.body.style.overflow = '';
  }
};
window.ModalManager = ModalManager;

var ConfirmModal = window.ConfirmModal || {
  pending: null,
  open({ title, message, messageHtml, confirmLabel = 'Confirmar', cancelLabel = 'Cancelar', hideCancel = false }) {
    const modal = document.getElementById('modal-confirm');
    if (!modal) return Promise.resolve(false);
    const titleEl = modal.querySelector('[data-confirm-title]');
    const messageEl = modal.querySelector('[data-confirm-message]');
    const btnConfirm = modal.querySelector('[data-confirm-ok]');
    const btnCancel = modal.querySelector('[data-confirm-cancel]');
    if (titleEl) titleEl.textContent = title || 'Confirmar';
    if (messageEl) {
      if (messageHtml) {
        messageEl.innerHTML = messageHtml;
      } else {
        messageEl.textContent = message || '';
      }
    }
    if (btnConfirm) btnConfirm.textContent = confirmLabel;
    if (btnCancel) {
      btnCancel.textContent = cancelLabel;
      btnCancel.style.display = hideCancel ? 'none' : '';
    }

    return new Promise(resolve => {
      ConfirmModal.pending = resolve;
      ModalManager.open('modal-confirm');
    });
  },
  close(result) {
    if (ConfirmModal.pending) {
      ConfirmModal.pending(result);
      ConfirmModal.pending = null;
    }
    ModalManager.close('modal-confirm');
  }
};
window.ConfirmModal = ConfirmModal;

function openConfirmModal(options) {
  return ConfirmModal.open(options);
}

function openInfoModal({ title, message }) {
  return ConfirmModal.open({
    title: title || 'Aviso',
    messageHtml: message || '',
    confirmLabel: 'OK',
    cancelLabel: '',
    hideCancel: true
  });
}


// Fecha modal ao clicar fora
if (!window.__neoFinanceModalListeners) {
  window.__neoFinanceModalListeners = true;
  document.addEventListener('click', function(e) {
    if (e.target.classList && e.target.classList.contains('modal-overlay')) {
      ModalManager.closeAll();
    }
  });

  // Fecha modal com ESC
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      ModalManager.closeAll();
    }
  });
}

// ============================================================================
// GLOBAL STATE
// ============================================================================

var currentUserInfo = window.currentUserInfo || {
  email: '',
  nome: '',
  perfil: '',
  avatarDataUrl: '',
  permissoes: {
    criarLancamentos: false,
    editarLancamentos: false,
    excluirLancamentos: false,
    aprovarPagamentos: false,
    visualizarRelatorios: false,
    gerenciarConfig: false,
    importarArquivos: false
  }
};
window.currentUserInfo = currentUserInfo;

function escapeHtml(value) {
  return String(value ?? '')
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/\"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

function createAvatarDataUrl(label) {
  const text = String(label || '').trim() || 'U';
  const initials = text
    .split(/\\s+/)
    .filter(Boolean)
    .slice(0, 2)
    .map(p => p[0].toUpperCase())
    .join('');

  const bg = '#29376F';
  const fg = '#ffffff';
  const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 80 80">
    <rect width="80" height="80" rx="40" fill="${bg}"/>
    <text x="50%" y="54%" text-anchor="middle" font-family="Segoe UI, Arial" font-size="28" fill="${fg}" font-weight="700">${escapeHtml(initials || 'U')}</text>
  </svg>`;

  return `data:image/svg+xml;charset=utf-8,${encodeURIComponent(svg)}`;
}

var currentView = window.currentView || 'dashboard';
var appData = window.appData || {
  contasPagar: [],
  contasReceber: [],
  extratos: [],
  lancamentos: [],
  filiais: [],
  canais: [],
  contas: [],
  centrosCusto: [],
  caixaTipos: []
};
window.currentView = currentView;
window.appData = appData;
var conciliacaoSnapshot = window.conciliacaoSnapshot || null;
var currentComparativoTipo = window.currentComparativoTipo || 'PAGAR';
var caixasState = window.caixasState || { caixas: [], movimentos: [], selectedId: '' };
var defaultCaixaTipos = window.defaultCaixaTipos || [
  { tipo: 'Reforco do Caixa', natureza: 'ENTRADA', requerArquivo: false, sistemaFc: false, contaReforco: false },
  { tipo: 'Cartao de Credito', natureza: 'ENTRADA', requerArquivo: true, sistemaFc: false, contaReforco: false },
  { tipo: 'Depositos', natureza: 'ENTRADA', requerArquivo: true, sistemaFc: false, contaReforco: false },
  { tipo: 'Dinheiro', natureza: 'ENTRADA', requerArquivo: false, sistemaFc: false, contaReforco: false },
  { tipo: 'Link', natureza: 'ENTRADA', requerArquivo: true, sistemaFc: false, contaReforco: false },
  { tipo: 'Deposito Caixa', natureza: 'ENTRADA', requerArquivo: false, sistemaFc: false, contaReforco: false },
  { tipo: 'Outras Entradas', natureza: 'ENTRADA', requerArquivo: false, sistemaFc: false, contaReforco: false },
  { tipo: 'Outras Saidas', natureza: 'SAIDA', requerArquivo: false, sistemaFc: false, contaReforco: false },
  { tipo: 'Dinheiro Cofre', natureza: 'ENTRADA', requerArquivo: false, sistemaFc: false, contaReforco: true },
  { tipo: 'Dinheiro Caixa', natureza: 'ENTRADA', requerArquivo: false, sistemaFc: false, contaReforco: true },
  { tipo: 'Moedas', natureza: 'ENTRADA', requerArquivo: false, sistemaFc: false, contaReforco: true },
  { tipo: 'Sistema FC', natureza: 'ENTRADA', requerArquivo: true, sistemaFc: true, contaReforco: false }
];
var defaultMovTypes = window.defaultMovTypes || defaultCaixaTipos.map(t => t.tipo);

var correlationId = window.__neoFinanceCorrelationId || (() => {
  try {
    const k = 'neoFinanceCorrelationId';
    const existing = sessionStorage.getItem(k);
    if (existing) return existing;
    const id = `c_${Date.now()}_${Math.random().toString(16).slice(2)}`;
    sessionStorage.setItem(k, id);
    return id;
  } catch {
    return `c_${Date.now()}_${Math.random().toString(16).slice(2)}`;
  }
})();
window.__neoFinanceCorrelationId = correlationId;

function getRequestContext() {
  return {
    __ctx: true,
    correlationId,
    view: currentView,
    url: location && location.href ? String(location.href) : '',
  };
}

function createGasRun() {
  const wrap = (runner) =>
    new Proxy(runner, {
      get(target, prop) {
        if (prop === 'withSuccessHandler' || prop === 'withFailureHandler' || prop === 'withUserObject') {
          return (...args) => wrap(target[prop](...args));
        }
        const value = target[prop];
        if (typeof value === 'function') {
          return (...args) => value.apply(target, [...args, getRequestContext()]);
        }
        return value;
      },
    });
  return wrap(google.script.run);
}

window.gasRun = createGasRun();

// ============================================================================
// INITIALIZATION
// ============================================================================

document.addEventListener('DOMContentLoaded', function() {
  if (window.__neoFinanceWebappInitialized) return;
  window.__neoFinanceWebappInitialized = true;
  initializeApp();
});

function initializeApp() {
  if (typeof window !== 'undefined' && window.__standaloneView) {
    bootStandaloneView(String(window.__standaloneView));
    return;
  }
  // Setup navigation
  setupNavigation();

  Promise.allSettled([loadCurrentUserInfo(), loadReferenceData()]).finally(() => {
    renderUserInfo();
    const canSeeReports = Boolean(currentUserInfo.permissoes?.visualizarRelatorios);
    const canImport = Boolean(currentUserInfo.permissoes?.importarArquivos);
    if (canSeeReports) {
      navigateTo('dashboard');
    } else if (canImport && currentUserInfo.perfil === 'CAIXA') {
      navigateTo('caixas');
    } else if (canImport) {
      navigateTo('conciliacao');
    } else {
      navigateTo('ajuda');
      showToast('Sem permissao para acessar o sistema', 'error');
    }
  });
}

function bootStandaloneView(view) {
  showLoading();
  Promise.allSettled([loadCurrentUserInfo(), loadReferenceData()]).finally(() => {
    hideLoading();
    renderUserInfo();
    const canSeeReports = Boolean(currentUserInfo.permissoes?.visualizarRelatorios);
    const canImport = Boolean(currentUserInfo.permissoes?.importarArquivos);
    const canManageConfig = Boolean(currentUserInfo.permissoes?.gerenciarConfig) || currentUserInfo.perfil === 'ADMIN';
    const isCaixa = currentUserInfo.perfil === 'CAIXA';
    const reportViews = ['dashboard', 'contas-pagar', 'contas-receber', 'caixas', 'conciliacao', 'dre', 'fluxo-caixa', 'kpis', 'relatorios'];
    const blockedReport = reportViews.includes(view) && !canSeeReports && !(
      (view === 'conciliacao' && canImport && !isCaixa) ||
      (view === 'caixas' && canImport)
    );
    if (blockedReport || (view === 'configuracoes' && !canManageConfig)) {
      const host = document.querySelector('.app-main') || document.body;
      if (host) {
        host.innerHTML = '<div class="empty-state"><div class="empty-state-message">Sem permissao para acessar o sistema</div><div class="empty-state-hint">Solicite acesso ao administrador.</div></div>';
      }
      showToast('Sem permissao para acessar o sistema', 'error');
      return;
    }
    currentView = view;
    switch (view) {
      case 'dashboard':
        loadDashboardData();
        break;
      case 'contas-pagar':
        loadContasPagarData();
        break;
      case 'contas-receber':
        loadContasReceberData();
        break;
      case 'caixas':
        loadCaixasData();
        break;
      case 'conciliacao':
        loadConciliacaoData();
        break;
      case 'dre':
        loadDREData();
        break;
      case 'fluxo-caixa':
        loadFluxoCaixaData();
        break;
      case 'kpis':
        loadKPIsData();
        break;
      case 'configuracoes':
        loadConfiguracoesData();
        break;
      default:
        break;
    }
  });
}

function renderUserInfo() {
  const userEmail = document.getElementById('user-info-email');
  const userRole = document.getElementById('user-info-role');
  const userAvatar = document.getElementById('user-avatar');

  const email = currentUserInfo.email || 'usuario@empresa.com';
  const perfil = currentUserInfo.perfil || 'USUARIO';
  const permissoes = currentUserInfo.permissoes || {};
  const isCaixa = perfil === 'CAIXA';

  if (userEmail) userEmail.textContent = email;
  if (userRole) userRole.textContent = perfil;
  if (userAvatar) {
    userAvatar.src = currentUserInfo.avatarDataUrl || createAvatarDataUrl(currentUserInfo.nome || email);
    userAvatar.alt = currentUserInfo.nome || email;
  }

  const setNavVisible = (view, visible) => {
    const el = document.querySelector(`.nav-item[data-view="${view}"]`);
    if (!el) return;
    el.style.display = visible ? '' : 'none';
  };

  // Relatórios e visão geral
  const canSeeReports = Boolean(permissoes.visualizarRelatorios);
  const canImport = Boolean(permissoes.importarArquivos);
  setNavVisible('dashboard', canSeeReports);
  setNavVisible('contas-pagar', canSeeReports);
  setNavVisible('contas-receber', canSeeReports);
  setNavVisible('caixas', canSeeReports || canImport);
  setNavVisible('conciliacao', canSeeReports || (canImport && !isCaixa));
  setNavVisible('dre', canSeeReports);
  setNavVisible('fluxo-caixa', canSeeReports);
  setNavVisible('kpis', canSeeReports);
  setNavVisible('ajuda', true);

  // Configurações
  const canManageConfig = Boolean(permissoes.gerenciarConfig) || perfil === 'ADMIN';
  setNavVisible('configuracoes', canManageConfig);
}

function loadCurrentUserInfo() {
  return new Promise(resolve => {
    window.gasRun
      .withSuccessHandler(function(data) {
        if (data && data.email) {
          currentUserInfo.email = data.email;
          currentUserInfo.nome = data.nome || '';
          currentUserInfo.perfil = data.perfil || '';
          currentUserInfo.permissoes = data.permissoes || currentUserInfo.permissoes;
          currentUserInfo.avatarDataUrl = createAvatarDataUrl(data.nome || data.email);
        }
        resolve(data);
      })
      .withFailureHandler(function() {
        resolve(null);
      })
      .getCurrentUserInfo();
  });
}

// ============================================================================
// NAVIGATION
// ============================================================================

function setupNavigation() {
  const navItems = document.querySelectorAll('.nav-item');
  navItems.forEach(item => {
    item.addEventListener('click', function(e) {
      e.preventDefault();
      const view = this.getAttribute('data-view');
      navigateTo(view);
    });
  });
}

function navigateTo(view) {
  const perms = currentUserInfo.permissoes || {};
  const canSeeReports = Boolean(perms.visualizarRelatorios);
  const canImport = Boolean(perms.importarArquivos);
  const canManageConfig = Boolean(perms.gerenciarConfig) || currentUserInfo.perfil === 'ADMIN';
  const isCaixa = currentUserInfo.perfil === 'CAIXA';

  if (isCaixa && !['caixas', 'ajuda'].includes(view)) {
    showToast('Sem permissao para acessar este modulo', 'error');
    return;
  }

  if (['dashboard','contas-pagar','contas-receber','caixas','conciliacao','dre','fluxo-caixa','kpis','relatorios'].includes(view) && !canSeeReports && !canImport) {
    showToast('Sem permissão para acessar relatórios', 'error');
    return;
  }
  if (view === 'configuracoes' && !canManageConfig) {
    showToast('Sem permissão para acessar configurações', 'error');
    return;
  }

  // Fechar modais ao trocar de view
  ModalManager.closeAll();

  // Update active nav item
  document.querySelectorAll('.nav-item').forEach(item => {
    item.classList.remove('active');
  });
  document.querySelector(`[data-view="${view}"]`)?.classList.add('active');

  // Load view content
  currentView = view;
  loadView(view);
}

function loadView(view) {
  showLoading();

  window.gasRun
    .withSuccessHandler(function(html) {
      document.getElementById('main-content').innerHTML = html;
      hideLoading();

      // Initialize view-specific logic
      switch(view) {
        case 'dashboard':
          loadDashboardData();
          break;
        case 'contas-pagar':
          loadContasPagarData();
          break;
        case 'contas-receber':
          loadContasReceberData();
          break;
        case 'caixas':
          loadCaixasData();
          break;
        case 'conciliacao':
          loadConciliacaoData();
          break;
        case 'relatorios':
          loadRelatoriosData();
          break;
        case 'dre':
          loadDREData();
          break;
        case 'fluxo-caixa':
          loadFluxoCaixaData();
          break;
        case 'kpis':
          loadKPIsData();
          break;
        case 'configuracoes':
          if (currentUserInfo.permissoes?.gerenciarConfig || currentUserInfo.perfil === 'ADMIN') {
            loadConfiguracoesData();
          }
          break;
      }
    })
    .withFailureHandler(handleError)
    .getViewHtml(view);
}

// ============================================================================
// REFERENCE DATA
// ============================================================================

function loadReferenceData() {
  return new Promise(resolve => {
    window.gasRun
      .withSuccessHandler(function(data) {
        if (data) {
          appData.filiais = data.filiais || [];
          appData.canais = data.canais || [];
          appData.contas = data.contas || [];
          appData.centrosCusto = data.centrosCusto || [];
          appData.caixaTipos = data.caixaTipos || [];
          populateFilters();

          if (currentView === 'configuracoes') {
            loadConfiguracoesData();
          }
        } else {
          console.error('getReferenceData retornou null');
          showToast('Erro ao carregar dados de referência', 'error');
        }
        resolve(data);
      })
      .withFailureHandler(function(error) {
        console.error('Erro ao carregar dados de referência:', error);
        handleError(error);
        resolve(null);
      })
      .getReferenceData();
  });
}

function populateFilters() {
  // Populate filial filters
  const filiaisSelects = document.querySelectorAll('#filter-cp-filial, #filter-cr-filial');
  filiaisSelects.forEach(select => {
    const options = ['<option value="">Todas</option>'];
    appData.filiais.forEach(filial => {
      options.push(`<option value="${escapeHtml(filial.codigo)}">${escapeHtml(filial.nome)}</option>`);
    });
    select.innerHTML = options.join('');
  });
}

// ============================================================================
// DASHBOARD
// ============================================================================
let dashboardViewMode = 'executiva';
let dashboardLastData = null;

function loadDashboardData() {
  window.gasRun
    .withSuccessHandler(function(data) {
      if (!data) {
        handleError({ message: 'getDashboardData retornou vazio' });
        return;
      }
      dashboardLastData = data;
      // Update stats
      updateElement('stat-pagar-vencidas', formatCurrency(data.pagarVencidas.valor));
      updateElement('stat-pagar-vencidas-qtd', `${data.pagarVencidas.quantidade} contas`);
      updateElement('stat-pagar-proximas', formatCurrency(data.pagarProximas.valor));
      updateElement('stat-pagar-proximas-qtd', `${data.pagarProximas.quantidade} contas`);
      updateElement('stat-receber-hoje', formatCurrency(data.receberHoje.valor));
      updateElement('stat-receber-hoje-qtd', `${data.receberHoje.quantidade} contas`);
      updateElement('stat-conciliacao-pendentes', data.conciliacaoPendentes.quantidade);
      updateElement('stat-conciliacao-valor', formatCurrency(data.conciliacaoPendentes.valor));

      // Render guidance blocks
      renderDashboardStory(data);
      renderDashboardHealth(data);
      renderDashboardMonth(data);
      renderDashboardShortTerm(data);
      renderDashboardActions(data);
      renderDashboardInsights(data);

      // Render alerts
      renderDashboardAlerts(data.alerts);
    })
    .withFailureHandler(handleError)
    .getDashboardData();
}

function setDashboardViewMode(mode) {
  const next = String(mode || '').toLowerCase();
  if (!['executiva', 'operacional', 'tecnica'].includes(next)) return;
  dashboardViewMode = next;
  updateDashboardViewButtons();
  if (dashboardLastData) {
    renderDashboardStory(dashboardLastData);
    renderDashboardActions(dashboardLastData);
    renderDashboardInsights(dashboardLastData);
  }
}

function updateDashboardViewButtons() {
  const modes = ['executiva', 'operacional', 'tecnica'];
  modes.forEach(m => {
    const btn = document.getElementById(`dash-mode-${m}`);
    if (!btn) return;
    btn.classList.remove('btn-primary');
    btn.classList.add('btn-outline');
    if (m === dashboardViewMode) {
      btn.classList.add('btn-primary');
      btn.classList.remove('btn-outline');
    }
  });
}

function renderDashboardStory(data) {
  const container = document.getElementById('dashboard-story');
  if (!container) return;

  const receitaMes = Number(data?.receitaMes?.valor || 0);
  const despesaMes = Number(data?.despesaMes?.valor || 0);
  const fluxoMes = Number(data?.fluxoMes?.valor || 0);
  const concTaxa = Number(data?.conciliacaoTaxa || 0);
  const vencidas = Number(data?.pagarVencidas?.quantidade || 0);

  const balanceLabel = fluxoMes >= 0 ? 'positivo' : 'negativo';
  const riskLabel = vencidas > 0 ? 'atencao' : 'estavel';

  let intro = '';
  if (dashboardViewMode === 'executiva') {
    intro = `Resumo: fluxo do mes ${balanceLabel}, conciliacao em ${concTaxa}% e risco ${riskLabel}.`;
  } else if (dashboardViewMode === 'operacional') {
    intro = `Foco do dia: manter pagamentos em dia, acelerar recebimentos e concluir conciliacao.`;
  } else {
    intro = `Indicadores baseados em vencimento, status e conciliacao dos dados do mes atual.`;
  }

  container.innerHTML = `
    <div style="display:flex; gap: 1rem; flex-wrap: wrap; align-items:center;">
      <div style="flex:1; min-width: 240px;">
        <strong>Resumo:</strong> ${intro}
      </div>
      <div class="stat-card" style="min-width: 220px;">
        <div class="stat-label">Receita do mes</div>
        <div class="stat-value">${formatCurrency(receitaMes)}</div>
      </div>
      <div class="stat-card" style="min-width: 220px;">
        <div class="stat-label">Despesa do mes</div>
        <div class="stat-value">${formatCurrency(despesaMes)}</div>
      </div>
      <div class="stat-card" style="min-width: 220px;">
        <div class="stat-label">Fluxo do mes</div>
        <div class="stat-value">${formatCurrency(fluxoMes)}</div>
      </div>
    </div>
  `;
}

function renderDashboardHealth(data) {
  const container = document.getElementById('dashboard-health');
  if (!container) return;

  const vencidas = Number(data?.pagarVencidas?.quantidade || 0);
  const proximas = Number(data?.pagarProximas?.quantidade || 0);
  const concPend = Number(data?.conciliacaoPendentes?.quantidade || 0);
  const receberHojeValor = Number(data?.receberHoje?.valor || 0);
  const pagarProxValor = Number(data?.pagarProximas?.valor || 0);

  let status = 'Estavel';
  let statusClass = 'success';
  if (vencidas > 0) {
    status = 'Critica';
    statusClass = 'danger';
  } else if (proximas > 0 || concPend > 0) {
    status = 'Atencao';
    statusClass = 'warning';
  }

  const curtoPrazo = receberHojeValor - pagarProxValor;
  const curtoPrazoLabel = curtoPrazo >= 0 ? 'Positivo' : 'Negativo';

  container.innerHTML = `
    <div class="alert alert-${statusClass}" style="padding: 1rem; border-left: 4px solid; border-radius: 4px;">
      <strong>Saude ${status}</strong>
      <p style="margin: 0.4rem 0 0 0;">Indicador diario baseado em vencimentos, recebimentos e conciliacao.</p>
    </div>
    <div style="display:flex; gap: 1rem; flex-wrap: wrap; margin-top: 0.75rem;">
      <div class="stat-card" style="min-width: 220px; flex:1;">
        <div class="stat-label">Fluxo curto prazo (7 dias)</div>
        <div class="stat-value">${formatCurrency(curtoPrazo)}</div>
        <div class="stat-change ${curtoPrazo >= 0 ? 'positive' : 'negative'}">${curtoPrazoLabel}</div>
      </div>
      <div class="stat-card" style="min-width: 220px; flex:1;">
        <div class="stat-label">Risco de atraso</div>
        <div class="stat-value">${vencidas}</div>
        <div class="stat-change">contas vencidas</div>
      </div>
      <div class="stat-card" style="min-width: 220px; flex:1;">
        <div class="stat-label">Conciliacao pendente</div>
        <div class="stat-value">${concPend}</div>
        <div class="stat-change">extratos pendentes</div>
      </div>
    </div>
  `;
}

function renderDashboardMonth(data) {
  const container = document.getElementById('dashboard-kpis-month');
  if (!container) return;

  const receita = Number(data?.receitaMes?.valor || 0);
  const despesa = Number(data?.despesaMes?.valor || 0);
  const fluxo = Number(data?.fluxoMes?.valor || 0);
  const margem = receita > 0 ? Math.round((fluxo / receita) * 100) : 0;
  const ticketReceita = Number(data?.receitaMes?.ticketMedio || 0);
  const ticketDespesa = Number(data?.despesaMes?.ticketMedio || 0);

  container.innerHTML = `
    <div style="display:flex; gap: 1rem; flex-wrap: wrap;">
      <div class="stat-card" style="min-width: 220px; flex:1;">
        <div class="stat-label">Receitas no mes</div>
        <div class="stat-value">${formatCurrency(receita)}</div>
      </div>
      <div class="stat-card" style="min-width: 220px; flex:1;">
        <div class="stat-label">Despesas no mes</div>
        <div class="stat-value">${formatCurrency(despesa)}</div>
      </div>
      <div class="stat-card" style="min-width: 220px; flex:1;">
        <div class="stat-label">Fluxo do mes</div>
        <div class="stat-value">${formatCurrency(fluxo)}</div>
        <div class="stat-change ${fluxo >= 0 ? 'positive' : 'negative'}">Margem ${margem}%</div>
      </div>
      <div class="stat-card" style="min-width: 220px; flex:1;">
        <div class="stat-label">Ticket medio receita</div>
        <div class="stat-value">${formatCurrency(ticketReceita)}</div>
      </div>
      <div class="stat-card" style="min-width: 220px; flex:1;">
        <div class="stat-label">Ticket medio despesa</div>
        <div class="stat-value">${formatCurrency(ticketDespesa)}</div>
      </div>
    </div>
  `;
}

function renderDashboardShortTerm(data) {
  const container = document.getElementById('dashboard-kpis-short');
  if (!container) return;

  const pagar7 = Number(data?.pagarProximas?.valor || 0);
  const receber7 = Number(data?.receberProximas?.valor || 0);
  const receberAtraso = Number(data?.receberAtrasadas?.valor || 0);
  const pagar30 = Number(data?.pagarProximas30?.valor || 0);

  container.innerHTML = `
    <div style="display:flex; gap: 1rem; flex-wrap: wrap;">
      <div class="stat-card" style="min-width: 220px; flex:1;">
        <div class="stat-label">A pagar (7 dias)</div>
        <div class="stat-value">${formatCurrency(pagar7)}</div>
      </div>
      <div class="stat-card" style="min-width: 220px; flex:1;">
        <div class="stat-label">A receber (7 dias)</div>
        <div class="stat-value">${formatCurrency(receber7)}</div>
      </div>
      <div class="stat-card" style="min-width: 220px; flex:1;">
        <div class="stat-label">Receber em atraso</div>
        <div class="stat-value">${formatCurrency(receberAtraso)}</div>
      </div>
      <div class="stat-card" style="min-width: 220px; flex:1;">
        <div class="stat-label">A pagar (30 dias)</div>
        <div class="stat-value">${formatCurrency(pagar30)}</div>
      </div>
    </div>
  `;
}

function renderDashboardActions(data) {
  const container = document.getElementById('dashboard-actions');
  if (!container) return;

  const actions = [];
  const vencidas = Number(data?.pagarVencidas?.quantidade || 0);
  const proximas = Number(data?.pagarProximas?.quantidade || 0);
  const concPend = Number(data?.conciliacaoPendentes?.quantidade || 0);
  const receberHoje = Number(data?.receberHoje?.quantidade || 0);
  const receberAtraso = Number(data?.receberAtrasadas?.quantidade || 0);

  if (dashboardViewMode === 'executiva') {
    if (vencidas > 0) actions.push('Priorizar regularizacao de vencidos para reduzir risco.');
    if (proximas > 0) actions.push('Confirmar capacidade de caixa para os proximos 7 dias.');
    if (receberAtraso > 0) actions.push('Reforcar cobranca de atrasados para recuperar caixa.');
    if (concPend > 0) actions.push('Fechar conciliacao para visao real de caixa.');
  } else if (dashboardViewMode === 'operacional') {
    if (vencidas > 0) actions.push('Pagar vencidos hoje e registrar comprovantes.');
    if (proximas > 0) actions.push('Agendar pagamentos dos proximos 7 dias.');
    if (receberHoje > 0) actions.push('Acionar clientes com recebimento previsto hoje.');
    if (receberAtraso > 0) actions.push('Executar rotina de cobranca para inadimplentes.');
    if (concPend > 0) actions.push('Conciliar extratos pendentes.');
  } else {
    if (vencidas > 0) actions.push('Checar inconsistencias de vencimento e status pendente.');
    if (proximas > 0) actions.push('Validar datas de vencimento e classificacao de despesas.');
    if (receberAtraso > 0) actions.push('Auditar regras de atraso e status de recebimento.');
    if (concPend > 0) actions.push('Revisar match de conciliacao e integridade dos dados.');
  }

  if (actions.length === 0) {
    container.innerHTML = '<p class="text-muted">Nenhuma acao critica hoje. Mantenha o acompanhamento diario.</p>';
    return;
  }

  container.innerHTML = `
    <ul style="margin: 0; padding-left: 1.1rem;">
      ${actions.map(a => `<li>${escapeHtml(a)}</li>`).join('')}
    </ul>
  `;
}

function renderDashboardInsights(data) {
  const container = document.getElementById('dashboard-insights');
  if (!container) return;

  const insights = [];
  const concPend = Number(data?.conciliacaoPendentes?.quantidade || 0);
  const proximas = Number(data?.pagarProximas?.quantidade || 0);
  const receberHoje = Number(data?.receberHoje?.quantidade || 0);
  const receberAtraso = Number(data?.receberAtrasadas?.quantidade || 0);

  insights.push('Ative Insights com IA para detectar desvios e oportunidades automaticamente.');
  if (dashboardViewMode === 'executiva') {
    if (concPend > 0) insights.push('Conciliacao pendente reduz confiabilidade do caixa.');
    if (proximas > 0) insights.push('Vencimentos proximos exigem reserva de liquidez.');
    if (receberAtraso > 0) insights.push('Atrasos podem pressionar capital de giro.');
  } else if (dashboardViewMode === 'operacional') {
    if (concPend > 0) insights.push('Concilie extratos para liberar fechamento diario.');
    if (receberHoje > 0) insights.push('Priorize cobranças de hoje para evitar atraso.');
  } else {
    insights.push('Com IA, seria possivel detectar anomalias e outliers automaticamente.');
    if (concPend > 0) insights.push('Sugestao tecnica: revisar regras de matching de conciliacao.');
    if (receberAtraso > 0) insights.push('Sugestao tecnica: criar flags de risco por cliente.');
  }

  container.innerHTML = `
    <ul style="margin: 0; padding-left: 1.1rem;">
      ${insights.map(i => `<li>${escapeHtml(i)}</li>`).join('')}
    </ul>
    <div style="margin-top: 0.75rem;">
      <button class="btn btn-primary" onclick="showToast('Insights de IA em breve', 'info')">Ativar Insights IA</button>
    </div>
  `;
}

function renderDashboardAlerts(alerts) {
  const container = document.getElementById('dashboard-alerts');
  if (!container) return;

  if (!alerts || alerts.length === 0) {
    container.innerHTML = '<p class="text-muted">Nenhum alerta no momento</p>';
    return;
  }

  const normalizeType = (t) => {
    const allowed = new Set(['danger', 'warning', 'info', 'success']);
    const v = String(t || '').toLowerCase();
    return allowed.has(v) ? v : 'info';
  };

  container.innerHTML = alerts.map(alert => `
    <div class="alert alert-${normalizeType(alert.type)}" style="padding: 1rem; margin-bottom: 0.5rem; border-left: 4px solid; border-radius: 4px;">
      <strong>${escapeHtml(alert.title)}</strong>
      <p style="margin: 0.5rem 0 0 0;">${escapeHtml(alert.message)}</p>
    </div>
  `).join('');
}

function refreshDashboard() {
  loadDashboardData();
  showToast('Dashboard atualizado', 'success');
}

// ============================================================================
// CONTAS A PAGAR
// ============================================================================

function loadContasPagarData() {
  showLoading();

  window.gasRun
    .withSuccessHandler(function(data) {
      hideLoading();
      if (!data) {
        handleError({ message: 'getContasPagar retornou vazio' });
        return;
      }
      appData.contasPagar = data.contas || [];

      // Update stats
      updateElement('cp-vencidas-valor', formatCurrency(data.stats.vencidas.valor));
      updateElement('cp-vencidas-qtd', `${data.stats.vencidas.quantidade} contas`);
      updateElement('cp-vencer-valor', formatCurrency(data.stats.vencer7.valor));
      updateElement('cp-vencer-qtd', `${data.stats.vencer7.quantidade} contas`);
      updateElement('cp-futuro-valor', formatCurrency(data.stats.vencer30.valor));
      updateElement('cp-futuro-qtd', `${data.stats.vencer30.quantidade} contas`);
      updateElement('cp-pagas-valor', formatCurrency(data.stats.pagas.valor));
      updateElement('cp-pagas-qtd', `${data.stats.pagas.quantidade} contas`);

      // Render table
      renderContasPagarTable(data.contas);
    })
    .withFailureHandler(handleError)
    .getContasPagar();
}

function renderContasPagarTable(contas) {
  const tbody = document.getElementById('table-contas-pagar');
  if (!tbody) return;
  updateElement('cp-total-registros', contas.length);

  if (!contas || contas.length === 0) {
    tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">Nenhuma conta encontrada</td></tr>';
    return;
  }

  tbody.innerHTML = contas.map(c => `
    <tr>
      <td><input type="checkbox" class="select-cp" value="${escapeHtml(c.id)}"></td>
      <td>${escapeHtml(c.id)}</td>
      <td>${formatDate(c.vencimento)}</td>
      <td>${escapeHtml(c.fornecedor)}</td>
      <td>${escapeHtml(c.descricao)}</td>
      <td class="text-danger">${formatCurrency(c.valor)}</td>
      <td><span class="badge badge-${getStatusClass(c.status)}">${escapeHtml(c.status)}</span></td>
      <td>${escapeHtml(c.filial)}</td>
      <td>
        <button class="btn btn-sm btn-outline" onclick="editContaPagar(${JSON.stringify(String(c.id))})">✏️</button>
        <button class="btn btn-sm btn-success" onclick="pagarConta(${JSON.stringify(String(c.id))})" ${(c.status !== 'PENDENTE' || !currentUserInfo.permissoes?.aprovarPagamentos) ? 'disabled' : ''}>✓</button>
      </td>
    </tr>
  `).join('');

  // Setup checkbox listeners
  document.querySelectorAll('.select-cp').forEach(cb => {
    cb.addEventListener('change', updateBatchButtons);
  });
}

function filterContasPagar() {
  const status = document.getElementById('filter-cp-status').value;
  const filial = document.getElementById('filter-cp-filial').value;
  const dataInicio = document.getElementById('filter-cp-data-inicio').value;
  const dataFim = document.getElementById('filter-cp-data-fim').value;

  let filtered = appData.contasPagar;

  if (status) filtered = filtered.filter(c => c.status === status);
  if (filial) filtered = filtered.filter(c => c.filial === filial);
  if (dataInicio) filtered = filtered.filter(c => c.vencimento >= dataInicio);
  if (dataFim) filtered = filtered.filter(c => c.vencimento <= dataFim);

  renderContasPagarTable(filtered);
}

function clearFilters(type) {
  if (type === 'pagar') {
    document.getElementById('filter-cp-status').value = '';
    document.getElementById('filter-cp-filial').value = '';
    document.getElementById('filter-cp-data-inicio').value = '';
    document.getElementById('filter-cp-data-fim').value = '';
    filterContasPagar();
  } else if (type === 'receber') {
    document.getElementById('filter-cr-status').value = '';
    document.getElementById('filter-cr-cliente').value = '';
    document.getElementById('filter-cr-data-inicio').value = '';
    document.getElementById('filter-cr-data-fim').value = '';
    filterContasReceber();
  }
}

function pagarConta(id) {
  if (!confirm('Confirmar pagamento desta conta?')) return;

  showLoading();
  window.gasRun
    .withSuccessHandler(function() {
      hideLoading();
      showToast('Conta paga com sucesso', 'success');
      loadContasPagarData();
    })
    .withFailureHandler(handleError)
    .pagarConta(id);
}

function pagarEmLote() {
  const selected = getSelectedIds('cp');
  if (selected.length === 0) {
    showToast('Selecione ao menos uma conta', 'warning');
    return;
  }

  if (!confirm(`Confirmar pagamento de ${selected.length} contas?`)) return;

  showLoading();
  window.gasRun
    .withSuccessHandler(function() {
      hideLoading();
      showToast(`${selected.length} contas pagas com sucesso`, 'success');
      loadContasPagarData();
    })
    .withFailureHandler(handleError)
    .pagarContasEmLote(selected);
}

function cancelarEmLote() {
  const selected = getSelectedIds('cp');
  if (selected.length === 0) {
    showToast('Selecione ao menos uma conta', 'warning');
    return;
  }

  if (!confirm(`Confirmar cancelamento de ${selected.length} contas?`)) return;

  showLoading();
  window.gasRun
    .withSuccessHandler(function(result) {
      hideLoading();
      if (result && result.success) {
        showToast(result.message || 'Contas canceladas com sucesso', 'success');
        loadContasPagarData();
      } else {
        showToast(result?.message || 'Erro ao cancelar contas', 'error');
      }
    })
    .withFailureHandler(handleError)
    .cancelarContasEmLote(selected);
}

// ============================================================================
// CONTAS A RECEBER
// ============================================================================

function loadContasReceberData() {
  showLoading();

  window.gasRun
    .withSuccessHandler(function(data) {
      hideLoading();
      if (!data) {
        handleError({ message: 'getContasReceber retornou vazio' });
        return;
      }
      appData.contasReceber = data.contas || [];

      // Update stats
      updateElement('cr-vencidas-valor', formatCurrency(data.stats.vencidas.valor));
      updateElement('cr-vencidas-qtd', `${data.stats.vencidas.quantidade} contas`);
      updateElement('cr-receber-valor', formatCurrency(data.stats.receber7.valor));
      updateElement('cr-receber-qtd', `${data.stats.receber7.quantidade} contas`);
      updateElement('cr-futuro-valor', formatCurrency(data.stats.receber30.valor));
      updateElement('cr-futuro-qtd', `${data.stats.receber30.quantidade} contas`);
      updateElement('cr-recebidas-valor', formatCurrency(data.stats.recebidas.valor));
      updateElement('cr-recebidas-qtd', `${data.stats.recebidas.quantidade} contas`);

      // Render table
      renderContasReceberTable(data.contas);
    })
    .withFailureHandler(handleError)
    .getContasReceber();
}

function renderContasReceberTable(contas) {
  const tbody = document.getElementById('table-contas-receber');
  if (!tbody) return;
  updateElement('cr-total-registros', contas.length);

  if (!contas || contas.length === 0) {
    tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">Nenhuma conta encontrada</td></tr>';
    return;
  }

  tbody.innerHTML = contas.map(c => `
    <tr>
      <td><input type="checkbox" class="select-cr" value="${escapeHtml(c.id)}"></td>
      <td>${escapeHtml(c.id)}</td>
      <td>${formatDate(c.vencimento)}</td>
      <td>${escapeHtml(c.cliente)}</td>
      <td>${escapeHtml(c.descricao)}</td>
      <td class="text-success">${formatCurrency(c.valor)}</td>
      <td><span class="badge badge-${getStatusClass(c.status)}">${escapeHtml(c.status)}</span></td>
      <td>${escapeHtml(c.canal)}</td>
      <td>
        <button class="btn btn-sm btn-outline" onclick="editContaReceber(${JSON.stringify(String(c.id))})">✏️</button>
        <button class="btn btn-sm btn-success" onclick="receberConta(${JSON.stringify(String(c.id))})" ${(c.status !== 'PENDENTE' || !currentUserInfo.permissoes?.aprovarPagamentos) ? 'disabled' : ''}>✓</button>
      </td>
    </tr>
  `).join('');

  // Setup checkbox listeners
  document.querySelectorAll('.select-cr').forEach(cb => {
    cb.addEventListener('change', updateBatchButtonsReceber);
  });
}

function filterContasReceber() {
  const status = document.getElementById('filter-cr-status').value;
  const cliente = document.getElementById('filter-cr-cliente').value.toLowerCase();
  const dataInicio = document.getElementById('filter-cr-data-inicio').value;
  const dataFim = document.getElementById('filter-cr-data-fim').value;

  let filtered = appData.contasReceber;

  if (status) filtered = filtered.filter(c => c.status === status);
  if (cliente) filtered = filtered.filter(c => c.cliente.toLowerCase().includes(cliente));
  if (dataInicio) filtered = filtered.filter(c => c.vencimento >= dataInicio);
  if (dataFim) filtered = filtered.filter(c => c.vencimento <= dataFim);

  renderContasReceberTable(filtered);
}

function receberConta(id) {
  if (!confirm('Confirmar recebimento desta conta?')) return;

  showLoading();
  window.gasRun
    .withSuccessHandler(function() {
      hideLoading();
      showToast('Conta recebida com sucesso', 'success');
      loadContasReceberData();
    })
    .withFailureHandler(handleError)
    .receberConta(id);
}

function receberEmLote() {
  const selected = getSelectedIds('cr');
  if (selected.length === 0) {
    showToast('Selecione ao menos uma conta', 'warning');
    return;
  }

  if (!confirm(`Confirmar recebimento de ${selected.length} contas?`)) return;

  showLoading();
  window.gasRun
    .withSuccessHandler(function(result) {
      hideLoading();
      if (result && result.success) {
        showToast(result.message || 'Recebimento em lote concluído', 'success');
      } else {
        showToast(result && result.message ? result.message : 'Falha no recebimento em lote', 'warning');
      }
      loadContasReceberData();
    })
    .withFailureHandler(function(err) {
      hideLoading();
      handleError(err);
      loadContasReceberData();
    })
    .receberContasEmLote(selected);
}

function cancelarReceberEmLote() {
  const selected = getSelectedIds('cr');
  if (selected.length === 0) {
    showToast('Selecione ao menos uma conta', 'warning');
    return;
  }

  if (!confirm(`Confirmar cancelamento de ${selected.length} contas?`)) return;

  showLoading();
  window.gasRun
    .withSuccessHandler(function(result) {
      hideLoading();
      if (result && result.success) {
        showToast(result.message || 'Contas canceladas com sucesso', 'success');
        loadContasReceberData();
      } else {
        showToast(result?.message || 'Erro ao cancelar contas', 'error');
      }
    })
    .withFailureHandler(handleError)
    .cancelarContasReceberEmLote(selected);
}

// ============================================================================
// CONCILIACAO (IMPORTACOES)
// ============================================================================
let comparativoPage = 1;
let comparativoPageSize = 100;

function loadConciliacaoData() {
  initComparativoMonth();
  populateImportFiliais();
  loadComparativo(currentComparativoTipo, true);
}

function initComparativoMonth() {
  const input = document.getElementById('conciliacao-mes');
  if (!input) return;
  if (!input.value) {
    const now = new Date();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    input.value = `${now.getFullYear()}-${month}`;
  }
}

function onComparativoMonthChange() {
  comparativoPage = 1;
  loadComparativo(currentComparativoTipo, true);
}

function populateImportFiliais() {
  const selectIds = ['fc-filial', 'itau-filial', 'sieg-filial'];
  selectIds.forEach(id => {
    const select = document.getElementById(id);
    if (!select) return;
    const options = ['<option value="">Selecionar...</option>'];
    appData.filiais.forEach(f => {
      options.push(`<option value="${escapeHtml(f.codigo)}">${escapeHtml(f.nome)}</option>`);
    });
    select.innerHTML = options.join('');
  });
}

function refreshComparativo() {
  comparativoPage = 1;
  loadComparativo(currentComparativoTipo, true);
}

function loadComparativo(tipo, resetPage) {
  const t = String(tipo || 'PAGAR').toUpperCase();
  currentComparativoTipo = t;
  if (resetPage) comparativoPage = 1;
  const monthInput = document.getElementById('conciliacao-mes');
  const monthValue = monthInput && monthInput.value ? String(monthInput.value) : '';
  const [yearStr, monthStr] = monthValue.split('-');
  const year = Number(yearStr) || null;
  const month = Number(monthStr) || null;
  showLoading('Carregando comparativo...');
  window.gasRun
    .withSuccessHandler(function(data) {
      hideLoading();
      if (!data || !data.success) {
        showToast(data?.message || 'Erro ao carregar comparativo', 'error');
        return;
      }
      updateElement('comp-total', String(data.stats?.total || 0));
      updateElement('comp-auto', String(data.stats?.auto || 0));
      updateElement('comp-pendente', String(data.stats?.pendente || 0));
      updateElement('comp-sem-match', String(data.stats?.semMatch || 0));
      updateElement('comp-duplicado', String(data.stats?.duplicado || 0));
      renderComparativo(data.items || [], t, data.counts || null);
      updateComparativoPagination(data.total || 0, data.page || comparativoPage, data.pageSize || comparativoPageSize);
    })
    .withFailureHandler(handleError)
    .getComparativoData({ tipo: t, year, month, page: comparativoPage, pageSize: comparativoPageSize });
}

function updateComparativoPagination(total, page, pageSize) {
  const info = document.getElementById('comp-page-info');
  const prev = document.getElementById('comp-prev');
  const next = document.getElementById('comp-next');
  const sizeSelect = document.getElementById('comp-page-size');

  const totalPages = Math.max(1, Math.ceil((Number(total) || 0) / (Number(pageSize) || 1)));
  if (info) info.textContent = `P\u00e1gina ${page} de ${totalPages}`;
  if (prev) prev.disabled = page <= 1;
  if (next) next.disabled = page >= totalPages;
  if (sizeSelect && String(sizeSelect.value) !== String(pageSize)) {
    sizeSelect.value = String(pageSize);
  }
}

function changeComparativoPage(delta) {
  const nextPage = Math.max(1, comparativoPage + Number(delta || 0));
  if (nextPage === comparativoPage) return;
  comparativoPage = nextPage;
  loadComparativo(currentComparativoTipo, false);
}

function setComparativoPageSize(value) {
  const nextSize = Math.max(20, Math.min(200, Number(value) || 100));
  if (nextSize === comparativoPageSize) return;
  comparativoPageSize = nextSize;
  comparativoPage = 1;
  loadComparativo(currentComparativoTipo, true);
}

function renderComparativo(items, tipo, counts) {
  const tbody = document.getElementById('table-comparativo');
  if (!tbody) return;
  if (!items || items.length === 0) {
    const fcTotal = counts?.fcTotal || 0;
    const itauTotal = counts?.itauTotal || 0;
    const siegTotal = counts?.siegTotal || 0;
    if (fcTotal === 0 && (itauTotal > 0 || siegTotal > 0)) {
      tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Importe o Relat\u00f3rio FC para comparar com banco/SIEG.</td></tr>';
    } else {
      tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Nenhum dado importado</td></tr>';
    }
    return;
  }

  const renderCandidates = (candidates, label) => {
    if (!candidates || candidates.length === 0) return '';
    const rows = candidates.map(c => {
      const date = formatDate(c.data || c.dataEmissao || '');
      const value = formatCurrency(c.valor || 0);
      const ref = escapeHtml(c.numNfe || c.lancamento || c.razaoSocial || '');
      return `<div class="comp-muted">${date} | ${value} | ${ref}</div>`;
    }).join('');
    return `<details><summary>${label}</summary>${rows}</details>`;
  };

  const statusClass = (status) => {
    if (status === 'AUTO') return 'status-auto';
    if (status === 'PENDENTE') return 'status-pendente';
    if (status === 'SEM_MATCH') return 'status-sem-match';
    if (status === 'DUPLICADO') return 'status-duplicado';
    return 'status-pendente';
  };

  tbody.innerHTML = items.map(item => {
    const fc = item.fc || {};
    const nfe = item.nfe || null;
    const banco = item.banco || null;
    const diffs = item.diffs || {};

    const fcCell = `
      <div class="comp-cell">
        <strong>${escapeHtml(fc.numDocumento || '-') }</strong>
        <span>${escapeHtml(fc.fornecedor || fc.descricao || '')}</span>
        <span>${formatDate(fc.dataEmissao)}</span>
        <span>${formatCurrency(fc.valor || 0)}</span>
        <span class="comp-muted">${escapeHtml(fc.filialFc || '')}</span>
      </div>
    `;

    let nfeCell = '<div class="comp-muted">N/A</div>';
    if (tipo === 'PAGAR') {
      if (nfe) {
        nfeCell = `
          <div class="comp-cell">
            <strong>${escapeHtml(nfe.numNfe || '-') }</strong>
            <span class="${diffs.nfeData ? 'diff' : ''}">${formatDate(nfe.dataEmissao)}</span>
            <span class="${diffs.nfeValor ? 'diff' : ''}">${formatCurrency(nfe.valor || 0)}</span>
            <span class="comp-muted">${escapeHtml(nfe.cnpjEmit || '')}</span>
          </div>
        `;
      } else if (item.nfeMatches > 1) {
        nfeCell = `<div class="comp-muted">Duplicado (${item.nfeMatches})</div>${renderCandidates(item.nfeCandidates, 'Ver candidatos')}`;
      } else {
        nfeCell = '<div class="comp-muted">Sem match</div>';
      }
    }

    let bancoCell = '<div class="comp-muted">Sem match</div>';
    if (banco) {
      bancoCell = `
        <div class="comp-cell">
          <strong>${escapeHtml(banco.lancamento || '-') }</strong>
          <span class="${diffs.bancoData ? 'diff' : ''}">${formatDate(banco.data)}</span>
          <span class="${diffs.bancoValor ? 'diff' : ''}">${formatCurrency(banco.valor || 0)}</span>
          <span class="comp-muted">${escapeHtml(banco.conta || '')}</span>
        </div>
      `;
    } else if (item.bancoMatches > 1) {
      bancoCell = `<div class="comp-muted">Duplicado (${item.bancoMatches})</div>${renderCandidates(item.bancoCandidates, 'Ver candidatos')}`;
    }

    return `
      <tr>
        <td>${fcCell}</td>
        <td>${nfeCell}</td>
        <td>${bancoCell}</td>
        <td><span class="status-pill ${statusClass(item.status)}">${escapeHtml(item.status || '')}</span></td>
      </tr>
    `;
  }).join('');
}

function importarFc() {
  const tipo = document.getElementById('fc-tipo')?.value || 'PAGAR';
  const filialFc = document.getElementById('fc-filial')?.value || '';
  const fileInput = document.getElementById('fc-file');
  const sheetInput = document.getElementById('fc-sheet');
  const sheetValue = sheetInput ? String(sheetInput.value || '').trim() : '';
  const fileName = fileInput && fileInput.files && fileInput.files[0] ? fileInput.files[0].name : '';
  const detail = sheetValue ? `Planilha: ${sheetValue}` : `Arquivo: ${fileName || 'N/A'}`;
  openConfirmModal({ title: `Importar Relat\u00f3rio FC (${tipo})`, message: detail }).then(ok => {
    if (!ok) return;
    readRowsFromSource('fc-file', 'fc-sheet').then(rows => {
      if (!rows) return;
      const mapped = mapRowsByHeader(rows, fcHeaderMap());
      if (!mapped.length) {
        showToast('Nenhuma linha valida para importar', 'warning');
        return;
      }
      showLoading('Importando FC...');
      window.gasRun
        .withSuccessHandler(function(result) {
          hideLoading();
          if (result && result.success) {
            showToast(result.message || 'Importacao FC concluida', 'success');
            clearImportInputs('fc');
            loadComparativo(tipo);
          } else {
            showToast(result?.message || 'Erro ao importar FC', 'error');
          }
        })
        .withFailureHandler(handleError)
        .importarFc(mapped, { tipo, filialFc });
    });
  });
}

function importarItau() {
  const filialFc = document.getElementById('itau-filial')?.value || '';
  const conta = document.getElementById('itau-conta')?.value || '';
  const fileInput = document.getElementById('itau-file');
  const sheetInput = document.getElementById('itau-sheet');
  const sheetValue = sheetInput ? String(sheetInput.value || '').trim() : '';
  const fileName = fileInput && fileInput.files && fileInput.files[0] ? fileInput.files[0].name : '';
  const detail = sheetValue ? `Planilha: ${sheetValue}` : `Arquivo: ${fileName || 'N/A'}`;
  openConfirmModal({ title: 'Importar Itau', message: detail }).then(ok => {
    if (!ok) return;
    readRowsFromSource('itau-file', 'itau-sheet').then(rows => {
      if (!rows) return;
      const modelo = detectItauModel(rows) || 'A';
      const mapped = mapRowsByHeader(rows, itauHeaderMap(modelo));
      if (!mapped.length) {
        showToast('Nenhuma linha valida para importar', 'warning');
        return;
      }
      showLoading('Importando Itau...');
      window.gasRun
        .withSuccessHandler(function(result) {
          hideLoading();
          if (result && result.success) {
            showToast(result.message || 'Importacao Itau concluida', 'success');
            clearImportInputs('itau');
            loadComparativo(currentComparativoTipo);
          } else {
            showToast(result?.message || 'Erro ao importar Itau', 'error');
          }
        })
        .withFailureHandler(handleError)
        .importarItau(mapped, { modelo, filialFc, conta });
    });
  });
}

function importarSieg() {
  const fileInput = document.getElementById('sieg-file');
  const sheetInput = document.getElementById('sieg-sheet');
  let filialFc = document.getElementById('sieg-filial')?.value || '';
  const sheetValue = sheetInput ? String(sheetInput.value || '').trim() : '';
  const fileName = fileInput && fileInput.files && fileInput.files[0] ? fileInput.files[0].name : '';
  const detail = sheetValue ? `Planilha: ${sheetValue}` : `Arquivo: ${fileName || 'N/A'}`;
  openConfirmModal({ title: 'Importar SIEG', message: detail }).then(ok => {
    if (!ok) return;
    if (!filialFc && fileName) {
      filialFc = inferFilialFcFromFilename(fileName);
    }
    readRowsFromSource('sieg-file', 'sieg-sheet').then(rows => {
      if (!rows) return;
      const mapped = mapRowsByHeader(rows, siegHeaderMap());
      if (!mapped.length) {
        showToast('Nenhuma linha valida para importar', 'warning');
        return;
      }
      showLoading('Importando SIEG...');
      window.gasRun
        .withSuccessHandler(function(result) {
          hideLoading();
          if (result && result.success) {
            showToast(result.message || 'Importacao SIEG concluida', 'success');
            clearImportInputs('sieg');
            loadComparativo('PAGAR');
          } else {
            showToast(result?.message || 'Erro ao importar SIEG', 'error');
          }
        })
        .withFailureHandler(handleError)
        .importarSieg(mapped, { filialFc });
    });
  });
}

function readRowsFromSource(fileInputId, sheetInputId) {
  const fileInput = document.getElementById(fileInputId);
  const sheetInput = document.getElementById(sheetInputId);
  const sheetValue = sheetInput ? String(sheetInput.value || '').trim() : '';
  if (sheetValue) {
    return fetchSheetData(sheetValue);
  }
  const file = fileInput && fileInput.files ? fileInput.files[0] : null;
  if (!file) {
    showToast('Selecione um arquivo ou informe uma planilha', 'warning');
    return Promise.resolve(null);
  }
  return readFileRows(file);
}

function fetchSheetData(sheetIdOrUrl) {
  return new Promise(resolve => {
    showLoading('Lendo planilha...');
    window.gasRun
      .withSuccessHandler(function(result) {
        hideLoading();
        if (!result || !result.success) {
          showToast(result?.message || 'Erro ao ler planilha', 'error');
          resolve(null);
          return;
        }
        if (result.truncated && result.message) {
          showToast(result.message, 'warning');
        }
        resolve(result.values || []);
      })
      .withFailureHandler(function(error) {
        hideLoading();
        handleError(error);
        resolve(null);
      })
      .getSheetData(sheetIdOrUrl);
  });
}

function readFileRows(file) {
  const ext = String(file.name || '').split('.').pop().toLowerCase();
  if (ext === 'csv') {
    return new Promise(resolve => {
      Papa.parse(file, {
        skipEmptyLines: true,
        complete: function(results) {
          resolve(results.data || []);
        },
        error: function() {
          showToast('Erro ao ler CSV', 'error');
          resolve(null);
        }
      });
    });
  }
  if (ext === 'xlsx') {
    return new Promise(resolve => {
      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];
        const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, raw: false });
        resolve(rows || []);
      };
      reader.onerror = function() {
        showToast('Erro ao ler XLSX', 'error');
        resolve(null);
      };
      reader.readAsArrayBuffer(file);
    });
  }
  showToast('Formato de arquivo nao suportado', 'warning');
  return Promise.resolve(null);
}

function normalizeHeader(value) {
  return String(value || '')
    .trim()
    .toLowerCase()
    .normalize('NFD')
    .replace(/[̀-ͯ]/g, '')
    .replace(/[^a-z0-9]/g, '');
}

function getHeaderScore(rows, headerMap) {
  const maxScan = Math.min(rows.length, 30);
  let headerRowIndex = 0;
  let bestScore = -1;

  const aliasMap = {};
  Object.keys(headerMap).forEach(key => {
    aliasMap[key] = headerMap[key].map(normalizeHeader);
  });

  for (let i = 0; i < maxScan; i++) {
    const row = rows[i] || [];
    const normalized = row.map(normalizeHeader);
    let score = 0;
    Object.keys(aliasMap).forEach(key => {
      if (normalized.some(h => aliasMap[key].includes(h))) score++;
    });
    if (score > bestScore) {
      bestScore = score;
      headerRowIndex = i;
    }
  }

  return { score: bestScore, headerRowIndex, aliasMap };
}

function mapRowsByHeader(rows, headerMap) {
  if (!rows || rows.length === 0) return [];
  const { aliasMap, headerRowIndex } = getHeaderScore(rows, headerMap);
  const headerRow = (rows[headerRowIndex] || []).map(normalizeHeader);
  const indexMap = {};
  Object.keys(aliasMap).forEach(key => {
    indexMap[key] = headerRow.findIndex(h => aliasMap[key].includes(h));
  });

  return rows.slice(headerRowIndex + 1).map(r => {
    const obj = {};
    Object.keys(indexMap).forEach(key => {
      const idx = indexMap[key];
      obj[key] = idx >= 0 ? r[idx] : '';
    });
    return obj;
  }).filter(r => Object.values(r).some(v => String(v || '').trim() !== ''));
}

function clearImportInputs(prefix) {
  const fileInput = document.getElementById(`${prefix}-file`);
  const sheetInput = document.getElementById(`${prefix}-sheet`);
  if (fileInput) fileInput.value = '';
  if (sheetInput) sheetInput.value = '';
}

function fcHeaderMap() {
  return {
    dataEmissao: ['data emissao', 'dataemissao', 'data emiss?o', 'dataemissao'],
    numDocumento: ['n documento', 'num documento', 'numero documento', 'n? documento', 'n?documento', 'documento'],
    codConta: ['cod conta', 'codconta', 'codigo conta'],
    filialFc: ['filial fc', 'filialfc', 'filial'],
    historico: ['historico', 'hist?rico'],
    fornecedor: ['fornecedor'],
    valor: ['valor'],
    descricao: ['descricao', 'descri\u00e7\u00e3o'],
    dataBaixa: ['dt_baixa', 'data baixa', 'dt baixa'],
    flagBaixa: ['flagbxa', 'flag baixa', 'flag bxa'],
    dataVencimento: ['dt_vencimento', 'data vencimento', 'dt vencimento'],
  };
}

function itauHeaderMap(modelo) {
  if (String(modelo || 'A').toUpperCase() === 'B') {
    return {
      data: ['data'],
      lancamento: ['lancamento', 'lan?amento'],
      razaoSocial: ['razao social', 'raz?o social'],
      cpfCnpj: ['cpf/cnpj', 'cpf cnpj'],
      valor: ['valor', 'valor r$', 'valor (r$)'],
      saldo: ['saldo', 'saldo r$', 'saldo (r$)'],
    };
  }
  return {
    data: ['data'],
    lancamento: ['lancamento', 'lan?amento'],
    agenciaOrigem: ['ag/origem', 'agencia origem', 'agencia/origem', 'ag/origem'],
    valor: ['valor', 'valor r$', 'valor (r$)'],
    saldo: ['saldo', 'saldo r$', 'saldo (r$)'],
  };
}

function detectItauModel(rows) {
  if (!rows || rows.length === 0) return '';
  const scoreA = getHeaderScore(rows, itauHeaderMap('A')).score;
  const scoreB = getHeaderScore(rows, itauHeaderMap('B')).score;
  if (scoreA <= 0 && scoreB <= 0) return '';
  return scoreB > scoreA ? 'B' : 'A';
}

function siegHeaderMap() {
  return {
    numNfe: ['num nfe', 'nfe', 'numero nfe', 'num nf-e'],
    valor: ['valor'],
    dataEmissao: ['data emissao'],
    cnpjEmit: ['cnpj emit'],
    nomeFantEmit: ['nome fant emit', 'nome fantasia emit'],
    razaoEmit: ['razao soc emit', 'razao social emit'],
    cnpjDest: ['cnpj dest'],
    nomeFantDest: ['nome fant dest', 'nome fantasia dest'],
    razaoDest: ['razao soc dest', 'razao social dest'],
    dataEnvioCofre: ['data de envio ao cofre', 'data envio cofre'],
    chaveNfe: ['chave da nfe', 'chave nfe'],
    tags: ['tags'],
    codigoEvento: ['codigo do evento', 'codigo evento'],
    tipoEvento: ['tipo do evento', 'tipo evento'],
    status: ['status'],
    danfe: ['danfe'],
    xml: ['xml'],
    codigoFilial: ['codigo_filial', 'codigo filial', 'cod filial'],
  };
}

function inferFilialFcFromFilename(fileName) {
  const key = normalizeHeader(fileName);
  if (!key) return '';
  const filiais = appData.filiais || [];
  for (const filial of filiais) {
    const relKey1 = normalizeHeader(filial.siegRelatorio || '');
    const relKey2 = normalizeHeader(filial.siegContabilidade || '');
    if ((relKey1 && key.includes(relKey1)) || (relKey2 && key.includes(relKey2))) {
      return String(filial.codigo || '');
    }
  }
  return '';
}

// ============================================================================
// CAIXAS
// ============================================================================

function loadCaixasData() {
  showLoading('Carregando caixas...');
  window.gasRun
    .withSuccessHandler(function(data) {
      hideLoading();
      if (!data || !data.success) {
        showToast(data?.message || 'Erro ao carregar caixas', 'error');
        return;
      }
      caixasState.caixas = data.caixas || [];
      caixasState.movimentos = data.movimentos || [];
      populateCaixaCanais();
      renderCaixas();
      populateCaixasSelects();
      populateMovTypes();
      updateMovTipoHint(document.getElementById('mov-tipo')?.value || '');
      initCaixaDropzone();
      const today = getDefaultCaixaDate();
      const caixaData = document.getElementById('caixa-data');
      if (caixaData && !caixaData.value) caixaData.value = today;
      if (caixasState.selectedId) {
        selectCaixa(caixasState.selectedId);
      } else {
        updateResumo(null);
      }
    })
    .withFailureHandler(handleError)
    .getCaixasData();
}

function getActiveCaixaTipos() {
  const tipos = (appData.caixaTipos || []).filter(t => t.ativo !== false);
  if (!tipos.length) {
    return defaultCaixaTipos.map(t => ({
      tipo: t.tipo,
      natureza: t.natureza,
      requerArquivo: t.requerArquivo,
      sistemaFc: t.sistemaFc,
      contaReforco: t.contaReforco,
      ativo: true
    }));
  }
  return tipos;
}

function getCaixaTipoConfig(tipo) {
  const key = String(tipo || '').trim().toUpperCase();
  return getActiveCaixaTipos().find(t => String(t.tipo).trim().toUpperCase() === key) || null;
}

function getOrderedCaixaTipos() {
  const tipos = getActiveCaixaTipos();
  const map = new Map();
  tipos.forEach(t => {
    const key = String(t.tipo || '').trim().toUpperCase();
    if (key && !map.has(key)) map.set(key, t);
  });
  const ordered = [];
  defaultMovTypes.forEach(name => {
    const key = String(name || '').trim().toUpperCase();
    if (map.has(key)) ordered.push(map.get(key));
  });
  map.forEach((value, key) => {
    if (!defaultMovTypes.some(t => String(t).trim().toUpperCase() === key)) {
      ordered.push(value);
    }
  });
  return ordered;
}

function getMovTotalByType(movimentos, tipo) {
  const key = String(tipo || '').trim().toUpperCase();
  if (!key) return 0;
  return movimentos
    .filter(m => String(m.tipo || '').trim().toUpperCase() === key)
    .reduce((sum, m) => sum + Number(m.valor || 0), 0);
}

function getReportRows(resumo, movimentos) {
  return [
    { label: 'Reforco do caixa (saldo inicial do dia)', typeName: 'Reforco do Caixa', value: getMovTotalByType(movimentos, 'Reforco do Caixa'), type: 'mov' },
    { label: 'Cartao de Credito / Laranjinha', typeName: 'Cartao de Credito', value: getMovTotalByType(movimentos, 'Cartao de Credito'), type: 'mov' },
    { label: 'Deposito / Pix', typeName: 'Depositos', value: getMovTotalByType(movimentos, 'Depositos'), type: 'mov' },
    { label: 'Dinheiro', typeName: 'Dinheiro', value: getMovTotalByType(movimentos, 'Dinheiro'), type: 'mov' },
    { label: 'Link', typeName: 'Link', value: getMovTotalByType(movimentos, 'Link'), type: 'mov' },
    { label: 'Deposito Caixa', typeName: 'Deposito Caixa', value: getMovTotalByType(movimentos, 'Deposito Caixa'), type: 'mov' },
    { label: 'Outras entradas', typeName: 'Outras Entradas', value: getMovTotalByType(movimentos, 'Outras Entradas'), type: 'mov' },
    { label: 'Outras saidas', typeName: 'Outras Saidas', value: getMovTotalByType(movimentos, 'Outras Saidas'), type: 'mov' },
    { label: 'Saldo final do caixa', value: resumo.totalRecebido, type: 'resumo' },
    { label: 'Formula Certa', value: resumo.sistemaFc, type: 'resumo' },
    { label: 'Diferenca', value: resumo.diferenca, type: 'resumo' },
    { label: 'Dinheiro em cofre', typeName: 'Dinheiro Cofre', value: getMovTotalByType(movimentos, 'Dinheiro Cofre'), type: 'mov' },
    { label: 'Dinheiro do caixa', typeName: 'Dinheiro Caixa', value: getMovTotalByType(movimentos, 'Dinheiro Caixa'), type: 'mov' },
    { label: 'Moeda', typeName: 'Moedas', value: getMovTotalByType(movimentos, 'Moedas'), type: 'mov' },
    { label: 'Reforco para o dia seguinte (Dinheiro+Moeda+Cofre)', value: resumo.reforco, type: 'resumo' },
  ];
}

function populateMovTypes() {
  const select = document.getElementById('mov-tipo');
  if (!select) return;
  const options = ['<option value=\"\">Selecionar...</option>'];
  getOrderedCaixaTipos().forEach(t => {
    options.push(`<option value="${escapeHtml(t.tipo)}">${escapeHtml(t.tipo)}</option>`);
  });
  select.innerHTML = options.join('');
  select.onchange = function() {
    updateMovTipoHint(this.value);
  };
}

function updateMovTipoHint(tipo) {
  const config = getCaixaTipoConfig(tipo);
  const natureza = document.getElementById('mov-natureza');
  const hint = document.getElementById('mov-file-hint');
  const fileInput = document.getElementById('mov-file');
  if (natureza && config && config.natureza) {
    natureza.value = config.natureza;
    natureza.disabled = true;
  } else if (natureza) {
    natureza.disabled = false;
  }
  if (hint) {
    hint.textContent = config?.requerArquivo ? 'Comprovante obrigatorio para este tipo.' : '';
  }
  if (fileInput && !config?.requerArquivo) {
    fileInput.value = '';
    const nameEl = document.getElementById('mov-file-name');
    if (nameEl) nameEl.textContent = 'Nenhum arquivo selecionado';
  }
}

function initCaixaDropzone() {
  const drop = document.getElementById('mov-file-drop');
  const input = document.getElementById('mov-file');
  const nameEl = document.getElementById('mov-file-name');
  if (!drop || !input || !nameEl) return;

  const updateName = (file) => {
    nameEl.textContent = file ? file.name : 'Nenhum arquivo selecionado';
  };

  drop.onclick = () => input.click();
  drop.ondragover = (e) => {
    e.preventDefault();
    drop.classList.add('drag');
  };
  drop.ondragleave = () => {
    drop.classList.remove('drag');
  };
  drop.ondrop = (e) => {
    e.preventDefault();
    drop.classList.remove('drag');
    const file = e.dataTransfer.files && e.dataTransfer.files[0];
    if (!file) return;
    const dt = new DataTransfer();
    dt.items.add(file);
    input.files = dt.files;
    updateName(file);
  };
  input.onchange = () => {
    const file = input.files && input.files[0];
    updateName(file);
  };
}

function populateCaixaCanais() {
  const select = document.getElementById('caixa-canal');
  if (!select) return;
  const options = ['<option value="">Selecionar...</option>'];
  (appData.canais || []).forEach(c => {
    options.push(`<option value="${escapeHtml(c.codigo)}">${escapeHtml(c.nome)}</option>`);
  });
  select.innerHTML = options.join('');
}

function populateCaixasSelects() {
  const selects = ['mov-caixa-select', 'upload-caixa-select', 'relatorio-caixa-select', 'caixa-fechar-select'];
  selects.forEach(id => {
    const select = document.getElementById(id);
    if (!select) return;
    const options = ['<option value="">Selecionar...</option>'];
    caixasState.caixas.forEach(c => {
      const label = `${c.canal} - ${formatDate(c.dataFechamento)}`;
      options.push(`<option value="${escapeHtml(c.id)}">${escapeHtml(label)}</option>`);
    });
    select.innerHTML = options.join('');
    if (caixasState.selectedId) select.value = caixasState.selectedId;
    select.onchange = function() {
      if (this.value) selectCaixa(this.value);
    };
  });
}

function renderCaixas() {
  const tbody = document.getElementById('table-caixas');
  if (!tbody) return;
  if (!caixasState.caixas.length) {
    tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Nenhum caixa cadastrado</td></tr>';
    return;
  }

  tbody.innerHTML = caixasState.caixas.map(c => {
    const resumo = computeResumoForCaixa(c.id);
    return `
      <tr>
        <td>${escapeHtml(c.canal)}</td>
        <td>${escapeHtml(c.colaborador || '-')}</td>
        <td>${formatDate(c.dataFechamento)}</td>
        <td>${formatCurrency(resumo.totalRecebido)}</td>
        <td>${formatCurrency(resumo.sistemaFc)}</td>
        <td>${formatCurrency(resumo.diferenca)}</td>
        <td>
          <button class="btn btn-sm btn-secondary" onclick="editarCaixa('${escapeHtml(c.id)}')">Editar</button>
          <button class="btn btn-sm btn-outline" onclick="abrirMovimentos('${escapeHtml(c.id)}')">Movimentos</button>
          <button class="btn btn-sm btn-danger" onclick="excluirCaixaUi('${escapeHtml(c.id)}')">Excluir</button>
        </td>
      </tr>
    `;
  }).join('');
}

function computeResumoForCaixa(caixaId) {
  const movimentos = caixasState.movimentos.filter(m => m.caixaId === caixaId);
  const tipos = getActiveCaixaTipos();
  const tipoMap = new Map(tipos.map(t => [String(t.tipo).trim().toUpperCase(), t]));
  let totalEntradas = 0;
  let totalSaidas = 0;
  let sistemaFc = 0;
  let reforco = 0;
  const pendencias = [];

  movimentos.forEach(m => {
    const config = tipoMap.get(String(m.tipo || '').trim().toUpperCase());
    const valor = Number(m.valor || 0);
    const natureza = String(m.natureza || '').toUpperCase();
    if (config && config.sistemaFc) {
      sistemaFc += valor;
    } else if (natureza === 'SAIDA') {
      totalSaidas += valor;
    } else {
      totalEntradas += valor;
    }
    if (config && config.contaReforco && natureza !== 'SAIDA') {
      reforco += valor;
    }
    if (config && config.requerArquivo && !m.arquivoUrl) {
      pendencias.push(m.tipo);
    }
  });

  const totalRecebido = totalEntradas - totalSaidas;
  const diferenca = totalRecebido - sistemaFc;
  return { totalEntradas, totalSaidas, totalRecebido, sistemaFc, diferenca, reforco, pendencias };
}

function updateResumo(caixaId) {
  const pendenciasEl = document.getElementById('caixa-pendencias');
  const resumoRowsEl = document.getElementById('resumo-rows');
  if (!pendenciasEl || !resumoRowsEl) return;
  const hasCaixa = Boolean(caixaId);
  const resumo = hasCaixa ? computeResumoForCaixa(caixaId) : {
    totalRecebido: 0,
    sistemaFc: 0,
    diferenca: 0,
    reforco: 0,
    pendencias: []
  };
  if (resumo.pendencias.length) {
    pendenciasEl.textContent = `Comprovantes pendentes: ${resumo.pendencias.join(', ')}`;
  } else {
    pendenciasEl.textContent = '';
  }

  if (!hasCaixa) {
    resumoRowsEl.innerHTML = '<tr><td colspan="2" class="text-center text-muted">Selecione um caixa</td></tr>';
    updateElement('resumo-colaborador', '-');
    updateElement('resumo-data', '-');
    updateElement('resumo-loja', '-');
    return;
  }

  const movimentos = hasCaixa ? caixasState.movimentos.filter(m => m.caixaId === caixaId) : [];
  const rows = getReportRows(resumo, movimentos);
  const getRowClass = (label) => {
    if (label === 'Formula Certa') return 'row-sistema';
    if (label === 'Diferenca') return 'row-diff';
    if (label === 'Saldo final do caixa') return 'row-total';
    if (label.startsWith('Reforco para o dia seguinte')) return 'row-reforco';
    return '';
  };

  resumoRowsEl.innerHTML = rows.map(row => `
    <tr class="${getRowClass(row.label)}">
      <td>${escapeHtml(row.label)}</td>
      <td class="caixa-report-value">${formatCurrency(row.value || 0)}</td>
    </tr>
  `).join('');

  const caixa = caixasState.caixas.find(c => c.id === caixaId);
  const canalInfo = caixa ? (appData.canais || []).find(c => c.codigo === caixa.canal) : null;
  const canalNome = canalInfo ? canalInfo.nome : (caixa?.canal || '-');
  const logoEl = document.querySelector('.logo');
  const logoUrl = (logoEl && logoEl.getAttribute('src')) ||
    'https://neoformula.com.br/cdn/shop/files/Logotipo-NeoFormula-Manipulacao-Homeopatia_76b2fa98-5ffa-4cc3-ac0a-6d41e1bc8810.png?height=200&v=1677088468';
  const logoImg = document.getElementById('resumo-logo-img');
  if (logoImg) logoImg.setAttribute('src', logoUrl);
  updateElement('resumo-colaborador', caixa?.colaborador || '-');
  updateElement('resumo-data', caixa ? formatDate(caixa.dataFechamento) : '-');
  updateElement('resumo-loja', canalNome || '-');
}

function resetCaixaForm() {
  document.getElementById('caixa-id').value = '';
  document.getElementById('caixa-canal').value = '';
  document.getElementById('caixa-colaborador').value = '';
  document.getElementById('caixa-data').value = getDefaultCaixaDate();
  document.getElementById('caixa-observacoes-entradas').value = '';
  document.getElementById('caixa-observacoes-saidas').value = '';
  document.getElementById('caixa-ci').value = '';
  updateResumo(null);
}

function salvarCaixaUi() {
  let id = document.getElementById('caixa-id').value;
  if (!id && caixasState.selectedId) id = caixasState.selectedId;
  if (!id) {
    const selectFechar = document.getElementById('caixa-fechar-select');
    if (selectFechar && selectFechar.value) id = selectFechar.value;
  }
  const canal = document.getElementById('caixa-canal').value;
  const colaborador = document.getElementById('caixa-colaborador').value;
  const dataFechamento = document.getElementById('caixa-data').value;
  const observacoesEntradas = document.getElementById('caixa-observacoes-entradas').value;
  const observacoesSaidas = document.getElementById('caixa-observacoes-saidas').value;
  const comunicadoInterno = document.getElementById('caixa-ci').value;
  const resumo = computeResumoForCaixa(id);

  if (!id) {
    openInfoModal({ title: 'Caixa nao selecionado', message: 'Selecione o caixa para fechar.' });
    return;
  }
  const missing = [];
  if (!String(canal || '').trim()) missing.push('Canal');
  if (!String(colaborador || '').trim()) missing.push('Colaborador');
  if (!String(dataFechamento || '').trim()) missing.push('Data Fechamento');
  if (missing.length) {
    openInfoModal({
      title: 'Campos obrigatorios',
      message: `<div>Preencha os campos abaixo:</div><ul>${missing.map(m => `<li>${escapeHtml(m)}</li>`).join('')}</ul>`
    });
    return;
  }
  if (isSunday(dataFechamento)) {
    openInfoModal({ title: 'Data invalida', message: 'Fechamento nao permitido aos domingos.' });
    return;
  }
  if (resumo.pendencias.length) {
    openInfoModal({ title: 'Comprovantes pendentes', message: 'Existem movimentacoes sem comprovante.' });
    return;
  }
  if (Math.abs(resumo.diferenca) > 0.009 && !String(comunicadoInterno || '').trim()) {
    openInfoModal({ title: 'Comunicado Interno obrigatorio', message: 'Informe o Comunicado Interno (CI) quando houver diferenca.' });
    return;
  }

  showLoading('Fechando caixa...');
  window.gasRun
    .withSuccessHandler(function(result) {
      hideLoading();
      if (result && result.success) {
        showToast(result.message || 'Caixa salvo', 'success');
        resetCaixaForm();
        loadCaixasData();
      } else {
        showToast(result?.message || 'Erro ao salvar caixa', 'error');
      }
    })
    .withFailureHandler(handleError)
    .salvarCaixa({
      id: id || undefined,
      canal,
      colaborador,
      dataFechamento,
      observacoesEntradas,
      observacoesSaidas,
      comunicadoInterno,
      finalizar: true
    });
}

function salvarCabecalhoUi() {
  const id = document.getElementById('caixa-id').value;
  const canal = document.getElementById('caixa-canal').value;
  const colaborador = document.getElementById('caixa-colaborador').value;
  const dataFechamento = document.getElementById('caixa-data').value;
  const observacoesEntradas = document.getElementById('caixa-observacoes-entradas').value;
  const observacoesSaidas = document.getElementById('caixa-observacoes-saidas').value;
  const comunicadoInterno = document.getElementById('caixa-ci').value;

  const missing = [];
  if (!String(canal || '').trim()) missing.push('Canal');
  if (!String(colaborador || '').trim()) missing.push('Colaborador');
  if (!String(dataFechamento || '').trim()) missing.push('Data Fechamento');
  if (missing.length) {
    openInfoModal({
      title: 'Campos obrigatorios',
      message: `<div>Preencha os campos abaixo:</div><ul>${missing.map(m => `<li>${escapeHtml(m)}</li>`).join('')}</ul>`
    });
    return;
  }
  if (isSunday(dataFechamento)) {
    openInfoModal({ title: 'Data invalida', message: 'Fechamento nao permitido aos domingos.' });
    return;
  }

  const duplicate = caixasState.caixas.find(c => {
    if (id && c.id === id) return false;
    return String(c.canal) === String(canal) && String(c.dataFechamento) === String(dataFechamento);
  });
  if (duplicate) {
    openInfoModal({ title: 'Caixa duplicado', message: 'Ja existe um fechamento para este canal e data.' });
    return;
  }

  openConfirmModal({
    title: 'Salvar Dados do Fechamento',
    message: `Confirmar salvamento do caixa ${escapeHtml(canal || '')} em ${formatDate(dataFechamento)}?`
  }).then(ok => {
    if (!ok) return;
    showLoading('Salvando dados...');
    window.gasRun
      .withSuccessHandler(function(result) {
        hideLoading();
        if (result && result.success) {
          showToast(result.message || 'Caixa salvo', 'success');
          if (result.id) caixasState.selectedId = result.id;
          document.getElementById('caixa-data').value = dataFechamento;
          loadCaixasData();
        } else {
          showToast(result?.message || 'Erro ao salvar caixa', 'error');
        }
      })
      .withFailureHandler(handleError)
      .salvarCaixa({
        id: id || undefined,
        canal,
        colaborador,
        dataFechamento,
        observacoesEntradas,
        observacoesSaidas,
        comunicadoInterno,
        finalizar: false
      });
  });
}

function editarCaixa(id) {
  const caixa = caixasState.caixas.find(c => c.id === id);
  if (!caixa) return;
  document.getElementById('caixa-id').value = caixa.id;
  document.getElementById('caixa-canal').value = caixa.canal;
  document.getElementById('caixa-colaborador').value = caixa.colaborador || '';
  document.getElementById('caixa-data').value = caixa.dataFechamento || '';
  const obsEnt = document.getElementById('caixa-observacoes-entradas');
  const obsSai = document.getElementById('caixa-observacoes-saidas');
  const ci = document.getElementById('caixa-ci');
  if (obsEnt) obsEnt.value = caixa.observacoesEntradas || '';
  if (obsSai) obsSai.value = caixa.observacoesSaidas || '';
  if (ci) ci.value = caixa.comunicadoInterno || '';
  selectCaixa(caixa.id);
}

function excluirCaixaUi(id) {
  openConfirmModal({ title: 'Excluir Caixa', message: 'Deseja excluir este caixa?' }).then(ok => {
    if (!ok) return;
    showLoading('Excluindo caixa...');
    window.gasRun
      .withSuccessHandler(function(result) {
        hideLoading();
        if (result && result.success) {
          showToast(result.message || 'Caixa excluido', 'success');
          loadCaixasData();
        } else {
          showToast(result?.message || 'Erro ao excluir caixa', 'error');
        }
      })
      .withFailureHandler(handleError)
      .excluirCaixa(id);
  });
}

function selectCaixa(id) {
  caixasState.selectedId = id;
  populateCaixasSelects();
  renderMovimentos(id);
  updateResumo(id);
  const caixa = caixasState.caixas.find(c => c.id === id);
  if (caixa) {
    const fecharSelect = document.getElementById('caixa-fechar-select');
    if (fecharSelect) fecharSelect.value = id;
    const idEl = document.getElementById('caixa-id');
    if (idEl) idEl.value = id;
    const canalEl = document.getElementById('caixa-canal');
    if (canalEl) canalEl.value = caixa.canal || '';
    const colabEl = document.getElementById('caixa-colaborador');
    if (colabEl) colabEl.value = caixa.colaborador || '';
    const dataEl = document.getElementById('caixa-data');
    if (dataEl) dataEl.value = caixa.dataFechamento || '';
    const obsEnt = document.getElementById('caixa-observacoes-entradas');
    const obsSai = document.getElementById('caixa-observacoes-saidas');
    const ci = document.getElementById('caixa-ci');
    if (obsEnt) obsEnt.value = caixa.observacoesEntradas || '';
    if (obsSai) obsSai.value = caixa.observacoesSaidas || '';
    if (ci) ci.value = caixa.comunicadoInterno || '';
  }
}

function abrirMovimentos(id) {
  selectCaixa(id);
  const section = document.getElementById('caixa-movimentos');
  if (section) {
    section.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
}

function renderMovimentos(caixaId) {
  const tbody = document.getElementById('table-movimentos');
  if (!tbody) return;
  const movimentos = caixasState.movimentos.filter(m => m.caixaId === caixaId);
  if (!movimentos.length) {
    tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Nenhuma movimentacao registrada</td></tr>';
    return;
  }
  tbody.innerHTML = movimentos.map(m => `
    <tr>
      <td>${escapeHtml(m.tipo)}</td>
      <td>${escapeHtml(m.natureza)}</td>
      <td>${formatCurrency(m.valor || 0)}</td>
      <td>${escapeHtml(m.observacoes || '-')}</td>
      <td>${m.arquivoUrl ? `<a href="${escapeHtml(m.arquivoUrl)}" target="_blank">Ver</a>` : '-'}</td>
      <td>${(() => {
        const cfg = getCaixaTipoConfig(m.tipo);
        if (cfg && cfg.requerArquivo && !m.arquivoUrl) return '<span class="badge badge-warning">Pendente</span>';
        return '<span class="badge badge-success">OK</span>';
      })()}</td>
      <td>
        <button class="btn btn-sm btn-secondary" onclick="editarMovimento('${escapeHtml(m.id)}')">Editar</button>
        <button class="btn btn-sm btn-danger" onclick="excluirMovimentoUi('${escapeHtml(m.id)}')">Excluir</button>
      </td>
    </tr>
  `).join('');
}

function salvarMovimentoUi() {
  const id = document.getElementById('mov-id').value;
  const caixaId = document.getElementById('mov-caixa-select').value;
  const tipo = document.getElementById('mov-tipo').value;
  let natureza = document.getElementById('mov-natureza').value;
  const valor = document.getElementById('mov-valor').value;
  const observacoes = document.getElementById('mov-observacoes').value;
  const fileInput = document.getElementById('mov-file');
  const tipoConfig = getCaixaTipoConfig(tipo);
  const caixa = caixasState.caixas.find(c => c.id === caixaId);
  const dataMov = caixa ? caixa.dataFechamento : '';
  if (tipoConfig && tipoConfig.natureza) {
    natureza = tipoConfig.natureza;
  }

  if (!caixa) {
    openInfoModal({ title: 'Caixa nao selecionado', message: 'Selecione um caixa para registrar a movimentacao.' });
    return;
  }
  if (!tipo) {
    openInfoModal({ title: 'Tipo obrigatorio', message: 'Selecione o tipo de movimentacao.' });
    return;
  }
  if (!String(valor || '').trim()) {
    openInfoModal({ title: 'Valor obrigatorio', message: 'Informe o valor da movimentacao.' });
    return;
  }
  if (tipoConfig?.requerArquivo && (!fileInput || !fileInput.files || !fileInput.files[0]) && !id) {
    openInfoModal({ title: 'Comprovante obrigatorio', message: 'Envie o comprovante para este tipo de movimentacao.' });
    return;
  }

  showLoading('Salvando movimentacao...');

  const salvarMov = (arquivoUrl, arquivoNome) => {
    window.gasRun
      .withSuccessHandler(function(result) {
        hideLoading();
        if (result && result.success) {
          showToast(result.message || 'Movimentacao salva', 'success');
          document.getElementById('mov-id').value = '';
          document.getElementById('mov-valor').value = '';
          document.getElementById('mov-observacoes').value = '';
          if (fileInput) fileInput.value = '';
          const nameEl = document.getElementById('mov-file-name');
          if (nameEl) nameEl.textContent = 'Nenhum arquivo selecionado';
          caixasState.selectedId = caixaId;
          loadCaixasData();
        } else {
          showToast(result?.message || 'Erro ao salvar movimentacao', 'error');
        }
      })
      .withFailureHandler(handleError)
      .salvarCaixaMovimento({
        id: id || undefined,
        caixaId,
        tipo,
        natureza,
        valor,
        dataMov,
        observacoes,
        arquivoUrl,
        arquivoNome
      });
  };

  if (fileInput && fileInput.files && fileInput.files[0]) {
    const file = fileInput.files[0];
    readFileAsBase64(file).then(data => {
      if (!data) {
        hideLoading();
        showToast('Falha ao ler arquivo', 'error');
        return;
      }
      window.gasRun
        .withSuccessHandler(function(result) {
          if (result && result.success) {
            salvarMov(result.url || '', file.name);
          } else {
            hideLoading();
            showToast(result?.message || 'Erro ao enviar arquivo', 'error');
          }
        })
        .withFailureHandler(handleError)
        .uploadCaixaArquivo({
          base64: data.base64,
          mimeType: data.mimeType,
          fileName: file.name,
          canal: caixa.canal,
          dataFechamento: caixa.dataFechamento,
          tipo,
          valor
        });
    });
  } else {
    salvarMov('', '');
  }
}

function editarMovimento(id) {
  const mov = caixasState.movimentos.find(m => m.id === id);
  if (!mov) return;
  document.getElementById('mov-id').value = mov.id;
  document.getElementById('mov-caixa-select').value = mov.caixaId;
  document.getElementById('mov-tipo').value = mov.tipo;
  document.getElementById('mov-natureza').value = mov.natureza || 'ENTRADA';
  document.getElementById('mov-valor').value = mov.valor || '';
  document.getElementById('mov-observacoes').value = mov.observacoes || '';
  updateMovTipoHint(mov.tipo);
  const hint = document.getElementById('mov-file-hint');
  if (hint && mov.arquivoUrl) {
    hint.innerHTML = `Comprovante atual: <a href="${escapeHtml(mov.arquivoUrl)}" target="_blank">abrir</a>`;
  }
  const fileInput = document.getElementById('mov-file');
  if (fileInput) fileInput.value = '';
}

function excluirMovimentoUi(id) {
  openConfirmModal({ title: 'Excluir Movimentacao', message: 'Deseja excluir esta movimentacao?' }).then(ok => {
    if (!ok) return;
    showLoading('Excluindo movimentacao...');
    window.gasRun
      .withSuccessHandler(function(result) {
        hideLoading();
        if (result && result.success) {
          showToast(result.message || 'Movimentacao excluida', 'success');
          loadCaixasData();
        } else {
          showToast(result?.message || 'Erro ao excluir movimentacao', 'error');
        }
      })
      .withFailureHandler(handleError)
      .excluirCaixaMovimento(id);
  });
}

function uploadCaixaArquivoUi() {
  const caixaId = document.getElementById('upload-caixa-select').value;
  const tipo = document.getElementById('upload-tipo').value;
  const valor = document.getElementById('upload-valor').value;
  const fileInput = document.getElementById('upload-file');
  const status = document.getElementById('upload-status');
  const caixa = caixasState.caixas.find(c => c.id === caixaId);
  if (!caixa) {
    showToast('Selecione um caixa', 'warning');
    return;
  }
  if (!fileInput || !fileInput.files || !fileInput.files[0]) {
    showToast('Selecione um arquivo', 'warning');
    return;
  }
  const file = fileInput.files[0];
  showLoading('Enviando arquivo...');
  readFileAsBase64(file).then(data => {
    if (!data) {
      hideLoading();
      showToast('Falha ao ler arquivo', 'error');
      return;
    }
    window.gasRun
      .withSuccessHandler(function(result) {
        hideLoading();
        if (result && result.success) {
          showToast('Upload concluido', 'success');
          if (status && result.url) status.innerHTML = `Arquivo salvo: <a href="${result.url}" target="_blank">abrir</a>`;
          fileInput.value = '';
        } else {
          showToast(result?.message || 'Erro ao enviar arquivo', 'error');
        }
      })
      .withFailureHandler(handleError)
      .uploadCaixaArquivo({
        base64: data.base64,
        mimeType: data.mimeType,
        fileName: file.name,
        canal: caixa.canal,
        dataFechamento: caixa.dataFechamento,
        tipo,
        valor
      });
  });
}

function readFileAsBase64(file) {
  return new Promise(resolve => {
    const reader = new FileReader();
    reader.onload = function(e) {
      const result = String(e.target.result || '');
      const parts = result.split(',');
      if (parts.length < 2) return resolve(null);
      resolve({ base64: parts[1], mimeType: file.type || '' });
    };
    reader.onerror = function() {
      resolve(null);
    };
    reader.readAsDataURL(file);
  });
}

function gerarRelatorioCaixa() {
  const caixaId = document.getElementById('relatorio-caixa-select').value;
  if (!caixaId) {
    showToast('Selecione um caixa', 'warning');
    return;
  }
  showLoading('Gerando relatorio...');
  window.gasRun
    .withSuccessHandler(function(result) {
      hideLoading();
      if (!result || !result.success) {
        showToast(result?.message || 'Erro ao gerar relatorio', 'error');
        return;
      }
      renderRelatorioCaixa(result.report);
    })
    .withFailureHandler(handleError)
    .getCaixaRelatorio(caixaId);
}

function renderRelatorioCaixa(report) {
  const container = document.getElementById('relatorio-caixa');
  if (!container) return;
  if (!report || !report.caixa) {
    container.innerHTML = '<div class="text-muted">Nenhum relatorio disponivel</div>';
    return;
  }
  const caixa = report.caixa;
  const canalInfo = (appData.canais || []).find(c => c.codigo === caixa.canal);
  const canalNome = canalInfo ? canalInfo.nome : (caixa.canal || '');
  const logoEl = document.querySelector('.logo');
  const logoUrl = (logoEl && logoEl.getAttribute('src')) ||
    'https://neoformula.com.br/cdn/shop/files/Logotipo-NeoFormula-Manipulacao-Homeopatia_76b2fa98-5ffa-4cc3-ac0a-6d41e1bc8810.png?height=200&v=1677088468';
  const porTipo = new Map();
  (report.porTipo || []).forEach(item => {
    porTipo.set(item.tipo, { entradas: Number(item.entradas || 0), saidas: Number(item.saidas || 0) });
  });

  const resumo = {
    totalRecebido: Number(report.totalRecebido || 0),
    sistemaFc: Number(report.sistemaFc || 0),
    diferenca: Number(report.diferenca || 0),
    reforco: Number(report.reforco || 0)
  };
  const movimentos = Array.isArray(report.movimentos) ? report.movimentos : [];
  const rows = getReportRows(resumo, movimentos).map(row => `
    <tr>
      <td>${escapeHtml(row.label)}</td>
      <td class="caixa-report-value">${formatCurrency(row.value || 0)}</td>
    </tr>
  `).join('');

  container.innerHTML = `
    <div class="caixa-report">
      <div class="caixa-report-header">
        <div class="caixa-report-logo">
          <img src="${escapeHtml(logoUrl)}" alt="Neoformula" />
        </div>
        <div class="caixa-report-title">
          <div class="caixa-report-title-text">FECHAMENTO DE CAIXA</div>
        </div>
        <div class="caixa-report-actions">
          <button class="btn btn-outline" onclick="printCaixaReport()">Impressao</button>
        </div>
      </div>

      <div class="caixa-report-meta">
        <div class="meta-row">
          <span class="label">Colaborador:</span>
          <span class="value">${escapeHtml(caixa.colaborador || '-')}</span>
        </div>
        <div class="meta-row">
          <span class="label">Data:</span>
          <span class="value">${formatDate(caixa.dataFechamento)}</span>
        </div>
        <div class="meta-row">
          <span class="label">Loja:</span>
          <span class="value">${escapeHtml(canalNome)}</span>
        </div>
      </div>

      <div class="caixa-report-table">
        <table>
          <thead>
            <tr>
              <th>Descricao</th>
              <th class="caixa-report-value">Valor</th>
            </tr>
          </thead>
          <tbody>
            ${rows}
          </tbody>
        </table>
      </div>

      <div class="caixa-report-observacoes">
        <div class="label">Observacoes / Outras Entradas:</div>
        <div class="value">${escapeHtml(caixa.observacoesEntradas || '')}</div>
      </div>
      <div class="caixa-report-observacoes">
        <div class="label">Observacoes / Outras Saidas:</div>
        <div class="value">${escapeHtml(caixa.observacoesSaidas || '')}</div>
      </div>
      <div class="caixa-report-observacoes">
        <div class="label">Comunicado Interno (CI):</div>
        <div class="value">${escapeHtml(caixa.comunicadoInterno || '')}</div>
      </div>
    </div>
  `;
}

function printCaixaReport() {
  const container = document.getElementById('relatorio-caixa');
  if (!container) return;
  const styles = document.getElementById('caixa-report-styles');
  const win = window.open('', '_blank');
  if (!win) return;
  win.document.write(`
    <!doctype html>
    <html>
      <head>
        <meta charset="utf-8" />
        <title>Relat\u00f3rio de Caixa</title>
        <style>${styles ? styles.textContent : ''}</style>
      </head>
      <body>
        <div id="relatorio-caixa">
          ${container.innerHTML}
        </div>
      </body>
    </html>
  `);
  win.document.close();
  const doPrint = () => {
    win.focus();
    win.print();
  };
  const imgs = win.document.images || [];
  if (!imgs.length) {
    setTimeout(doPrint, 200);
    return;
  }
  let loaded = 0;
  Array.from(imgs).forEach(img => {
    const done = () => {
      loaded += 1;
      if (loaded >= imgs.length) doPrint();
    };
    img.onload = done;
    img.onerror = done;
  });
}
// ============================================================================
// RELATÓRIOS
// ============================================================================

function loadRelatoriosData() {
  // Populate filial filter in relatórios if needed
  populateFilters();
}

// ============================================================================
// DRE
// ============================================================================

function loadDREData() {
  // Populate filial filter
  const selectFilial = document.getElementById('dre-filial');
  if (selectFilial && appData.filiais.length > 0) {
    selectFilial.innerHTML = '<option value="">Consolidado</option>';
    appData.filiais.forEach(filial => {
      selectFilial.innerHTML += `<option value="${escapeHtml(filial.codigo)}">${escapeHtml(filial.nome)}</option>`;
    });
  }

  // Auto-load DRE for current month
  setTimeout(() => carregarDRE(), 300);
}

function carregarDRE() {
  const mes = parseInt(document.getElementById('dre-mes').value);
  const ano = parseInt(document.getElementById('dre-ano').value);
  const filial = document.getElementById('dre-filial').value;

  showLoading('Calculando DRE...');

  window.gasRun
    .withSuccessHandler(function(dre) {
      hideLoading();
      renderDRE(dre);
    })
    .withFailureHandler(handleError)
    .getDREMensal(mes, ano, filial || undefined);
}

function renderDRE(dre) {
  // Update title
  document.getElementById('dre-titulo').textContent =
    `DRE - ${dre.periodo.mesNome}/${dre.periodo.ano} - ${dre.periodo.filial}`;

  // Update KPIs
  updateElement('dre-receita-liquida', formatCurrency(dre.valores.receitaLiquida));
  updateElement('dre-receita-transacoes', `${dre.transacoes.totalReceitas} receitas`);

  updateElement('dre-margem-bruta', formatCurrency(dre.valores.margemBruta));
  updateElement('dre-margem-bruta-perc', `${dre.percentuais.margemBruta.toFixed(1)}% - ${dre.classificacao.margemBruta}`);

  updateElement('dre-ebitda', formatCurrency(dre.valores.ebitda));
  updateElement('dre-ebitda-perc', `${dre.percentuais.ebitda.toFixed(1)}% - ${dre.classificacao.ebitda}`);

  updateElement('dre-lucro-liquido', formatCurrency(dre.valores.lucroLiquido));
  updateElement('dre-lucro-perc', `${dre.percentuais.lucroLiquido.toFixed(1)}% - ${dre.classificacao.lucroLiquido}`);

  // Update lucro card color
  const lucroCard = document.getElementById('dre-lucro-card');
  lucroCard.className = 'stat-card';
  if (dre.valores.lucroLiquido > 0) lucroCard.classList.add('success');
  else if (dre.valores.lucroLiquido < 0) lucroCard.classList.add('danger');

  // Render DRE table
  renderDRETable(dre);

  // Render despesas por categoria
  renderDespesasCategorias(dre);
}

function renderDRETable(dre) {
  const tbody = document.getElementById('table-dre');
  const v = dre.valores;
  const p = dre.percentuais;
  const c = dre.classificacao;

  const calcPerc = (valor) => v.receitaLiquida > 0 ? (valor / v.receitaLiquida * 100).toFixed(1) : '0.0';

  tbody.innerHTML = `
    <!-- RECEITA -->
    <tr style="background: #f8f9fa; font-weight: 600;">
      <td>RECEITA BRUTA</td>
      <td class="text-right">${formatCurrency(v.receitaBruta)}</td>
      <td class="text-right">${calcPerc(v.receitaBruta)}%</td>
      <td></td>
    </tr>
    <tr>
      <td style="padding-left: 2rem;">(-) Deduções</td>
      <td class="text-right text-danger">(${formatCurrency(v.deducoes)})</td>
      <td class="text-right">${calcPerc(v.deducoes)}%</td>
      <td></td>
    </tr>
    <tr style="background: #e8f7fd; font-weight: 600;">
      <td>= RECEITA LÍQUIDA</td>
      <td class="text-right text-primary">${formatCurrency(v.receitaLiquida)}</td>
      <td class="text-right">100.0%</td>
      <td></td>
    </tr>

    <!-- CUSTOS -->
    <tr style="height: 1rem;"><td colspan="4"></td></tr>
    <tr>
      <td>(-) Custo das Mercadorias/Serviços</td>
      <td class="text-right text-danger">(${formatCurrency(v.custos)})</td>
      <td class="text-right">${calcPerc(v.custos)}%</td>
      <td></td>
    </tr>
    <tr style="background: #d4edda; font-weight: 600;">
      <td>= MARGEM BRUTA</td>
      <td class="text-right text-success">${formatCurrency(v.margemBruta)}</td>
      <td class="text-right">${p.margemBruta.toFixed(1)}%</td>
      <td class="text-center"><span class="badge badge-${getClassificacaoBadge(c.margemBruta)}">${escapeHtml(c.margemBruta)}</span></td>
    </tr>

    <!-- DESPESAS OPERACIONAIS -->
    <tr style="height: 1rem;"><td colspan="4"></td></tr>
    <tr style="background: #f8f9fa; font-weight: 600;">
      <td>(-) DESPESAS OPERACIONAIS</td>
      <td class="text-right text-danger">(${formatCurrency(v.despesasOperacionais.total)})</td>
      <td class="text-right">${calcPerc(v.despesasOperacionais.total)}%</td>
      <td></td>
    </tr>
    <tr>
      <td style="padding-left: 2rem;">Pessoal</td>
      <td class="text-right">(${formatCurrency(v.despesasOperacionais.pessoal)})</td>
      <td class="text-right">${calcPerc(v.despesasOperacionais.pessoal)}%</td>
      <td></td>
    </tr>
    <tr>
      <td style="padding-left: 2rem;">Marketing</td>
      <td class="text-right">(${formatCurrency(v.despesasOperacionais.marketing)})</td>
      <td class="text-right">${calcPerc(v.despesasOperacionais.marketing)}%</td>
      <td></td>
    </tr>
    <tr>
      <td style="padding-left: 2rem;">Administrativas</td>
      <td class="text-right">(${formatCurrency(v.despesasOperacionais.administrativas)})</td>
      <td class="text-right">${calcPerc(v.despesasOperacionais.administrativas)}%</td>
      <td></td>
    </tr>

    <!-- EBITDA -->
    <tr style="background: #fff3cd; font-weight: 600;">
      <td>= EBITDA</td>
      <td class="text-right" style="color: ${v.ebitda >= 0 ? '#008060' : '#D72C0D'}">${formatCurrency(v.ebitda)}</td>
      <td class="text-right">${p.ebitda.toFixed(1)}%</td>
      <td class="text-center"><span class="badge badge-${getClassificacaoBadge(c.ebitda)}">${escapeHtml(c.ebitda)}</span></td>
    </tr>

    <!-- RESULTADO FINANCEIRO -->
    <tr style="height: 1rem;"><td colspan="4"></td></tr>
    <tr>
      <td>(-) Resultado Financeiro</td>
      <td class="text-right" style="color: ${v.resultadoFinanceiro >= 0 ? '#008060' : '#D72C0D'}">${formatCurrency(v.resultadoFinanceiro)}</td>
      <td class="text-right">${calcPerc(v.resultadoFinanceiro)}%</td>
      <td></td>
    </tr>

    <!-- LUCRO LÍQUIDO -->
    <tr style="background: ${v.lucroLiquido >= 0 ? '#d4edda' : '#f8d7da'}; font-weight: 700; font-size: 1.1rem;">
      <td>= LUCRO LÍQUIDO</td>
      <td class="text-right" style="color: ${v.lucroLiquido >= 0 ? '#008060' : '#D72C0D'}">${formatCurrency(v.lucroLiquido)}</td>
      <td class="text-right">${p.lucroLiquido.toFixed(1)}%</td>
      <td class="text-center"><span class="badge badge-${getClassificacaoBadge(c.lucroLiquido)}">${escapeHtml(c.lucroLiquido)}</span></td>
    </tr>
  `;
}

function renderDespesasCategorias(dre) {
  const tbody = document.getElementById('table-desp-categorias');
  const v = dre.valores;
  const calcPerc = (valor) => v.receitaLiquida > 0 ? (valor / v.receitaLiquida * 100).toFixed(1) : '0.0';

  tbody.innerHTML = `
    <tr>
      <td>💼 Pessoal</td>
      <td class="text-right">${formatCurrency(v.despesasOperacionais.pessoal)}</td>
      <td class="text-right">${calcPerc(v.despesasOperacionais.pessoal)}%</td>
    </tr>
    <tr>
      <td>📢 Marketing</td>
      <td class="text-right">${formatCurrency(v.despesasOperacionais.marketing)}</td>
      <td class="text-right">${calcPerc(v.despesasOperacionais.marketing)}%</td>
    </tr>
    <tr>
      <td>🏢 Administrativas</td>
      <td class="text-right">${formatCurrency(v.despesasOperacionais.administrativas)}</td>
      <td class="text-right">${calcPerc(v.despesasOperacionais.administrativas)}%</td>
    </tr>
    <tr style="background: #f8f9fa; font-weight: 600;">
      <td>TOTAL DESPESAS OPERACIONAIS</td>
      <td class="text-right">${formatCurrency(v.despesasOperacionais.total)}</td>
      <td class="text-right">${calcPerc(v.despesasOperacionais.total)}%</td>
    </tr>
  `;
}

function getClassificacaoBadge(classificacao) {
  const map = {
    'Sensacional': 'success',
    'Excelente': 'success',
    'Bom': 'info',
    'Ruim': 'warning',
    'Péssimo': 'danger'
  };
  return map[classificacao] || 'secondary';
}

// ============================================================================
// FLUXO DE CAIXA
// ============================================================================

function loadFluxoCaixaData() {
  // Populate filial filter
  const selectFilial = document.getElementById('fc-filial');
  if (selectFilial && appData.filiais.length > 0) {
    selectFilial.innerHTML = '<option value="">Consolidado</option>';
    appData.filiais.forEach(filial => {
      selectFilial.innerHTML += `<option value="${escapeHtml(filial.codigo)}">${escapeHtml(filial.nome)}</option>`;
    });
  }

  // Auto-load FC for current month
  setTimeout(() => carregarFluxoCaixa(), 300);
}

function carregarFluxoCaixa() {
  const mes = parseInt(document.getElementById('fc-mes').value);
  const ano = parseInt(document.getElementById('fc-ano').value);
  const filial = document.getElementById('fc-filial').value;
  const saldoInput = document.getElementById('fc-saldo-inicial-input');
  const saldoInicial =
    saldoInput && saldoInput.value !== '' ? parseFloat(saldoInput.value) : undefined;

  showLoading('Calculando Fluxo de Caixa...');

  window.gasRun
    .withSuccessHandler(function(fc) {
      hideLoading();
      renderFluxoCaixa(fc);
    })
    .withFailureHandler(handleError)
    .getFluxoCaixaMensal(mes, ano, filial || undefined, saldoInicial);
}

function renderFluxoCaixa(fc) {
  // Update title
  document.getElementById('fc-titulo').textContent =
    `Fluxo de Caixa - ${fc.periodo.mesNome}/${fc.periodo.ano} - ${fc.periodo.filial}`;

  // Update KPIs
  updateElement('fc-saldo-inicial', formatCurrency(fc.valores.saldoInicial));
  updateElement('fc-data-inicial', `Início do período`);

  updateElement('fc-total-entradas', formatCurrency(fc.valores.totalEntradas));
  updateElement('fc-qtd-entradas', `${fc.transacoes.qtdEntradas} transações`);

  updateElement('fc-total-saidas', formatCurrency(fc.valores.totalSaidas));
  updateElement('fc-qtd-saidas', `${fc.transacoes.qtdSaidas} transações`);

  updateElement('fc-saldo-final', formatCurrency(fc.valores.saldoFinal));
  updateElement('fc-variacao', `${fc.valores.variacao > 0 ? '+' : ''}${fc.valores.variacao.toFixed(1)}%`);

  // Update saldo card color
  const saldoCard = document.getElementById('fc-saldo-card');
  saldoCard.className = 'stat-card';
  if (fc.valores.saldoFinal > 0) saldoCard.classList.add('success');
  else if (fc.valores.saldoFinal < 0) saldoCard.classList.add('danger');

  // Render FC table
  renderFluxoCaixaTable(fc);

  // Render categorias
  renderEntradasCategorias(fc);
  renderSaidasCategorias(fc);
}

function renderFluxoCaixaTable(fc) {
  const tbody = document.getElementById('table-fluxo-caixa');
  const v = fc.valores;

  const total = v.totalEntradas + v.totalSaidas;
  const calcPerc = (valor) => total > 0 ? (Math.abs(valor) / total * 100).toFixed(1) : '0.0';

  tbody.innerHTML = `
    <!-- SALDO INICIAL -->
    <tr style="background: #f8f9fa; font-weight: 600;">
      <td>SALDO INICIAL</td>
      <td class="text-right">${formatCurrency(v.saldoInicial)}</td>
      <td class="text-right">-</td>
    </tr>

    <!-- ENTRADAS -->
    <tr style="height: 1rem;"><td colspan="3"></td></tr>
    <tr style="background: #d4edda; font-weight: 600;">
      <td>(+) ENTRADAS</td>
      <td class="text-right text-success">${formatCurrency(v.totalEntradas)}</td>
      <td class="text-right">${calcPerc(v.totalEntradas)}%</td>
    </tr>
    <tr>
      <td style="padding-left: 2rem;">Transações: ${fc.transacoes.qtdEntradas}</td>
      <td colspan="2"></td>
    </tr>

    <!-- SAÍDAS -->
    <tr style="height: 1rem;"><td colspan="3"></td></tr>
    <tr style="background: #f8d7da; font-weight: 600;">
      <td>(-) SAÍDAS</td>
      <td class="text-right text-danger">(${formatCurrency(v.totalSaidas)})</td>
      <td class="text-right">${calcPerc(v.totalSaidas)}%</td>
    </tr>
    <tr>
      <td style="padding-left: 2rem;">Transações: ${fc.transacoes.qtdSaidas}</td>
      <td colspan="2"></td>
    </tr>

    <!-- SALDO FINAL -->
    <tr style="height: 1rem;"><td colspan="3"></td></tr>
    <tr style="background: ${v.saldoFinal >= 0 ? '#d4edda' : '#f8d7da'}; font-weight: 700; font-size: 1.1rem;">
      <td>= SALDO FINAL</td>
      <td class="text-right" style="color: ${v.saldoFinal >= 0 ? '#008060' : '#D72C0D'}">${formatCurrency(v.saldoFinal)}</td>
      <td class="text-right">${v.variacao > 0 ? '+' : ''}${v.variacao.toFixed(1)}%</td>
    </tr>
  `;
}

function renderEntradasCategorias(fc) {
  const tbody = document.getElementById('table-entradas-categorias');
  const entradas = fc.entradas || [];
  const total = fc.valores.totalEntradas;

  if (entradas.length === 0) {
    tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">Nenhuma entrada registrada</td></tr>';
    return;
  }

  tbody.innerHTML = entradas.map(e => `
    <tr>
      <td>${escapeHtml(e.categoria)}</td>
      <td class="text-right">${formatCurrency(e.valor)}</td>
      <td class="text-right">${total > 0 ? (e.valor / total * 100).toFixed(1) : '0.0'}%</td>
    </tr>
  `).join('') + `
    <tr style="background: #f8f9fa; font-weight: 600;">
      <td>TOTAL</td>
      <td class="text-right">${formatCurrency(total)}</td>
      <td class="text-right">100.0%</td>
    </tr>
  `;
}

function renderSaidasCategorias(fc) {
  const tbody = document.getElementById('table-saidas-categorias');
  const saidas = fc.saidas || [];
  const total = fc.valores.totalSaidas;

  if (saidas.length === 0) {
    tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">Nenhuma saída registrada</td></tr>';
    return;
  }

  tbody.innerHTML = saidas.map(s => `
    <tr>
      <td>${escapeHtml(s.categoria)}</td>
      <td class="text-right">${formatCurrency(s.valor)}</td>
      <td class="text-right">${total > 0 ? (s.valor / total * 100).toFixed(1) : '0.0'}%</td>
    </tr>
  `).join('') + `
    <tr style="background: #f8f9fa; font-weight: 600;">
      <td>TOTAL</td>
      <td class="text-right">${formatCurrency(total)}</td>
      <td class="text-right">100.0%</td>
    </tr>
  `;
}

// ============================================================================
// GENERAL FUNCTIONS
// ============================================================================

function viewTransaction(id) {
  showLoading();
  window.gasRun
    .withSuccessHandler(function(data) {
      hideLoading();
      if (!data) {
        showToast('Lancamento nao encontrado', 'error');
        return;
      }
      renderTransactionDetails(data);
      ModalManager.open('modal-transaction');
    })
    .withFailureHandler(handleError)
    .getLancamentoDetalhes(id);
}

function renderTransactionDetails(tx) {
  const container = document.getElementById('transaction-details');
  if (!container) return;

  const fields = [
    { label: 'ID', value: tx.id },
    { label: 'Tipo', value: tx.tipo },
    { label: 'Status', value: tx.status },
    { label: 'Data competencia', value: formatDate(tx.dataCompetencia) },
    { label: 'Data vencimento', value: formatDate(tx.dataVencimento) },
    { label: 'Data pagamento', value: tx.dataPagamento ? formatDate(tx.dataPagamento) : '-' },
    { label: 'Filial', value: tx.filial || '-' },
    { label: 'Centro custo', value: tx.centroCusto || '-' },
    { label: 'Conta gerencial', value: tx.contaGerencial || '-' },
    { label: 'Conta contabil', value: tx.contaContabil || '-' },
    { label: 'Grupo receita', value: tx.grupoReceita || '-' },
    { label: 'Canal', value: tx.canal || '-' },
    { label: 'Descricao', value: tx.descricao || '-' },
    { label: 'Valor bruto', value: formatCurrency(tx.valorBruto || 0) },
    { label: 'Desconto', value: formatCurrency(tx.desconto || 0) },
    { label: 'Juros', value: formatCurrency(tx.juros || 0) },
    { label: 'Multa', value: formatCurrency(tx.multa || 0) },
    { label: 'Valor liquido', value: formatCurrency(tx.valorLiquido || 0) },
    { label: 'ID extrato', value: tx.idExtratoBanco || '-' },
    { label: 'Origem', value: tx.origem || '-' },
    { label: 'Observacoes', value: tx.observacoes || '-' },
  ];

  const html = fields.map(f => {
    const label = escapeHtml(f.label);
    const value = escapeHtml(String(f.value ?? ''));
    return '<div class="detail-item">' +
      '<span class="detail-label">' + label + '</span>' +
      '<span class="detail-value">' + value + '</span>' +
      '</div>';
  }).join('');

  container.innerHTML = html;
}

// ============================================================================
// KPIs
// ============================================================================

function loadKPIsData() {
  // Populate filial filter
  const selectFilial = document.getElementById('kpi-filial');
  if (selectFilial && appData.filiais.length > 0) {
    selectFilial.innerHTML = '<option value="">Consolidado</option>';
    appData.filiais.forEach(filial => {
      selectFilial.innerHTML += `<option value="${escapeHtml(filial.codigo)}">${escapeHtml(filial.nome)}</option>`;
    });
  }

  // Auto-load KPIs for current month
  setTimeout(() => carregarKPIs(), 300);
}

function carregarKPIs() {
  const mes = parseInt(document.getElementById('kpi-mes').value);
  const ano = parseInt(document.getElementById('kpi-ano').value);
  const filial = document.getElementById('kpi-filial').value;

  showLoading('Calculando KPIs...');

  window.gasRun
    .withSuccessHandler(function(kpis) {
      hideLoading();
      renderKPIs(kpis);
    })
    .withFailureHandler(handleError)
    .getKPIsMensal(mes, ano, filial || undefined);
}

function renderKPIs(kpis) {
  // Update title
  document.getElementById('kpi-titulo').textContent =
    `KPIs - ${kpis.periodo.mesNome}/${kpis.periodo.ano} - ${kpis.periodo.filial}`;

  // Rentabilidade
  updateElement('kpi-margem-bruta', `${kpis.rentabilidade.margemBruta.valor.toFixed(1)}%`);
  updateElement('kpi-margem-bruta-class', kpis.rentabilidade.margemBruta.classificacao);

  updateElement('kpi-margem-ebitda', `${kpis.rentabilidade.margemEbitda.valor.toFixed(1)}%`);
  updateElement('kpi-margem-ebitda-class', kpis.rentabilidade.margemEbitda.classificacao);

  updateElement('kpi-margem-liquida', `${kpis.rentabilidade.margemLiquida.valor.toFixed(1)}%`);
  updateElement('kpi-margem-liquida-class', kpis.rentabilidade.margemLiquida.classificacao);

  updateElement('kpi-roi', `${kpis.rentabilidade.roi.valor.toFixed(1)}%`);
  updateElement('kpi-roi-desc', kpis.rentabilidade.roi.descricao);

  // Liquidez
  updateElement('kpi-liquidez-corrente', kpis.liquidez.liquidezCorrente.valor.toFixed(2));
  updateElement('kpi-liquidez-corrente-class', kpis.liquidez.liquidezCorrente.classificacao);

  updateElement('kpi-saldo-caixa', formatCurrency(kpis.liquidez.saldoCaixa.valor));
  updateElement('kpi-saldo-caixa-desc', kpis.liquidez.saldoCaixa.descricao);

  updateElement('kpi-burn-rate', formatCurrency(kpis.liquidez.burnRate.valor));
  updateElement('kpi-burn-rate-desc', kpis.liquidez.burnRate.descricao);

  updateElement('kpi-runway', `${kpis.liquidez.runway.valor.toFixed(0)} meses`);
  updateElement('kpi-runway-desc', kpis.liquidez.runway.descricao);

  // Crescimento
  updateElement('kpi-crescimento-receita', `${kpis.crescimento.crescimentoReceita.valor > 0 ? '+' : ''}${kpis.crescimento.crescimentoReceita.valor.toFixed(1)}%`);
  updateElement('kpi-crescimento-receita-desc', `vs ${formatCurrency(kpis.crescimento.crescimentoReceita.mesAnterior)}`);

  updateElement('kpi-ticket-medio', formatCurrency(kpis.crescimento.ticketMedio.valor));
  updateElement('kpi-ticket-medio-desc', `${kpis.crescimento.ticketMedio.qtdTransacoes} transações`);

  updateElement('kpi-inadimplencia', `${kpis.crescimento.inadimplencia.valor.toFixed(1)}%`);
  updateElement('kpi-inadimplencia-class', kpis.crescimento.inadimplencia.classificacao);

  updateElement('kpi-pmr', `${Math.abs(kpis.crescimento.prazoMedioRecebimento.valor).toFixed(0)} dias`);
  updateElement('kpi-pmr-desc', kpis.crescimento.prazoMedioRecebimento.descricao);

  // Operacional
  updateElement('kpi-cac', formatCurrency(kpis.operacional.cac.valor));
  updateElement('kpi-cac-desc', kpis.operacional.cac.descricao);

  updateElement('kpi-desp-op-receita', `${kpis.operacional.despOperacionaisReceita.valor.toFixed(1)}%`);
  updateElement('kpi-desp-op-receita-class', kpis.operacional.despOperacionaisReceita.classificacao);

  updateElement('kpi-break-even', formatCurrency(kpis.operacional.breakEven.valor));
  updateElement('kpi-break-even-desc', kpis.operacional.breakEven.descricao);

  updateElement('kpi-pmp', `${Math.abs(kpis.operacional.prazoMedioPagamento.valor).toFixed(0)} dias`);
  updateElement('kpi-pmp-desc', kpis.operacional.prazoMedioPagamento.descricao);

  // Render tabela detalhada
  renderKPIsDetalhado(kpis);
}

function renderKPIsDetalhado(kpis) {
  const tbody = document.getElementById('table-kpis-detalhado');

  const indicadores = [
    {
      nome: 'Margem Bruta',
      atual: `${kpis.rentabilidade.margemBruta.valor.toFixed(1)}%`,
      anterior: `${kpis.comparativo.mesAnterior.margemBruta.toFixed(1)}%`,
      variacao: kpis.rentabilidade.margemBruta.valor - kpis.comparativo.mesAnterior.margemBruta,
      status: kpis.rentabilidade.margemBruta.classificacao
    },
    {
      nome: 'Margem Líquida',
      atual: `${kpis.rentabilidade.margemLiquida.valor.toFixed(1)}%`,
      anterior: `${kpis.comparativo.mesAnterior.margemLiquida.toFixed(1)}%`,
      variacao: kpis.rentabilidade.margemLiquida.valor - kpis.comparativo.mesAnterior.margemLiquida,
      status: kpis.rentabilidade.margemLiquida.classificacao
    },
    {
      nome: 'Liquidez Corrente',
      atual: kpis.liquidez.liquidezCorrente.valor.toFixed(2),
      anterior: '-',
      variacao: 0,
      status: kpis.liquidez.liquidezCorrente.classificacao
    },
    {
      nome: 'Taxa de Inadimplência',
      atual: `${kpis.crescimento.inadimplencia.valor.toFixed(1)}%`,
      anterior: '-',
      variacao: 0,
      status: kpis.crescimento.inadimplencia.classificacao
    }
  ];

  tbody.innerHTML = indicadores.map(ind => `
    <tr>
      <td>${escapeHtml(ind.nome)}</td>
      <td class="text-right">${ind.atual}</td>
      <td class="text-right">${ind.anterior}</td>
      <td class="text-right" style="color: ${ind.variacao > 0 ? '#008060' : ind.variacao < 0 ? '#D72C0D' : '#666'}">
        ${ind.variacao !== 0 ? (ind.variacao > 0 ? '+' : '') + ind.variacao.toFixed(1) + ' p.p.' : '-'}
      </td>
      <td class="text-center">
        <span class="badge badge-${getStatusBadge(ind.status)}">${escapeHtml(ind.status)}</span>
      </td>
    </tr>
  `).join('');
}

function getStatusBadge(status) {
  const map = {
    'Sensacional': 'success',
    'Excelente': 'success',
    'Bom': 'info',
    'Aceitável': 'warning',
    'Ruim': 'danger',
    'Péssimo': 'danger',
    'Positivo': 'success',
    'Negativo': 'danger',
    'Saudável': 'success',
    'Atenção': 'warning',
    'Crítico': 'danger'
  };
  return map[status] || 'secondary';
}

// ============================================================================
// UTILITIES
// ============================================================================

function formatCurrency(value) {
  if (value === null || value === undefined) return 'R$ 0,00';
  return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
}

function formatDate(dateStr) {
  if (!dateStr) return '-';
  const isoMatch = String(dateStr).match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if (isoMatch) {
    return `${isoMatch[3]}/${isoMatch[2]}/${isoMatch[1]}`;
  }
  const date = new Date(dateStr);
  if (Number.isNaN(date.getTime())) return String(dateStr);
  return date.toLocaleDateString('pt-BR');
}

function getLocalIsoDate(date) {
  const d = date ? new Date(date) : new Date();
  d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
  return d.toISOString().slice(0, 10);
}

function getDefaultCaixaDate() {
  const today = new Date();
  if (today.getDay() === 0) {
    const saturday = new Date(today);
    saturday.setDate(today.getDate() - 1);
    return getLocalIsoDate(saturday);
  }
  return getLocalIsoDate(today);
}

function getCaixaReferenciaDate(dateStr) {
  if (!dateStr) return '';
  const base = new Date(`${dateStr}T00:00:00`);
  if (Number.isNaN(base.getTime())) return dateStr;
  const ref = new Date(base);
  ref.setDate(base.getDate() - 1);
  if (ref.getDay() === 0) {
    ref.setDate(ref.getDate() - 1);
  }
  return getLocalIsoDate(ref);
}

function isSunday(dateStr) {
  if (!dateStr) return false;
  const date = new Date(`${dateStr}T00:00:00`);
  if (Number.isNaN(date.getTime())) return false;
  return date.getDay() === 0;
}

function getStatusClass(status) {
  const map = {
    'PENDENTE': 'warning',
    'PAGA': 'success',
    'RECEBIDA': 'success',
    'VENCIDA': 'danger',
    'CANCELADA': 'secondary',
    'CONCILIADO': 'success'
  };
  return map[status] || 'secondary';
}

function updateElement(id, value) {
  const el = document.getElementById(id);
  if (el) el.textContent = value;
}

function showLoading(message = 'Carregando...') {
  const overlay = document.getElementById('loading-overlay');
  if (overlay) {
    overlay.style.display = 'flex';
    const text = overlay.querySelector('p');
    if (text) text.textContent = message;
  }
  // Evita cliques repetidos enquanto há operação em andamento
  document.body.classList.add('app-busy');
  document.querySelectorAll('button').forEach(el => {
    el.dataset.prevDisabled = el.disabled ? 'true' : 'false';
    el.disabled = true;
  });
}

function hideLoading() {
  const overlay = document.getElementById('loading-overlay');
  if (overlay) overlay.style.display = 'none';
  document.body.classList.remove('app-busy');
  document.querySelectorAll('button').forEach(el => {
    if (el.dataset.prevDisabled === 'false' || el.dataset.prevDisabled === undefined) {
      el.disabled = false;
    }
    delete el.dataset.prevDisabled;
  });
}

function showToast(message, type = 'info') {
  const container = document.getElementById('toast-container');
  if (!container) return;
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  const span = document.createElement('span');
  span.textContent = String(message ?? '');
  toast.appendChild(span);
  container.appendChild(toast);

  setTimeout(() => {
    toast.remove();
  }, 3000);
}

function handleError(error) {
  hideLoading();
  console.error('Error:', error);
  const message = (error && (error.message || error.toString())) ? String(error.message || error.toString()) : 'Ocorreu um erro';
  if (message.toLowerCase().includes('sem permissão') || message.toLowerCase().includes('sem permissao')) {
    showToast('Sem permissão para executar esta ação', 'error');
    tryLogClientError({ message, view: currentView });
    return;
  }
  tryLogClientError({ message, stack: error && error.stack ? String(error.stack) : undefined, view: currentView });
  const refMatch = message.match(/\(ref:\s*([^)]+)\)/i);
  const ref = refMatch ? refMatch[1].trim() : '';
  if (ref) {
    showToast(`Erro ao executar a ação. Ref: ${ref}`, 'error');
  } else {
    showToast(message, 'error');
  }
}

function tryLogClientError(details) {
  try {
    window.gasRun
      .withFailureHandler(function() {})
      .logClientError({
        message: String(details?.message || 'Erro no frontend'),
        stack: details?.stack ? String(details.stack) : '',
        view: details?.view ? String(details.view) : '',
        url: location && location.href ? String(location.href) : '',
        userAgent: navigator && navigator.userAgent ? String(navigator.userAgent) : '',
        correlationId: correlationId
      });
  } catch {
    // ignore
  }
}

// Captura erros globais do frontend
window.addEventListener('error', function(e) {
  tryLogClientError({
    message: e && e.message ? String(e.message) : 'Unhandled error',
    stack: e && e.error && e.error.stack ? String(e.error.stack) : '',
    view: currentView
  });
});

window.addEventListener('unhandledrejection', function(e) {
  const reason = e && e.reason ? e.reason : null;
  tryLogClientError({
    message: reason && (reason.message || reason.toString()) ? String(reason.message || reason.toString()) : 'Unhandled promise rejection',
    stack: reason && reason.stack ? String(reason.stack) : '',
    view: currentView
  });
});

function toggleSelectAll(type) {
  const checked = document.getElementById(`select-all-${type}`).checked;
  document.querySelectorAll(`.select-${type}`).forEach(cb => {
    cb.checked = checked;
  });
  if (type === 'cp') updateBatchButtons();
  if (type === 'cr') updateBatchButtonsReceber();
}

function getSelectedIds(type) {
  return Array.from(document.querySelectorAll(`.select-${type}:checked`))
    .map(cb => cb.value);
}

function updateBatchButtons() {
  const selected = getSelectedIds('cp');
  document.getElementById('btn-pagar-lote').disabled = selected.length === 0;
  document.getElementById('btn-cancelar-lote').disabled = selected.length === 0;
}

function updateBatchButtonsReceber() {
  const selected = getSelectedIds('cr');
  document.getElementById('btn-receber-lote').disabled = selected.length === 0;
  document.getElementById('btn-cancelar-receber-lote').disabled = selected.length === 0;
}
</script>






