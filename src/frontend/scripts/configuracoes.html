<script>
// Dados globais
let usuariosData = [];
var gasRun = (window && window.gasRun) ? window.gasRun : google.script.run;

const PERFIL_DEFAULTS = {
  ADMIN: {
    criarLancamentos: true,
    editarLancamentos: true,
    excluirLancamentos: true,
    aprovarPagamentos: true,
    visualizarRelatorios: true,
    gerenciarConfig: true
  },
  GESTOR: {
    criarLancamentos: true,
    editarLancamentos: true,
    excluirLancamentos: false,
    aprovarPagamentos: true,
    visualizarRelatorios: true,
    gerenciarConfig: false
  },
  OPERACIONAL: {
    criarLancamentos: true,
    editarLancamentos: true,
    excluirLancamentos: false,
    aprovarPagamentos: false,
    visualizarRelatorios: true,
    gerenciarConfig: false
  },
  VISUALIZADOR: {
    criarLancamentos: false,
    editarLancamentos: false,
    excluirLancamentos: false,
    aprovarPagamentos: false,
    visualizarRelatorios: true,
    gerenciarConfig: false
  }
};

let usuarioPermissoesDirty = false;

function applyPermissoesFromPerfil(perfil) {
  const perms = PERFIL_DEFAULTS[String(perfil || '').toUpperCase()] || PERFIL_DEFAULTS.VISUALIZADOR;
  document.getElementById('perm-criar-lancamentos').checked = !!perms.criarLancamentos;
  document.getElementById('perm-editar-lancamentos').checked = !!perms.editarLancamentos;
  document.getElementById('perm-excluir-lancamentos').checked = !!perms.excluirLancamentos;
  document.getElementById('perm-aprovar-pagamentos').checked = !!perms.aprovarPagamentos;
  document.getElementById('perm-visualizar-relatorios').checked = !!perms.visualizarRelatorios;
  document.getElementById('perm-gerenciar-config').checked = !!perms.gerenciarConfig;
  usuarioPermissoesDirty = false;
}

function initUsuarioPermissoesListeners() {
  const perfilSelect = document.getElementById('usuario-perfil');
  if (perfilSelect) {
    perfilSelect.addEventListener('change', function() {
      applyPermissoesFromPerfil(this.value);
    });
  }
  const permIds = [
    'perm-criar-lancamentos',
    'perm-editar-lancamentos',
    'perm-excluir-lancamentos',
    'perm-aprovar-pagamentos',
    'perm-visualizar-relatorios',
    'perm-gerenciar-config'
  ];
  permIds.forEach((id) => {
    const el = document.getElementById(id);
    if (el) {
      el.addEventListener('change', function() {
        usuarioPermissoesDirty = true;
      });
    }
  });
}

function loadConfiguracoesData() {
  setupConfigTabs();
  initLogsTabAccess();
  loadCentrosCusto();
  loadPlanoContas();
  loadCanais();
  loadFiliais();
  loadUsuarios();
}

function setupConfigTabs() {
  const tabs = document.querySelectorAll('[data-tab-group="config"]');
  tabs.forEach(tab => {
    tab.addEventListener('click', function() {
      const tabName = this.getAttribute('data-tab');
      ModalManager.closeAll();
      switchTab('config', tabName);
      if (tabName === 'logs') {
        loadLogs();
      }
    });
  });
}

// ---------------------------------------------------------------------------
// Logs (Auditoria)
// ---------------------------------------------------------------------------
let auditLogsCache = [];
let auditLogsLoadedAt = 0;
let auditLogsFilteredCache = [];

function initLogsTabAccess() {
  const logsTabBtn = document.querySelector('[data-tab-group="config"][data-tab="logs"]');
  const logsTabContent = document.querySelector('[data-tab-content="config"][data-content="logs"]');
  if (!logsTabBtn) return;
  const isAdmin = window.currentUserInfo && window.currentUserInfo.perfil === 'ADMIN';
  if (!isAdmin) {
    logsTabBtn.style.display = 'none';
    if (logsTabContent) logsTabContent.style.display = 'none';
  }
}

function refreshLogs() {
  loadLogs(true);
}

function loadLogs(force = false) {
  const tbody = document.getElementById('table-logs');
  if (!tbody) return;

  const isAdmin = window.currentUserInfo && window.currentUserInfo.perfil === 'ADMIN';
  if (!isAdmin) {
    tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Sem permissÃ£o para visualizar logs</td></tr>';
    return;
  }

  loadAdminDiagnostics();

  const now = Date.now();
  if (!force && auditLogsCache.length > 0 && now - auditLogsLoadedAt < 15000) {
    applyLogsFilter();
    return;
  }

  tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Carregando...</td></tr>';
  showLoading('Carregando logs...');

  gasRun
    .withSuccessHandler(entries => {
      hideLoading();
      auditLogsCache = Array.isArray(entries) ? entries : [];
      auditLogsLoadedAt = Date.now();
      applyLogsFilter();
    })
    .withFailureHandler(err => {
      hideLoading();
      handleError(err);
      tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Falha ao carregar logs</td></tr>';
    })
    .getAuditLogEntries(200);
}

function applyLogsFilter() {
  const isAdmin = window.currentUserInfo && window.currentUserInfo.perfil === 'ADMIN';
  if (!isAdmin) return;

  const queryEl = document.getElementById('logs-query');
  const emailEl = document.getElementById('logs-email');
  const actionEl = document.getElementById('logs-action');
  const refEl = document.getElementById('logs-ref');
  const statusEl = document.getElementById('logs-status');

  const query = queryEl && queryEl.value ? String(queryEl.value).trim().toLowerCase() : '';
  const email = emailEl && emailEl.value ? String(emailEl.value).trim().toLowerCase() : '';
  const action = actionEl && actionEl.value ? String(actionEl.value).trim().toLowerCase() : '';
  const ref = refEl && refEl.value ? String(refEl.value).trim() : '';
  const status = statusEl && statusEl.value ? String(statusEl.value).trim().toLowerCase() : '';

  const filtered = (auditLogsCache || []).filter(e => {
    const ok = Boolean(e && e.success);
    if (status === 'ok' && !ok) return false;
    if (status === 'erro' && ok) return false;

    if (email && String(e && e.email ? e.email : '').toLowerCase().indexOf(email) === -1) return false;
    if (action && String(e && e.action ? e.action : '').toLowerCase().indexOf(action) === -1) return false;

    if (ref) {
      const payloadText = String(e && e.payload ? e.payload : '');
      if (payloadText.indexOf(ref) === -1) return false;
    }

    if (!query) return true;
    const hay = [
      e && e.timestamp,
      e && e.email,
      e && e.action,
      e && e.message,
      e && e.payload,
    ].map(v => String(v || '').toLowerCase()).join(' | ');
    return hay.includes(query);
  });

  auditLogsFilteredCache = filtered;
  renderAuditLogs(filtered);
}

function searchLogsServer() {
  const isAdmin = window.currentUserInfo && window.currentUserInfo.perfil === 'ADMIN';
  const tbody = document.getElementById('table-logs');
  if (!tbody) return;
  if (!isAdmin) {
    showToast('Sem permissÃ£o', 'warning');
    return;
  }

  const queryEl = document.getElementById('logs-query');
  const emailEl = document.getElementById('logs-email');
  const actionEl = document.getElementById('logs-action');
  const refEl = document.getElementById('logs-ref');
  const statusEl = document.getElementById('logs-status');

  const query = queryEl && queryEl.value ? String(queryEl.value).trim() : '';
  const email = emailEl && emailEl.value ? String(emailEl.value).trim() : '';
  const action = actionEl && actionEl.value ? String(actionEl.value).trim() : '';
  const correlationId = refEl && refEl.value ? String(refEl.value).trim() : '';
  const status = statusEl && statusEl.value ? String(statusEl.value).trim().toLowerCase() : '';
  const success = status === 'ok' ? true : status === 'erro' ? false : null;

  tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Buscando...</td></tr>';
  showLoading('Buscando logs...');

  gasRun
    .withSuccessHandler(entries => {
      hideLoading();
      auditLogsCache = Array.isArray(entries) ? entries : [];
      auditLogsLoadedAt = Date.now();
      applyLogsFilter();
    })
    .withFailureHandler(err => {
      hideLoading();
      handleError(err);
      tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Falha ao buscar logs</td></tr>';
    })
    .getAuditLogEntriesFiltered({ limit: 200, query, email, action, correlationId, success });
}

function exportLogsCsv() {
  const isAdmin = window.currentUserInfo && window.currentUserInfo.perfil === 'ADMIN';
  if (!isAdmin) {
    showToast('Sem permissÃ£o para exportar logs', 'warning');
    return;
  }

  const rows = Array.isArray(auditLogsFilteredCache) ? auditLogsFilteredCache : [];
  if (rows.length === 0) {
    showToast('Nenhum log para exportar', 'warning');
    return;
  }

  const csvEscape = (value) => {
    const s = String(value ?? '');
    const escaped = s.replace(/\"/g, '\"\"');
    return `\"${escaped}\"`;
  };

  const header = ['timestamp', 'email', 'action', 'success', 'ref', 'message', 'payload'];
  const lines = [header.map(csvEscape).join(',')];

  rows.forEach(e => {
    let ref = '';
    try {
      const parsed = JSON.parse(String(e && e.payload ? e.payload : ''));
      if (parsed && typeof parsed === 'object' && parsed.correlationId) {
        ref = String(parsed.correlationId);
      }
    } catch (_) {}
    lines.push([
      e && e.timestamp,
      e && e.email,
      e && e.action,
      e && (e.success ? 'TRUE' : 'FALSE'),
      ref,
      e && e.message,
      e && e.payload,
    ].map(csvEscape).join(','));
  });

  const csv = lines.join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
  const url = URL.createObjectURL(blob);

  const a = document.createElement('a');
  const ts = new Date().toISOString().replace(/[:.]/g, '-');
  a.href = url;
  a.download = `audit-logs-${ts}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();

  setTimeout(() => {
    try { URL.revokeObjectURL(url); } catch (_) {}
  }, 1000);
}

// ---------------------------------------------------------------------------
// DiagnÃ³sticos (Smoke tests)
// ---------------------------------------------------------------------------
let lastSmokeTestsResult = null;

function loadAdminDiagnostics() {
  const isAdmin = window.currentUserInfo && window.currentUserInfo.perfil === 'ADMIN';
  if (!isAdmin) return;

  gasRun
    .withSuccessHandler(diag => {
      if (!diag || !diag.ok || !diag.flags) return;
      const debugEl = document.getElementById('flag-enable-debug-api');
      const seedEl = document.getElementById('flag-enable-seed-data');
      if (debugEl) debugEl.checked = String(diag.flags.ENABLE_DEBUG_API || '').toLowerCase() === 'true';
      if (seedEl) seedEl.checked = String(diag.flags.ENABLE_SEED_DATA || '').toLowerCase() === 'true';
    })
    .withFailureHandler(() => {})
    .getAdminDiagnostics();
}

function toggleAdminFlag(key, checked) {
  const isAdmin = window.currentUserInfo && window.currentUserInfo.perfil === 'ADMIN';
  if (!isAdmin) {
    showToast('Sem permissÃ£o', 'warning');
    return;
  }
  gasRun
    .withSuccessHandler(result => {
      if (result && result.success) showToast(result.message, 'success');
      else showToast(result && result.message ? result.message : 'Falha ao atualizar flag', 'error');
      loadAdminDiagnostics();
    })
    .withFailureHandler(handleError)
    .setAdminFlag(String(key || ''), Boolean(checked));
}

function clearCachesUi() {
  const isAdmin = window.currentUserInfo && window.currentUserInfo.perfil === 'ADMIN';
  if (!isAdmin) {
    showToast('Sem permissÃ£o', 'warning');
    return;
  }
  if (!confirm('Limpar caches do sistema?')) return;
  showLoading('Limpando caches...');
  gasRun
    .withSuccessHandler(result => {
      hideLoading();
      if (result && result.success) showToast(result.message, 'success');
      else showToast(result && result.message ? result.message : 'Falha ao limpar caches', 'error');
    })
    .withFailureHandler(err => {
      hideLoading();
      handleError(err);
    })
    .clearCaches();
}

function runSmokeTestsUi() {
  const isAdmin = window.currentUserInfo && window.currentUserInfo.perfil === 'ADMIN';
  const out = document.getElementById('smoke-tests-output');
  if (!out) return;
  if (!isAdmin) {
    out.textContent = 'Sem permissÃ£o (ADMIN apenas).';
    return;
  }

  out.textContent = 'Executando smoke tests...';
  showLoading('Executando smoke tests...');

  gasRun
    .withSuccessHandler(result => {
      hideLoading();
      lastSmokeTestsResult = result || null;
      out.textContent = formatSmokeTestResult(result);
      if (result && result.ok) showToast('Smoke tests: OK', 'success');
      else showToast('Smoke tests: falhou', 'error');
    })
    .withFailureHandler(err => {
      hideLoading();
      handleError(err);
      out.textContent = `Falha ao executar smoke tests: ${err && err.message ? err.message : String(err)}`;
    })
    .runSmokeTests();
}

function formatSmokeTestResult(result) {
  try {
    if (!result || typeof result !== 'object') return String(result ?? '');
    const steps = Array.isArray(result.steps) ? result.steps : [];
    const ok = Boolean(result.ok);
    const ranAt = result.ranAt ? String(result.ranAt) : '';
    const header = `ok=${ok} ranAt=${ranAt} steps=${steps.length}`;
    return header + '\n' + JSON.stringify(result, null, 2);
  } catch (e) {
    return String(result);
  }
}

function copySmokeTestsOutput() {
  const out = document.getElementById('smoke-tests-output');
  if (!out) return;
  const text = out.textContent || '';
  if (!text) {
    showToast('Nada para copiar', 'warning');
    return;
  }
  try {
    navigator.clipboard.writeText(text).then(
      () => showToast('Resultado copiado', 'success'),
      () => fallbackCopyText(text)
    );
  } catch (_) {
    fallbackCopyText(text);
  }
}

function fallbackCopyText(text) {
  try {
    const ta = document.createElement('textarea');
    ta.value = text;
    ta.style.position = 'fixed';
    ta.style.left = '-9999px';
    document.body.appendChild(ta);
    ta.focus();
    ta.select();
    document.execCommand('copy');
    ta.remove();
    showToast('Resultado copiado', 'success');
  } catch (_) {
    showToast('Falha ao copiar', 'error');
  }
}

function renderAuditLogs(entries) {
  const tbody = document.getElementById('table-logs');
  if (!tbody) return;

  if (!entries || entries.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Nenhum registro encontrado</td></tr>';
    return;
  }

  tbody.innerHTML = entries.map(e => {
    const timestamp = escapeHtml(String(e.timestamp || ''));
    const email = escapeHtml(String(e.email || ''));
    const action = escapeHtml(String(e.action || ''));
    const success = Boolean(e.success);
    const message = escapeHtml(String(e.message || ''));
    const payloadText = String(e.payload || '');
    let ref = '';
    try {
      const parsed = JSON.parse(payloadText);
      if (parsed && typeof parsed === 'object' && parsed.correlationId) {
        ref = String(parsed.correlationId);
      }
    } catch (_) {}
    const payloadShort = payloadText.length > 140 ? payloadText.slice(0, 140) + 'â€¦' : payloadText;

    const payloadHtml = `
      <details>
        <summary>${escapeHtml(payloadShort || '(vazio)')}</summary>
        <pre style="white-space: pre-wrap; margin: 0.5rem 0 0;">${escapeHtml(payloadText)}</pre>
      </details>
    `;

    return `
      <tr>
        <td>${timestamp}</td>
        <td>${email}</td>
        <td><code>${action}</code></td>
        <td>
          <span class="badge badge-${success ? 'success' : 'danger'}">
            ${success ? 'OK' : 'ERRO'}
          </span>
        </td>
        <td><code>${escapeHtml(ref || '-')}</code></td>
        <td>${message}</td>
        <td>${payloadHtml}</td>
      </tr>
    `;
  }).join('');
}

// ---------------------------------------------------------------------------
// Centros de Custo
// ---------------------------------------------------------------------------
function loadCentrosCusto() {
  const tbody = document.getElementById('table-centros-custo');
  if (!tbody) return;

  if (!appData.centrosCusto || appData.centrosCusto.length === 0) {
    tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Nenhum centro de custo cadastrado</td></tr>';
    return;
  }

  tbody.innerHTML = appData.centrosCusto.map((cc, index) => `
    <tr>
      <td><strong>${escapeHtml(cc.codigo)}</strong></td>
      <td>${escapeHtml(cc.nome)}</td>
      <td>
        <span class="badge badge-${cc.ativo === false ? 'secondary' : 'success'}">
          ${cc.ativo === false ? 'Inativo' : 'Ativo'}
        </span>
      </td>
      <td class="text-right">
        <button class="btn btn-sm btn-secondary" onclick="editarCentroCusto(${index})" title="Editar">âœŽ</button>
        <button class="btn btn-sm ${cc.ativo === false ? 'btn-success' : 'btn-warning'}" onclick="alternarCentroCusto(${index}, ${cc.ativo === false})" title="${cc.ativo === false ? 'Ativar' : 'Inativar'}">
          ${cc.ativo === false ? 'Ativar' : 'Inativar'}
        </button>
        <button class="btn btn-sm btn-danger" onclick="excluirCentroCusto(${index})" title="Excluir">ðŸ—‘</button>
      </td>
    </tr>
  `).join('');
}

function openModalNovoCentroCusto() {
  document.getElementById('titulo-centro-custo').textContent = 'Novo Centro de Custo';
  document.getElementById('cc-edit-index').value = '';
  document.getElementById('form-centro-custo').reset();
  const ativo = document.getElementById('cc-ativo');
  if (ativo) ativo.checked = true;
  ModalManager.open('modal-centro-custo');
}

function editarCentroCusto(index) {
  const cc = appData.centrosCusto[index];
  document.getElementById('titulo-centro-custo').textContent = 'Editar Centro de Custo';
  document.getElementById('cc-edit-index').value = index;
  document.getElementById('cc-codigo').value = cc.codigo;
  document.getElementById('cc-nome').value = cc.nome;
  const ativo = document.getElementById('cc-ativo');
  if (ativo) ativo.checked = cc.ativo !== false;
  ModalManager.open('modal-centro-custo');
}

function salvarCentroCusto() {
  const codigo = document.getElementById('cc-codigo').value.trim().toUpperCase();
  const nome = document.getElementById('cc-nome').value.trim();
  const ativo = document.getElementById('cc-ativo').checked;
  const editIndex = document.getElementById('cc-edit-index').value;

  if (!codigo || !nome) {
    showToast('Preencha todos os campos obrigatÃ³rios', 'warning');
    return;
  }

  showLoading('Salvando centro de custo...');
  const centroCusto = { codigo, nome, ativo };

  gasRun
    .withSuccessHandler(result => {
      hideLoading();
      if (result.success) {
        showToast(result.message, 'success');
        ModalManager.close('modal-centro-custo');
        loadReferenceData();
      } else {
        showToast(result.message, 'error');
      }
    })
    .withFailureHandler(handleError)
    .salvarCentroCusto(centroCusto, editIndex !== '' ? parseInt(editIndex) : -1);
}

function excluirCentroCusto(index) {
  openConfirmCentroCusto('Tem certeza que deseja excluir este centro de custo?', index);
}

function alternarCentroCusto(index, ativar) {
  showLoading(ativar ? 'Ativando centro de custo...' : 'Inativando centro de custo...');
  gasRun
    .withSuccessHandler(result => {
      hideLoading();
      if (result.success) {
        showToast(result.message, 'success');
        loadReferenceData();
      } else {
        showToast(result.message, 'error');
      }
    })
    .withFailureHandler(handleError)
    .toggleCentroCusto(index, ativar);
}

// Confirm center cost
let ccIndexParaExcluir = null;
function openConfirmCentroCusto(msg, index) {
  ccIndexParaExcluir = index;
  const msgEl = document.getElementById('confirm-cc-message');
  if (msgEl) msgEl.textContent = msg;
  ModalManager.open('modal-confirm-cc');
}

function confirmExcluirCentroCusto() {
  if (ccIndexParaExcluir === null) return;
  const index = ccIndexParaExcluir;
  ccIndexParaExcluir = null;
  ModalManager.close('modal-confirm-cc');
  showLoading('Excluindo...');
  gasRun
    .withSuccessHandler(result => {
      hideLoading();
      if (result.success) {
        showToast(result.message, 'success');
        loadReferenceData();
      } else {
        showToast(result.message, 'error');
      }
    })
    .withFailureHandler(handleError)
    .excluirCentroCusto(index);
}

// ---------------------------------------------------------------------------
// Plano de Contas
// ---------------------------------------------------------------------------
function loadPlanoContas() {
  const tbody = document.getElementById('table-plano-contas');
  if (!tbody) return;

  if (!appData.contas || appData.contas.length === 0) {
    tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">Nenhuma conta cadastrada</td></tr>';
    return;
  }

  tbody.innerHTML = appData.contas.map((conta, index) => `
    <tr>
      <td><strong>${escapeHtml(conta.codigo)}</strong></td>
      <td>${escapeHtml(conta.nome)}</td>
      <td><span class="badge badge-${conta.tipo === 'RECEITA' ? 'success' : (conta.tipo === 'ATIVO' ? 'info' : 'danger')}">${escapeHtml(conta.tipo || 'N/A')}</span></td>
      <td>${escapeHtml(conta.grupoDRE || '-')}</td>
      <td>${escapeHtml(conta.subgrupoDRE || '-')}</td>
      <td>${escapeHtml(conta.grupoDFC || '-')}</td>
      <td>${escapeHtml(conta.variavelFixa || '-')}</td>
      <td>${escapeHtml(conta.cmaCmv || '-')}</td>
      <td class="text-right">
        <button class="btn btn-sm btn-secondary" onclick="editarConta(${index})" title="Editar">âœŽ</button>
        <button class="btn btn-sm btn-danger" onclick="excluirConta(${index})" title="Excluir">ðŸ—‘</button>
      </td>
    </tr>
  `).join('');
}

function openModalNovaConta() {
  document.getElementById('titulo-conta').textContent = 'Nova Conta ContÃ¡bil';
  document.getElementById('conta-edit-index').value = '';
  document.getElementById('form-conta-contabil').reset();
  document.getElementById('conta-grupo-dre').value = '';
  document.getElementById('conta-subgrupo-dre').value = '';
  document.getElementById('conta-grupo-dfc').value = '';
  document.getElementById('conta-variavel-fixa').value = '';
  document.getElementById('conta-cma-cmv').value = '';
  ModalManager.open('modal-conta-contabil');
}

function editarConta(index) {
  const conta = appData.contas[index];
  document.getElementById('titulo-conta').textContent = 'Editar Conta ContÃ¡bil';
  document.getElementById('conta-edit-index').value = index;
  document.getElementById('conta-codigo').value = conta.codigo;
  document.getElementById('conta-nome').value = conta.nome;
  document.getElementById('conta-tipo').value = conta.tipo || '';
  document.getElementById('conta-grupo-dre').value = conta.grupoDRE || '';
  document.getElementById('conta-subgrupo-dre').value = conta.subgrupoDRE || '';
  document.getElementById('conta-grupo-dfc').value = conta.grupoDFC || '';
  document.getElementById('conta-variavel-fixa').value = conta.variavelFixa || '';
  document.getElementById('conta-cma-cmv').value = conta.cmaCmv || '';
  ModalManager.open('modal-conta-contabil');
}

function salvarContaContabil() {
  const codigo = document.getElementById('conta-codigo').value.trim();
  const nome = document.getElementById('conta-nome').value.trim();
  const tipo = document.getElementById('conta-tipo').value;
  const grupoDRE = document.getElementById('conta-grupo-dre').value.trim();
  const subgrupoDRE = document.getElementById('conta-subgrupo-dre').value.trim();
  const grupoDFC = document.getElementById('conta-grupo-dfc').value.trim();
  const variavelFixa = document.getElementById('conta-variavel-fixa').value;
  const cmaCmv = document.getElementById('conta-cma-cmv').value;
  const editIndex = document.getElementById('conta-edit-index').value;

  if (!codigo || !nome || !tipo) {
    showToast('Preencha todos os campos obrigatÃ³rios', 'warning');
    return;
  }

  showLoading('Salvando conta...');

  const conta = { codigo, nome, tipo, grupoDRE, subgrupoDRE, grupoDFC, variavelFixa, cmaCmv };

  gasRun
    .withSuccessHandler(result => {
      hideLoading();
      if (result.success) {
        showToast(result.message, 'success');
        ModalManager.close('modal-conta-contabil');
        loadReferenceData();
      } else {
        showToast(result.message, 'error');
      }
    })
    .withFailureHandler(handleError)
    .salvarContaContabil(conta, editIndex !== '' ? parseInt(editIndex) : -1);
}

function excluirConta(index) {
  openConfirmConta('Tem certeza que deseja excluir esta conta?', index);
}

let contaIndexParaExcluir = null;
function openConfirmConta(msg, index) {
  contaIndexParaExcluir = index;
  const msgEl = document.getElementById('confirm-conta-message');
  if (msgEl) msgEl.textContent = msg;
  ModalManager.open('modal-confirm-conta');
}

function confirmExcluirConta() {
  if (contaIndexParaExcluir === null) return;
  const index = contaIndexParaExcluir;
  contaIndexParaExcluir = null;
  ModalManager.close('modal-confirm-conta');
  showLoading('Excluindo...');
  gasRun
    .withSuccessHandler(result => {
      hideLoading();
      if (result.success) {
        showToast(result.message, 'success');
        loadReferenceData();
      } else {
        showToast(result.message, 'error');
      }
    })
    .withFailureHandler(handleError)
    .excluirConta(index);
}

// ---------------------------------------------------------------------------
// Canais
// ---------------------------------------------------------------------------
let canalIndexParaExcluir = null;

function loadCanais() {
  const tbody = document.getElementById('table-canais');
  if (!tbody) return;

  if (!appData.canais || appData.canais.length === 0) {
    tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Nenhum canal cadastrado</td></tr>';
    return;
  }

  tbody.innerHTML = appData.canais.map((canal, index) => `
    <tr>
      <td><strong>${escapeHtml(canal.codigo)}</strong></td>
      <td>${escapeHtml(canal.nome)}</td>
      <td>
        <span class="badge badge-${canal.ativo === false ? 'secondary' : 'success'}">
          ${canal.ativo === false ? 'Inativo' : 'Ativo'}
        </span>
      </td>
      <td class="text-right">
        <button class="btn btn-sm btn-secondary" onclick="editarCanal(${index})" title="Editar">âœŽ</button>
        <button class="btn btn-sm ${canal.ativo === false ? 'btn-success' : 'btn-warning'}" onclick="alternarCanal(${index}, ${canal.ativo === false})" title="${canal.ativo === false ? 'Ativar' : 'Inativar'}">
          ${canal.ativo === false ? 'Ativar' : 'Inativar'}
        </button>
        <button class="btn btn-sm btn-danger" onclick="excluirCanal(${index})" title="Excluir">ðŸ—‘</button>
      </td>
    </tr>
  `).join('');
}

function openModalNovoCanal() {
  document.getElementById('titulo-canal').textContent = 'Novo Canal de Venda';
  document.getElementById('canal-edit-index').value = '';
  document.getElementById('form-canal').reset();
  const ativo = document.getElementById('canal-ativo');
  if (ativo) ativo.checked = true;
  ModalManager.open('modal-canal');
}

function editarCanal(index) {
  const canal = appData.canais[index];
  document.getElementById('titulo-canal').textContent = 'Editar Canal de Venda';
  document.getElementById('canal-edit-index').value = index;
  document.getElementById('canal-codigo').value = canal.codigo;
  document.getElementById('canal-nome').value = canal.nome;
  const ativo = document.getElementById('canal-ativo');
  if (ativo) ativo.checked = canal.ativo !== false;
  ModalManager.open('modal-canal');
}

function salvarCanal() {
  const codigo = document.getElementById('canal-codigo').value.trim().toUpperCase();
  const nome = document.getElementById('canal-nome').value.trim();
  const ativo = document.getElementById('canal-ativo').checked;
  const editIndex = document.getElementById('canal-edit-index').value;

  if (!codigo || !nome) {
    showToast('Preencha todos os campos obrigatÃ³rios', 'warning');
    return;
  }

  showLoading('Salvando canal...');
  const canal = { codigo, nome, ativo };

  gasRun
    .withSuccessHandler(result => {
      hideLoading();
      if (result.success) {
        showToast(result.message, 'success');
        ModalManager.close('modal-canal');
        loadReferenceData();
      } else {
        showToast(result.message, 'error');
      }
    })
    .withFailureHandler(handleError)
    .salvarCanal(canal, editIndex !== '' ? parseInt(editIndex) : -1);
}

function excluirCanal(index) {
  openConfirmCanal('Tem certeza que deseja excluir este canal?', index);
}

function alternarCanal(index, ativar) {
  showLoading(ativar ? 'Ativando canal...' : 'Inativando canal...');
  gasRun
    .withSuccessHandler(result => {
      hideLoading();
      if (result.success) {
        showToast(result.message, 'success');
        loadReferenceData();
      } else {
        showToast(result.message, 'error');
      }
    })
    .withFailureHandler(handleError)
    .toggleCanal(index, ativar);
}

function openConfirmCanal(msg, index) {
  canalIndexParaExcluir = index;
  const msgEl = document.getElementById('confirm-canal-message');
  if (msgEl) msgEl.textContent = msg;
  ModalManager.open('modal-confirm-canal');
}

function confirmExcluirCanal() {
  if (canalIndexParaExcluir === null) return;
  const index = canalIndexParaExcluir;
  canalIndexParaExcluir = null;
  ModalManager.close('modal-confirm-canal');
  showLoading('Excluindo...');
  gasRun
    .withSuccessHandler(result => {
      hideLoading();
      if (result.success) {
        showToast(result.message, 'success');
        loadReferenceData();
      } else {
        showToast(result.message, 'error');
      }
    })
    .withFailureHandler(handleError)
    .excluirCanal(index);
}

// ---------------------------------------------------------------------------
// Filiais
// ---------------------------------------------------------------------------
let filialIndexParaExcluir = null;

function loadFiliais() {
  const tbody = document.getElementById('table-filiais');
  if (!tbody) return;

  if (!appData.filiais || appData.filiais.length === 0) {
    tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Nenhuma filial cadastrada</td></tr>';
    return;
  }

  tbody.innerHTML = appData.filiais.map((filial, index) => `
    <tr>
      <td><strong>${escapeHtml(filial.codigo)}</strong></td>
      <td>${escapeHtml(filial.nome)}</td>
      <td>
        <span class="badge badge-${filial.ativo === false ? 'secondary' : 'success'}">
          ${filial.ativo === false ? 'Inativo' : 'Ativo'}
        </span>
      </td>
      <td class="text-right">
        <button class="btn btn-sm btn-secondary" onclick="editarFilial(${index})" title="Editar">âœŽ</button>
        <button class="btn btn-sm ${filial.ativo === false ? 'btn-success' : 'btn-warning'}" onclick="alternarFilial(${index}, ${filial.ativo === false})" title="${filial.ativo === false ? 'Ativar' : 'Inativar'}">
          ${filial.ativo === false ? 'Ativar' : 'Inativar'}
        </button>
        <button class="btn btn-sm btn-danger" onclick="excluirFilial(${index})" title="Excluir">ðŸ—‘</button>
      </td>
    </tr>
  `).join('');
}

function openModalNovaFilial() {
  document.getElementById('titulo-filial').textContent = 'Nova Filial';
  document.getElementById('filial-edit-index').value = '';
  document.getElementById('form-filial').reset();
  const ativo = document.getElementById('filial-ativo');
  if (ativo) ativo.checked = true;
  ModalManager.open('modal-filial');
}

function editarFilial(index) {
  const filial = appData.filiais[index];
  document.getElementById('titulo-filial').textContent = 'Editar Filial';
  document.getElementById('filial-edit-index').value = index;
  document.getElementById('filial-codigo').value = filial.codigo;
  document.getElementById('filial-nome').value = filial.nome;
  const ativo = document.getElementById('filial-ativo');
  if (ativo) ativo.checked = filial.ativo !== false;
  ModalManager.open('modal-filial');
}

function salvarFilial() {
  const codigo = document.getElementById('filial-codigo').value.trim().toUpperCase();
  const nome = document.getElementById('filial-nome').value.trim();
  const ativo = document.getElementById('filial-ativo').checked;
  const editIndex = document.getElementById('filial-edit-index').value;

  if (!codigo || !nome) {
    showToast('Preencha todos os campos obrigatÃ³rios', 'warning');
    return;
  }

  showLoading('Salvando filial...');
  const filial = { codigo, nome, ativo };

  gasRun
    .withSuccessHandler(result => {
      hideLoading();
      if (result.success) {
        showToast(result.message, 'success');
        ModalManager.close('modal-filial');
        loadReferenceData();
      } else {
        showToast(result.message, 'error');
      }
    })
    .withFailureHandler(handleError)
    .salvarFilial(filial, editIndex !== '' ? parseInt(editIndex) : -1);
}

function excluirFilial(index) {
  openConfirmFilial('Tem certeza que deseja excluir esta filial?', index);
}

function alternarFilial(index, ativar) {
  showLoading(ativar ? 'Ativando filial...' : 'Inativando filial...');
  gasRun
    .withSuccessHandler(result => {
      hideLoading();
      if (result.success) {
        showToast(result.message, 'success');
        loadReferenceData();
      } else {
        showToast(result.message, 'error');
      }
    })
    .withFailureHandler(handleError)
    .toggleFilial(index, ativar);
}

function openConfirmFilial(msg, index) {
  filialIndexParaExcluir = index;
  const msgEl = document.getElementById('confirm-filial-message');
  if (msgEl) msgEl.textContent = msg;
  ModalManager.open('modal-confirm-filial');
}

function confirmExcluirFilial() {
  if (filialIndexParaExcluir === null) return;
  const index = filialIndexParaExcluir;
  filialIndexParaExcluir = null;
  ModalManager.close('modal-confirm-filial');
  showLoading('Excluindo...');
  gasRun
    .withSuccessHandler(result => {
      hideLoading();
      if (result.success) {
        showToast(result.message, 'success');
        loadReferenceData();
      } else {
        showToast(result.message, 'error');
      }
    })
    .withFailureHandler(handleError)
    .excluirFilial(index);
}

// ---------------------------------------------------------------------------
// UsuÃ¡rios
// ---------------------------------------------------------------------------
let usuarioIndexParaExcluir = null;

function loadUsuarios() {
  showLoading();
  gasRun
    .withSuccessHandler(usuarios => {
      hideLoading();
      usuariosData = usuarios || [];
      renderUsuarios();
    })
    .withFailureHandler(handleError)
    .getUsuarios();
}

function renderUsuarios() {
  const tbody = document.getElementById('table-usuarios');
  if (!tbody) return;

  if (!usuariosData || usuariosData.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Nenhum usuÃ¡rio cadastrado</td></tr>';
    return;
  }

  tbody.innerHTML = usuariosData.map((user, index) => `
    <tr>
      <td>${escapeHtml(user.email)}</td>
      <td>${escapeHtml(user.nome)}</td>
      <td><span class="badge badge-${getPerfilBadge(user.perfil)}">${getPerfilLabel(user.perfil)}</span></td>
      <td><span class="badge badge-${user.status === 'ATIVO' ? 'success' : 'secondary'}">${escapeHtml(user.status)}</span></td>
      <td>${user.ultimoAcesso ? formatDate(user.ultimoAcesso) : 'Nunca'}</td>
      <td class="text-right">
        <button class="btn btn-sm btn-secondary" onclick="editarUsuario(${index})" title="Editar">âœŽ</button>
        <button class="btn btn-sm btn-danger" onclick="excluirUsuario(${index})" title="Excluir">ðŸ—‘</button>
      </td>
    </tr>
  `).join('');
}

function getPerfilBadge(perfil) {
  const badges = { 'ADMIN': 'danger', 'GESTOR': 'warning', 'OPERACIONAL': 'info', 'VISUALIZADOR': 'secondary' };
  return badges[perfil] || 'secondary';
}

function getPerfilLabel(perfil) {
  const labels = {
    'ADMIN': 'Administrador',
    'GESTOR': 'Gestor',
    'OPERACIONAL': 'Operacional',
    'VISUALIZADOR': 'Visualizador'
  };
  return labels[perfil] || perfil;
}

function openModalNovoUsuario() {
  document.getElementById('modal-usuario-title').textContent = 'Novo Usuario';
  document.getElementById('form-usuario').reset();
  document.getElementById('usuario-id').value = '';
  document.getElementById('usuario-status').value = 'ATIVO';
  const perfilSelect = document.getElementById('usuario-perfil');
  applyPermissoesFromPerfil(perfilSelect ? perfilSelect.value : 'VISUALIZADOR');
  document.getElementById('modal-usuario').style.display = 'flex';
}

function editarUsuario(index) {
  const user = usuariosData[index];
  document.getElementById('modal-usuario-title').textContent = 'Editar UsuÃ¡rio';
  document.getElementById('usuario-id').value = user.id || '';
  document.getElementById('usuario-email').value = user.email;
  document.getElementById('usuario-nome').value = user.nome;
  document.getElementById('usuario-perfil').value = user.perfil;
  document.getElementById('usuario-status').value = user.status;

  // PermissÃµes
  const perms = user.permissoes || {};
  document.getElementById('perm-criar-lancamentos').checked = !!perms.criarLancamentos;
  document.getElementById('perm-editar-lancamentos').checked = !!perms.editarLancamentos;
  document.getElementById('perm-excluir-lancamentos').checked = !!perms.excluirLancamentos;
  document.getElementById('perm-aprovar-pagamentos').checked = !!perms.aprovarPagamentos;
  document.getElementById('perm-visualizar-relatorios').checked = !!perms.visualizarRelatorios;
  document.getElementById('perm-gerenciar-config').checked = !!perms.gerenciarConfig;
  usuarioPermissoesDirty = false;

  document.getElementById('modal-usuario').style.display = 'flex';
}

function closeModalUsuario() {
  document.getElementById('modal-usuario').style.display = 'none';
}

function salvarUsuario() {
  const userData = {
    id: document.getElementById('usuario-id').value,
    email: document.getElementById('usuario-email').value,
    nome: document.getElementById('usuario-nome').value,
    perfil: document.getElementById('usuario-perfil').value,
    status: document.getElementById('usuario-status').value,
    permissoes: usuarioPermissoesDirty ? {
      criarLancamentos: document.getElementById('perm-criar-lancamentos').checked,
      editarLancamentos: document.getElementById('perm-editar-lancamentos').checked,
      excluirLancamentos: document.getElementById('perm-excluir-lancamentos').checked,
      aprovarPagamentos: document.getElementById('perm-aprovar-pagamentos').checked,
      visualizarRelatorios: document.getElementById('perm-visualizar-relatorios').checked,
      gerenciarConfig: document.getElementById('perm-gerenciar-config').checked
    } : null
  };

  showLoading();
  closeModalUsuario();

  gasRun
    .withSuccessHandler(result => {
      hideLoading();
      if (result.success) {
        showToast(result.message, 'success');
        loadUsuarios();
      } else {
        showToast(result.message, 'error');
      }
    })
    .withFailureHandler(handleError)
    .salvarUsuario(userData);
}

function excluirUsuario(index) {
  const user = usuariosData[index];
  openConfirmUsuario(`Tem certeza que deseja excluir o usuÃ¡rio ${user.nome}?`, index);
}

function openConfirmUsuario(msg, index) {
  usuarioIndexParaExcluir = index;
  const msgEl = document.getElementById('confirm-usuario-message');
  if (msgEl) msgEl.textContent = msg;
  ModalManager.open('modal-confirm-usuario');
}

function confirmExcluirUsuario() {
  if (usuarioIndexParaExcluir === null) return;
  const index = usuarioIndexParaExcluir;
  const user = usuariosData[index];
  usuarioIndexParaExcluir = null;
  ModalManager.close('modal-confirm-usuario');
  showLoading('Excluindo...');
  gasRun
    .withSuccessHandler(result => {
      hideLoading();
      if (result.success) {
        showToast(result.message, 'success');
        loadUsuarios();
      } else {
        showToast(result.message, 'error');
      }
    })
    .withFailureHandler(handleError)
    .excluirUsuario(user.id || user.email);
}

document.addEventListener('DOMContentLoaded', function() {
  initUsuarioPermissoesListeners();
  const form = document.getElementById('form-usuario');
  if (form) {
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      salvarUsuario();
    });
  }

  document.addEventListener('click', function(e) {
    const target = e.target;
    if (target && target.classList && target.classList.contains('modal-overlay')) {
      ModalManager.closeAll();
    }
  });
});
</script>
