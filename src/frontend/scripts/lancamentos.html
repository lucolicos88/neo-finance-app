<script>
// ============================================================================
// LANCAMENTOS - CRUD Operations
// ============================================================================

let saveAndNew = false;
const gasRun = (window && window.gasRun) ? window.gasRun : google.script.run;

// Open modal
function openNovaContaPagar() {
  if (!currentUserInfo?.permissoes?.criarLancamentos) {
    showToast('Sem permissão para criar lançamentos', 'error');
    return;
  }
  setLancamentoModalMode('new');
  clearEditIds();
  populateFormFiliais();
  populateFormCentrosCusto();
  populateFormContas();
  switchTab('tipo-lancamento', 'pagar');
  resetForm('form-novo-pagar');
  setDefaultDates('pagar');
  ModalManager.open('modal-novo-lancamento');
}

function openNovaContaReceber() {
  if (!currentUserInfo?.permissoes?.criarLancamentos) {
    showToast('Sem permissão para criar lançamentos', 'error');
    return;
  }
  setLancamentoModalMode('new');
  clearEditIds();
  populateFormFiliais();
  populateFormCanais();
  populateFormContas();
  switchTab('tipo-lancamento', 'receber');
  resetForm('form-novo-receber');
  setDefaultDates('receber');
  ModalManager.open('modal-novo-lancamento');
}

// Reset form
function resetForm(formId) {
  const form = document.getElementById(formId);
  if (form) {
    form.reset();
    // Clear errors
    form.querySelectorAll('.error').forEach(el => el.classList.remove('error'));
    form.querySelectorAll('.form-error').forEach(el => el.classList.remove('show'));
  }

  // Reset valor líquido
  if (formId.includes('pagar')) {
    document.getElementById('pagar-valor-liquido').textContent = 'R$ 0,00';
  } else {
    document.getElementById('receber-valor-liquido').textContent = 'R$ 0,00';
  }
}

function clearEditIds() {
  const pagarEditId = document.getElementById('pagar-edit-id');
  const receberEditId = document.getElementById('receber-edit-id');
  if (pagarEditId) pagarEditId.value = '';
  if (receberEditId) receberEditId.value = '';
}

function setLancamentoModalMode(mode) {
  const title = document.getElementById('modal-lancamento-title');
  const btnSalvarNovo = document.getElementById('btn-salvar-novo');
  if (mode === 'edit') {
    if (title) title.textContent = 'Editar Lancamento';
    if (btnSalvarNovo) btnSalvarNovo.style.display = 'none';
  } else {
    if (title) title.textContent = 'Novo Lancamento';
    if (btnSalvarNovo) btnSalvarNovo.style.display = '';
  }
}

// Set default dates
function setDefaultDates(tipo) {
  const hoje = new Date().toISOString().split('T')[0];
  document.getElementById(`${tipo}-data-competencia`).value = hoje;
  document.getElementById(`${tipo}-data-vencimento`).value = hoje;
}

// Populate filiais
function populateFormFiliais() {
  if (!appData.filiais || appData.filiais.length === 0) return;

  ['pagar-filial', 'receber-filial'].forEach(id => {
    const select = document.getElementById(id);
    if (select && select.options.length <= 1) {
      appData.filiais.forEach(filial => {
        const option = document.createElement('option');
        option.value = filial.codigo;
        option.textContent = filial.nome;
        select.appendChild(option);
      });
    }
  });
}

// Populate canais
function populateFormCanais() {
  if (!appData.canais || appData.canais.length === 0) {
    console.warn('Nenhum canal disponível');
    return;
  }

  const select = document.getElementById('receber-canal');
  if (select && select.options.length <= 1) {
    appData.canais.forEach(canal => {
      const option = document.createElement('option');
      option.value = canal.codigo;
      option.textContent = canal.nome;
      select.appendChild(option);
    });
  }
}

// Populate centros de custo
function populateFormCentrosCusto() {
  if (!appData.centrosCusto || appData.centrosCusto.length === 0) {
    console.warn('Nenhum centro de custo disponível');
    return;
  }

  const select = document.getElementById('pagar-centro-custo');
  if (select && select.options.length <= 1) {
    appData.centrosCusto.forEach(cc => {
      const option = document.createElement('option');
      option.value = cc.codigo;
      option.textContent = cc.nome;
      select.appendChild(option);
    });
  }
}

// Populate contas contábeis
function populateFormContas() {
  if (!appData.contas || appData.contas.length === 0) {
    console.warn('Nenhuma conta contábil disponível');
    return;
  }

  ['pagar-conta-contabil', 'receber-conta-contabil'].forEach(id => {
    const select = document.getElementById(id);
    if (select && select.options.length <= 1) {
      appData.contas.forEach(conta => {
        const option = document.createElement('option');
        option.value = conta.codigo;
        option.textContent = `${conta.codigo} - ${conta.nome}`;
        select.appendChild(option);
      });
    }
  });
}

// Validation rules
const validationRulesPagar = {
  'pagar-data-competencia': { required: true, requiredMessage: 'Data de competência é obrigatória' },
  'pagar-data-vencimento': { required: true, requiredMessage: 'Data de vencimento é obrigatória' },
  'pagar-descricao': {
    required: true,
    minLength: 5,
    requiredMessage: 'Descrição é obrigatória',
    patternMessage: 'Mínimo 5 caracteres'
  },
  'pagar-valor': {
    required: true,
    min: 0.01,
    requiredMessage: 'Valor é obrigatório',
    patternMessage: 'Valor deve ser maior que zero'
  },
  'pagar-filial': { required: true, requiredMessage: 'Selecione uma filial' },
  'pagar-centro-custo': { required: true, requiredMessage: 'Selecione um centro de custo' },
  'pagar-conta-contabil': { required: true, requiredMessage: 'Selecione uma conta contábil' }
};

const validationRulesReceber = {
  'receber-data-competencia': { required: true, requiredMessage: 'Data de competência é obrigatória' },
  'receber-data-vencimento': { required: true, requiredMessage: 'Data de vencimento é obrigatória' },
  'receber-descricao': {
    required: true,
    minLength: 5,
    requiredMessage: 'Descrição é obrigatória',
    patternMessage: 'Mínimo 5 caracteres'
  },
  'receber-valor': {
    required: true,
    min: 0.01,
    requiredMessage: 'Valor é obrigatório',
    patternMessage: 'Valor deve ser maior que zero'
  },
  'receber-filial': { required: true, requiredMessage: 'Selecione uma filial' },
  'receber-canal': { required: true, requiredMessage: 'Selecione um canal' },
  'receber-conta-contabil': { required: true, requiredMessage: 'Selecione uma conta contábil' }
};

// Save functions
function salvarENovoLancamento() {
  saveAndNew = true;
  salvarLancamento();
}

function salvarLancamento() {
  const activeTab = document.querySelector('[data-tab-group="tipo-lancamento"].active');
  const tipo = activeTab ? activeTab.getAttribute('data-tab') : 'pagar';

  if (tipo === 'pagar') {
    salvarContaPagar();
  } else {
    salvarContaReceber();
  }
}

function salvarContaPagar() {
  const editId = document.getElementById('pagar-edit-id')?.value || '';
  const isEdit = Boolean(editId);
  if (isEdit && !currentUserInfo?.permissoes?.editarLancamentos) {
    showToast('Sem permissão para editar lançamentos', 'error');
    return;
  }
  if (!isEdit && !currentUserInfo?.permissoes?.criarLancamentos) {
    showToast('Sem permissão para criar lançamentos', 'error');
    return;
  }
  // Validate
  if (!validateForm('form-novo-pagar', validationRulesPagar)) {
    showToast('Por favor, corrija os erros no formulário', 'warning');
    return;
  }

  // Collect data
  const valor = parseFloat(document.getElementById('pagar-valor').value);
  const desconto = parseFloat(document.getElementById('pagar-desconto').value || 0);
  const juros = parseFloat(document.getElementById('pagar-juros').value || 0);
  const multa = parseFloat(document.getElementById('pagar-multa').value || 0);
  const valorLiquido = valor - desconto + juros + multa;

  const lancamento = {
    id: editId || generateId(),
    dataCompetencia: document.getElementById('pagar-data-competencia').value,
    dataVencimento: document.getElementById('pagar-data-vencimento').value,
    dataPagamento: '',
    tipo: 'DESPESA',
    filial: document.getElementById('pagar-filial').value,
    centroCusto: document.getElementById('pagar-centro-custo').value,
    contaGerencial: document.getElementById('pagar-centro-custo').options[document.getElementById('pagar-centro-custo').selectedIndex].text,
    contaContabil: document.getElementById('pagar-conta-contabil').value,
    grupoReceita: '',
    canal: '',
    descricao: document.getElementById('pagar-descricao').value,
    valorBruto: valor,
    desconto: desconto,
    juros: juros,
    multa: multa,
    valorLiquido: valorLiquido,
    status: 'PENDENTE',
    idExtratoBanco: '',
    origem: 'WEB_APP',
    observacoes: document.getElementById('pagar-observacoes').value
  };

  // Show loading
  showLoading('Salvando lançamento...');

  // Call backend
  const action = isEdit ? 'atualizarLancamento' : 'salvarLancamento';
  gasRun
    .withSuccessHandler(function(result) {
      hideLoading();
      if (result.success) {
        showToast(isEdit ? 'Conta a pagar atualizada com sucesso!' : 'Conta a pagar salva com sucesso!', 'success');

        if (!isEdit && saveAndNew) {
          resetForm('form-novo-pagar');
          setDefaultDates('pagar');
          saveAndNew = false;
        } else {
          ModalManager.close('modal-novo-lancamento');
        }
        clearEditIds();
        setLancamentoModalMode('new');

        // Reload current view
        if (currentView === 'contas-pagar') {
          loadContasPagarData();
        } else if (currentView === 'dashboard') {
          loadDashboardData();
        }
      } else {
        showToast(result.message || 'Erro ao salvar', 'error');
      }
    })
    .withFailureHandler(function(error) {
      hideLoading();
      handleError(error);
    })
    [action](lancamento);
}

function salvarContaReceber() {
  const editId = document.getElementById('receber-edit-id')?.value || '';
  const isEdit = Boolean(editId);
  if (isEdit && !currentUserInfo?.permissoes?.editarLancamentos) {
    showToast('Sem permissão para editar lançamentos', 'error');
    return;
  }
  if (!isEdit && !currentUserInfo?.permissoes?.criarLancamentos) {
    showToast('Sem permissão para criar lançamentos', 'error');
    return;
  }
  // Validate
  if (!validateForm('form-novo-receber', validationRulesReceber)) {
    showToast('Por favor, corrija os erros no formulário', 'warning');
    return;
  }

  // Collect data
  const valor = parseFloat(document.getElementById('receber-valor').value);
  const desconto = parseFloat(document.getElementById('receber-desconto').value || 0);
  const juros = parseFloat(document.getElementById('receber-juros').value || 0);
  const multa = parseFloat(document.getElementById('receber-multa').value || 0);
  const valorLiquido = valor - desconto + juros + multa;

  const lancamento = {
    id: editId || generateId(),
    dataCompetencia: document.getElementById('receber-data-competencia').value,
    dataVencimento: document.getElementById('receber-data-vencimento').value,
    dataPagamento: '',
    tipo: 'RECEITA',
    filial: document.getElementById('receber-filial').value,
    centroCusto: 'COM',
    contaGerencial: 'Receita',
    contaContabil: document.getElementById('receber-conta-contabil').value,
    grupoReceita: 'Serviços',
    canal: document.getElementById('receber-canal').value,
    descricao: document.getElementById('receber-descricao').value,
    valorBruto: valor,
    desconto: desconto,
    juros: juros,
    multa: multa,
    valorLiquido: valorLiquido,
    status: 'PENDENTE',
    idExtratoBanco: '',
    origem: 'WEB_APP',
    observacoes: document.getElementById('receber-observacoes').value
  };

  // Show loading
  showLoading('Salvando lançamento...');

  // Call backend
  const action = isEdit ? 'atualizarLancamento' : 'salvarLancamento';
  gasRun
    .withSuccessHandler(function(result) {
      hideLoading();
      if (result.success) {
        showToast(isEdit ? 'Conta a receber atualizada com sucesso!' : 'Conta a receber salva com sucesso!', 'success');

        if (!isEdit && saveAndNew) {
          resetForm('form-novo-receber');
          setDefaultDates('receber');
          saveAndNew = false;
        } else {
          ModalManager.close('modal-novo-lancamento');
        }
        clearEditIds();
        setLancamentoModalMode('new');

        // Reload current view
        if (currentView === 'contas-receber') {
          loadContasReceberData();
        } else if (currentView === 'dashboard') {
          loadDashboardData();
        }
      } else {
        showToast(result.message || 'Erro ao salvar', 'error');
      }
    })
    .withFailureHandler(function(error) {
      hideLoading();
      handleError(error);
    })
    [action](lancamento);
}

// Generate unique ID
function generateId() {
  const timestamp = Date.now();
  const random = Math.floor(Math.random() * 1000);
  return `WEB${timestamp}${random}`;
}

// Edit functions
function editContaPagar(id) {
  if (!currentUserInfo?.permissoes?.editarLancamentos) {
    showToast('Sem permissão para editar lançamentos', 'error');
    return;
  }
  showLoading();
  gasRun
    .withSuccessHandler(function(data) {
      hideLoading();
      if (!data) {
        showToast('Lançamento não encontrado', 'error');
        return;
      }
      if (String(data.tipo || '').toUpperCase() !== 'DESPESA') {
        showToast('Tipo inválido para contas a pagar', 'error');
        return;
      }
      const status = String(data.status || '').toUpperCase();
      if (status !== 'PENDENTE' && status !== 'VENCIDA') {
        showToast(`Não é possível editar (status: ${status || 'N/A'})`, 'warning');
        return;
      }
      setLancamentoModalMode('edit');
      populateFormFiliais();
      populateFormCentrosCusto();
      populateFormContas();
      switchTab('tipo-lancamento', 'pagar');
      resetForm('form-novo-pagar');
      preencherFormPagar(data);
      ModalManager.open('modal-novo-lancamento');
    })
    .withFailureHandler(handleError)
    .getLancamentoDetalhes(id);
}

function editContaReceber(id) {
  if (!currentUserInfo?.permissoes?.editarLancamentos) {
    showToast('Sem permissão para editar lançamentos', 'error');
    return;
  }
  showLoading();
  gasRun
    .withSuccessHandler(function(data) {
      hideLoading();
      if (!data) {
        showToast('Lançamento não encontrado', 'error');
        return;
      }
      if (String(data.tipo || '').toUpperCase() !== 'RECEITA') {
        showToast('Tipo inválido para contas a receber', 'error');
        return;
      }
      const status = String(data.status || '').toUpperCase();
      if (status !== 'PENDENTE' && status !== 'VENCIDA') {
        showToast(`Não é possível editar (status: ${status || 'N/A'})`, 'warning');
        return;
      }
      setLancamentoModalMode('edit');
      populateFormFiliais();
      populateFormCanais();
      populateFormContas();
      switchTab('tipo-lancamento', 'receber');
      resetForm('form-novo-receber');
      preencherFormReceber(data);
      ModalManager.open('modal-novo-lancamento');
    })
    .withFailureHandler(handleError)
    .getLancamentoDetalhes(id);
}

function setSelectValue(selectId, value, label) {
  const select = document.getElementById(selectId);
  if (!select) return;
  const targetValue = String(value || '');
  if (!targetValue) return;
  const exists = Array.from(select.options).some(opt => opt.value === targetValue);
  if (!exists) {
    const option = document.createElement('option');
    option.value = targetValue;
    option.textContent = label || targetValue;
    select.appendChild(option);
  }
  select.value = targetValue;
}

function preencherFormPagar(data) {
  document.getElementById('pagar-edit-id').value = String(data.id || '');
  document.getElementById('pagar-data-competencia').value = String(data.dataCompetencia || '').slice(0, 10);
  document.getElementById('pagar-data-vencimento').value = String(data.dataVencimento || '').slice(0, 10);
  document.getElementById('pagar-descricao').value = String(data.descricao || '');
  document.getElementById('pagar-valor').value = String(data.valorBruto || 0);
  document.getElementById('pagar-desconto').value = String(data.desconto || 0);
  document.getElementById('pagar-juros').value = String(data.juros || 0);
  document.getElementById('pagar-multa').value = String(data.multa || 0);
  setSelectValue('pagar-filial', data.filial, data.filial);
  setSelectValue('pagar-centro-custo', data.centroCusto, data.centroCusto);
  setSelectValue('pagar-conta-contabil', data.contaContabil, data.contaContabil);
  document.getElementById('pagar-observacoes').value = String(data.observacoes || '');
  calcularValorLiquidoPagar();
}

function preencherFormReceber(data) {
  document.getElementById('receber-edit-id').value = String(data.id || '');
  document.getElementById('receber-data-competencia').value = String(data.dataCompetencia || '').slice(0, 10);
  document.getElementById('receber-data-vencimento').value = String(data.dataVencimento || '').slice(0, 10);
  document.getElementById('receber-descricao').value = String(data.descricao || '');
  document.getElementById('receber-valor').value = String(data.valorBruto || 0);
  document.getElementById('receber-desconto').value = String(data.desconto || 0);
  document.getElementById('receber-juros').value = String(data.juros || 0);
  document.getElementById('receber-multa').value = String(data.multa || 0);
  setSelectValue('receber-filial', data.filial, data.filial);
  setSelectValue('receber-canal', data.canal, data.canal);
  setSelectValue('receber-conta-contabil', data.contaContabil, data.contaContabil);
  document.getElementById('receber-observacoes').value = String(data.observacoes || '');
  calcularValorLiquidoReceber();
}

// Export functions
function exportContasPagar() {
  const rows = [
    ['ID', 'Vencimento', 'Fornecedor', 'Descricao', 'Valor', 'Status', 'Filial'],
  ];
  (appData.contasPagar || []).forEach(c => {
    rows.push([
      c.id,
      c.vencimento,
      c.fornecedor,
      c.descricao,
      String(c.valor || 0),
      c.status,
      c.filial,
    ]);
  });
  downloadCsv('contas_pagar', rows);
}

function exportContasReceber() {
  const rows = [
    ['ID', 'Vencimento', 'Cliente', 'Descricao', 'Valor', 'Status', 'Canal'],
  ];
  (appData.contasReceber || []).forEach(c => {
    rows.push([
      c.id,
      c.vencimento,
      c.cliente,
      c.descricao,
      String(c.valor || 0),
      c.status,
      c.canal,
    ]);
  });
  downloadCsv('contas_receber', rows);
}

function downloadCsv(prefix, rows) {
  if (!rows || rows.length <= 1) {
    showToast('Sem dados para exportar', 'warning');
    return;
  }
  const escapeCell = (value) => {
    const v = String(value ?? '');
    if (/[\";\n\r]/.test(v)) {
      return '"' + v.replace(/"/g, '""') + '"';
    }
    return v;
  };
  const csv = rows.map(r => r.map(escapeCell).join(';')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  const date = new Date().toISOString().slice(0, 10);
  a.href = url;
  a.download = `${prefix}_${date}.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}
</script>
