<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fluxo de Caixa</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="p-3">
  <div class="container">
    <h3>Fluxo de Caixa</h3>
    <form id="filtroForm" class="row g-2 mb-3">
      <div class="col-md-3">
        <label class="form-label">Data Inicio</label>
        <input type="date" name="dataInicio" class="form-control">
      </div>
      <div class="col-md-3">
        <label class="form-label">Data Fim</label>
        <input type="date" name="dataFim" class="form-control">
      </div>
      <div class="col-md-3">
        <label class="form-label">Filial</label>
        <input name="filial" class="form-control">
      </div>
      <div class="col-md-2 d-flex align-items-end">
        <button class="btn btn-secondary w-100" type="submit">Buscar</button>
      </div>
    </form>

    <div class="row g-2 mb-3">
      <div class="col-md-3"><div class="card"><div class="card-body"><div class="text-muted">Saldo Inicial</div><div id="saldoInicial" class="fw-bold fs-5">0</div></div></div></div>
      <div class="col-md-3"><div class="card"><div class="card-body"><div class="text-muted">Entradas</div><div id="entradas" class="fw-bold fs-5">0</div></div></div></div>
      <div class="col-md-3"><div class="card"><div class="card-body"><div class="text-muted">Saidas</div><div id="saidas" class="fw-bold fs-5">0</div></div></div></div>
      <div class="col-md-3"><div class="card"><div class="card-body"><div class="text-muted">Saldo Final</div><div id="saldoFinal" class="fw-bold fs-5">0</div></div></div></div>
    </div>

    <canvas id="saldoChart" height="120"></canvas>

    <div class="table-responsive mt-3">
      <table class="table table-striped">
        <thead><tr><th>Data</th><th>Entradas</th><th>Saidas</th><th>Saldo</th></tr></thead>
        <tbody id="fluxoTableBody"></tbody>
      </table>
    </div>
  </div>

  <script>
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxJB-tyl6EtDEWiJFAZaszhCwRTUsE6XTs1M4rV8CdeK86o2iRdf5HW8001BokutJTWFg/exec';
    const AUTH_TOKEN = 'sr2alk724hL3fSDx/TQBELrC66bXYv2yRInXxeTDAPY=';

    async function callApi(path, payload) {
      const res = await fetch(`${WEB_APP_URL}?path=${encodeURIComponent(path)}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-Auth-Token': AUTH_TOKEN },
        body: JSON.stringify(payload || {})
      });
      return res.json();
    }

    const cashflowApi = {
      async getRealizado(filtros) { return callApi('/cashflow/realizado', filtros); }
    };

    const filtroForm = document.getElementById('filtroForm');
    const saldoInicialEl = document.getElementById('saldoInicial');
    const entradasEl = document.getElementById('entradas');
    const saidasEl = document.getElementById('saidas');
    const saldoFinalEl = document.getElementById('saldoFinal');
    const fluxoTableBody = document.getElementById('fluxoTableBody');
    const chartCtx = document.getElementById('saldoChart').getContext('2d');
    let saldoChart;

    filtroForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const filtros = Object.fromEntries(new FormData(filtroForm).entries());
      const data = await cashflowApi.getRealizado(filtros);
      renderResumo(data);
      renderTabela(data.dias || []);
      renderChart(data.dias || []);
    });

    function renderResumo(data) {
      saldoInicialEl.textContent = (data.saldoInicial || 0).toFixed(2);
      entradasEl.textContent = (data.totalEntradas || 0).toFixed(2);
      saidasEl.textContent = (data.totalSaidas || 0).toFixed(2);
      saldoFinalEl.textContent = (data.saldoFinal || 0).toFixed(2);
    }

    function renderTabela(dias) {
      fluxoTableBody.innerHTML = '';
      dias.forEach(d => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${formatDate(d.data)}</td><td>${(d.entradas || 0).toFixed(2)}</td><td>${(d.saidas || 0).toFixed(2)}</td><td>${(d.saldo || d.saldoFinal || 0).toFixed(2)}</td>`;
        fluxoTableBody.appendChild(tr);
      });
    }

    function renderChart(dias) {
      const labels = dias.map(d => formatDate(d.data));
      const data = dias.map(d => d.saldo || d.saldoFinal || 0);
      if (saldoChart) saldoChart.destroy();
      saldoChart = new Chart(chartCtx, {
        type: 'line',
        data: { labels, datasets: [{ label: 'Saldo', data, borderColor: '#0d6efd', fill: false }] },
        options: { responsive: true }
      });
    }

    function formatDate(d) {
      if (!d) return '';
      const date = new Date(d);
      return date.toLocaleDateString();
    }

    filtroForm.dispatchEvent(new Event('submit'));
  </script>
</body>
</html>
